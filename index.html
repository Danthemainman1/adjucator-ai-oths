<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adjudicator AI</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Configuration for Dark Mode -->
    <script>
        tailwind.config = {
            darkMode: 'class', // or 'media'
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>

    <!-- React & ReactDOM via ESM -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "recharts": "https://esm.sh/recharts@2.12.0"
      }
    }
    </script>
    
    <!-- Babel for JSX translation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDKs (Modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, sendEmailVerification } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- PASTE YOUR FIREBASE CONFIG HERE ---
        const firebaseConfig = {
            apiKey: "AIzaSyAgGkHhRcdGatNvRsm5BQv_RerjG8qt70M",
            authDomain: "adjucator-ai.firebaseapp.com",
            projectId: "adjucator-ai",
            storageBucket: "adjucator-ai.firebasestorage.app",
            messagingSenderId: "82725691768",
            appId: "1:82725691768:web:6186a5b41b8a0aa1e7688d",
            measurementId: "G-N92VEHSKDE"
        };
        // ---------------------------------------

        const app = initializeApp(firebaseConfig);
        window.auth = getAuth(app);
        window.db = getFirestore(app);
        window.googleProvider = new GoogleAuthProvider();
        window.firebaseAuth = { createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInWithPopup, sendEmailVerification };
        window.firebaseDb = { doc, setDoc, getDoc, updateDoc, arrayUnion };
    </script>

    <style>
        /* --- COMMAND CENTER THEME --- */
        body { 
            background-color: #020617 !important; /* slate-950 */
            color: #cbd5e1 !important; /* slate-300 */
            font-family: 'Inter', sans-serif;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 0; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Typography Overrides */
        .font-mono { font-family: 'JetBrains Mono', 'Fira Code', monospace; }
        
        /* Utility Overrides for "HUD" Look */
        .hud-border { border: 1px solid #1e293b; } /* slate-800 */
        .hud-bg { background-color: #020617; }
        .hud-panel { background-color: #0f172a; border: 1px solid #1e293b; }
        
        /* Remove all shadows, replace with borders */
        .shadow-sm, .shadow-md, .shadow-lg, .shadow-xl, .shadow-2xl {
            box-shadow: none !important;
            border: 1px solid #1e293b !important;
        }

        /* Inputs */
        input, select, textarea {
            background-color: #000000 !important;
            border: 1px solid #1e293b !important;
            color: #4ade80 !important; /* green-400 */
            font-family: monospace !important;
        }
        input::placeholder, textarea::placeholder { color: #334155 !important; }
        input:focus, select:focus, textarea:focus {
            outline: none !important;
            border-color: #06b6d4 !important; /* cyan-500 */
            box-shadow: 0 0 0 1px #06b6d4 !important;
        }

        /* Buttons */
        button {
            border-radius: 2px !important; /* Sharp/Slightly rounded */
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-100">
    
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useRef, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Radar, RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, ResponsiveContainer } from 'recharts';
        import { 
            Gavel, 
            Mic, 
            Settings, 
            AlertCircle, 
            CheckCircle2, 
            ChevronDown, 
            Send, 
            Loader2, 
            Award, 
            BookOpen, 
            Layout, 
            Image as ImageIcon, 
            Upload, 
            X, 
            Plus, 
            Square, 
            Activity,
            HelpCircle,
            Palette,
            Lightbulb,
            Moon,
            Sun,
            Coffee,
            Leaf,
            History,
            Trash2,
            Download,
            Copy,
            LogOut,
            User,
            Lock,
            Menu,
            Droplets,
            CloudSun,
            Star,
            Mail,
            Zap,
            ArrowRight,
            Globe,
            RefreshCw
        } from 'lucide-react';

        // --- Components ---

        const ExtempQuestionGenerator = ({ provider: defaultProvider, apiKey, openaiKey }) => {
            const [category, setCategory] = useState('DX'); // DX or NX
            const [difficulty, setDifficulty] = useState('Medium'); // Easy, Medium, Hard
            const [question, setQuestion] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [localProvider, setLocalProvider] = useState(defaultProvider || 'gemini');

            // Update local provider if default changes (optional, but good for sync)
            useEffect(() => {
                if (defaultProvider) setLocalProvider(defaultProvider);
            }, [defaultProvider]);

            const generateQuestion = async () => {
                setLoading(true);
                setQuestion('');
                setError('');

                const currentKey = localProvider === 'gemini' ? apiKey : openaiKey;
                if (!currentKey) {
                    setError(`Please enter a valid ${localProvider === 'gemini' ? 'Gemini' : 'OpenAI'} API Key in Settings.`);
                    setLoading(false);
                    return;
                }

                try {
                    let generatedText = '';
                    const prompt = `Generate a single ${difficulty} difficulty Extemporaneous Speaking question for the category ${category === 'DX' ? 'United States Domestic Extemp (DX)' : 'International Extemp (NX)'}. The question should be current, relevant to 2024-2025 events, and formatted as a question. Do not include any other text.`;

                    if (localProvider === 'gemini') {
                        // Try Primary Model (Gemini 2.0 Flash Exp), then Fallback (Gemini 1.5 Flash)
                        const modelsToTry = ['gemini-2.0-flash-exp', 'gemini-1.5-flash'];
                        
                        for (const model of modelsToTry) {
                            try {
                                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                                });

                                if (!response.ok) {
                                    const errorData = await response.json().catch(() => ({}));
                                    // If it's the last model, throw the error
                                    if (model === modelsToTry[modelsToTry.length - 1]) {
                                        throw new Error(`Gemini API Error: ${errorData.error?.message || response.statusText}`);
                                    }
                                    continue; // Try next model
                                }

                                const data = await response.json();
                                generatedText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                                break; // Success
                            } catch (e) {
                                if (model === modelsToTry[modelsToTry.length - 1]) throw e;
                            }
                        }
                    } else {
                        const response = await fetch('https://api.openai.com/v1/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${openaiKey}`
                            },
                            body: JSON.stringify({
                                model: "gpt-4o",
                                messages: [{ role: "user", content: prompt }]
                            })
                        });

                        if (!response.ok) {
                            const errData = await response.json();
                            throw new Error(`OpenAI API Error: ${errData.error?.message || response.statusText}`);
                        }
                        const data = await response.json();
                        generatedText = data.choices[0].message.content;
                    }
                    
                    setQuestion(generatedText.trim().replace(/^"|"$/g, ''));
                    
                } catch (e) {
                    console.error(e);
                    setError(e.message || "Error generating question.");
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6 mb-6">
                    <h3 className="text-lg font-semibold mb-4 flex items-center justify-between">
                        <div className="flex items-center">
                            <HelpCircle className="w-5 h-5 mr-2 text-indigo-600" />
                            Extemp Question Generator
                        </div>
                        <div className="flex bg-slate-100 dark:bg-slate-700 rounded-lg p-1">
                            <button 
                                onClick={() => setLocalProvider('gemini')}
                                className={`px-3 py-1 text-xs font-medium rounded-md transition-all ${localProvider === 'gemini' ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-indigo-400' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700'}`}
                            >
                                Gemini
                            </button>
                            <button 
                                onClick={() => setLocalProvider('openai')}
                                className={`px-3 py-1 text-xs font-medium rounded-md transition-all ${localProvider === 'openai' ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-indigo-400' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700'}`}
                            >
                                OpenAI
                            </button>
                        </div>
                    </h3>
                    <div className="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Category</label>
                            <div className="flex space-x-2">
                                <button onClick={() => setCategory('DX')} className={`flex-1 py-2 rounded-lg text-sm font-medium transition-colors ${category === 'DX' ? 'bg-indigo-600 text-white' : 'bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300'}`}>DX (Domestic)</button>
                                <button onClick={() => setCategory('NX')} className={`flex-1 py-2 rounded-lg text-sm font-medium transition-colors ${category === 'NX' ? 'bg-indigo-600 text-white' : 'bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300'}`}>NX (International)</button>
                            </div>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Difficulty</label>
                            <select value={difficulty} onChange={(e) => setDifficulty(e.target.value)} className="w-full p-2 rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 focus:ring-2 focus:ring-indigo-500 outline-none">
                                <option>Easy</option>
                                <option>Medium</option>
                                <option>Hard</option>
                            </select>
                        </div>
                    </div>
                    <button 
                        onClick={generateQuestion} 
                        disabled={loading}
                        className="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium transition-all flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        {loading ? <Loader2 className="w-5 h-5 animate-spin" /> : 'Generate Question'}
                    </button>
                    {error && (
                        <div className="mt-4 p-3 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 text-sm rounded-lg border border-red-100 dark:border-red-800">
                            {error}
                        </div>
                    )}
                    {question && (
                        <div className="mt-6 p-4 bg-slate-50 dark:bg-slate-900/50 rounded-lg border border-slate-200 dark:border-slate-700 animate-in fade-in slide-in-from-bottom-2">
                            <p className="text-lg font-medium text-center text-slate-800 dark:text-slate-200">"{question}"</p>
                        </div>
                    )}
                </div>
            );
        };

        const MarkdownRenderer = ({ content }) => {
            if (!content) return null;

            const parseInline = (text) => {
                const parts = text.split(/(\*\*.*?\*\*)/g);
                return parts.map((part, index) => {
                    if (part.startsWith('**') && part.endsWith('**')) {
                        return <strong key={index} className="font-bold text-slate-900 dark:text-slate-100">{part.slice(2, -2)}</strong>;
                    }
                    return part;
                });
            };
            
            const lines = content.split('\n');
            
            return (
                <div className="font-serif text-lg leading-loose text-slate-800 dark:text-slate-300 max-w-none">
                {lines.map((line, i) => {
                    if (line.startsWith('#### ')) {
                        return <h4 key={i} className="text-lg font-bold text-slate-900 dark:text-slate-100 mt-6 mb-2 uppercase tracking-wide text-sm font-sans">{parseInline(line.replace('#### ', ''))}</h4>;
                    }
                    if (line.startsWith('### ')) {
                        return <h3 key={i} className="text-xl font-bold text-slate-900 dark:text-slate-100 mt-8 mb-3 font-sans">{parseInline(line.replace('### ', ''))}</h3>;
                    }
                    if (line.startsWith('## ')) {
                        return <h2 key={i} className="text-2xl font-bold text-slate-900 dark:text-slate-100 mt-10 mb-4 border-b-2 border-slate-100 dark:border-slate-800 pb-2 font-sans">{parseInline(line.replace('## ', ''))}</h2>;
                    }
                    if (line.trim().startsWith('* ') || line.trim().startsWith('- ')) {
                        return (
                            <div key={i} className="flex items-start space-x-3 ml-4 mb-2">
                                <span className="text-slate-400 mt-2.5 text-xs">•</span>
                                <span>{parseInline(line.replace(/^[\*\-]\s/, ''))}</span>
                            </div>
                        );
                    }
                    if (line.trim() === '') return <div key={i} className="h-4"></div>;
                    
                    return <p key={i} className="mb-2">{parseInline(line)}</p>;
                })}
                </div>
            );
        };

        const speechTimes = {
            'Public Forum (PF)': [
                { name: 'Constructive', time: 240 },
                { name: 'Rebuttal', time: 240 },
                { name: 'Summary', time: 180 },
                { name: 'Final Focus', time: 120 },
                { name: 'Crossfire', time: 180 }
            ],
            'Lincoln-Douglas (LD)': [
                { name: 'Aff Constructive (AC)', time: 360 },
                { name: 'Neg Constructive (NC)', time: 420 },
                { name: '1st Aff Rebuttal (1AR)', time: 240 },
                { name: 'Neg Rebuttal (NR)', time: 360 },
                { name: '2nd Aff Rebuttal (2AR)', time: 180 }
            ],
            'Policy Debate (CX)': [
                { name: 'Constructive', time: 480 },
                { name: 'Cross-Ex', time: 180 }
            ],
            'World Schools Debate': [
                { name: 'Main Speech', time: 480 },
                { name: 'Reply Speech', time: 240 }
            ],
            'Congressional Debate': [
                { name: 'Sponsorship/Auth', time: 180 },
                { name: 'Questioning', time: 120 }
            ],
            'Big Questions Debate': [
                { name: 'Constructive', time: 300 },
                { name: 'Rebuttal', time: 180 },
                { name: 'Consolidation', time: 180 },
                { name: 'Rationale', time: 180 }
            ],
            'United States Extemp (USX)': [
                { name: 'AGD', time: 45 },
                { name: 'Background', time: 45 },
                { name: 'Umbrella/Sig', time: 30 },
                { name: 'Point 1', time: 90 },
                { name: 'Point 2', time: 90 },
                { name: 'Point 3', time: 90 },
                { name: 'Conclusion', time: 30 }
            ],
            'International Extemp (IX)': [
                { name: 'AGD', time: 45 },
                { name: 'Background', time: 45 },
                { name: 'Umbrella/Sig', time: 30 },
                { name: 'Point 1', time: 90 },
                { name: 'Point 2', time: 90 },
                { name: 'Point 3', time: 90 },
                { name: 'Conclusion', time: 30 }
            ],
            'Original Oratory (OO)': [
                { name: 'Intro', time: 90 },
                { name: 'Body 1', time: 150 },
                { name: 'Body 2', time: 150 },
                { name: 'Body 3', time: 150 },
                { name: 'Conclusion', time: 60 }
            ],
            'Informative Speaking (INFO)': [
                { name: 'Intro', time: 90 },
                { name: 'Body 1', time: 150 },
                { name: 'Body 2', time: 150 },
                { name: 'Body 3', time: 150 },
                { name: 'Conclusion', time: 60 }
            ],
            'Dramatic Interpretation (DI)': [
                { name: 'Teaser', time: 90 },
                { name: 'Intro', time: 45 },
                { name: 'Performance', time: 465 }
            ],
            'Humorous Interpretation (HI)': [
                { name: 'Teaser', time: 90 },
                { name: 'Intro', time: 45 },
                { name: 'Performance', time: 465 }
            ],
            'Duo Interpretation': [
                { name: 'Teaser', time: 90 },
                { name: 'Intro', time: 45 },
                { name: 'Performance', time: 465 }
            ],
            'Program Oral Interpretation (POI)': [
                { name: 'Teaser', time: 90 },
                { name: 'Intro', time: 45 },
                { name: 'Performance', time: 465 }
            ],
            'Impromptu': [
                { name: 'Prep', time: 120 },
                { name: 'Speech', time: 300 }
            ],
            'Extemporaneous Commentary': [
                { name: 'Intro', time: 60 },
                { name: 'Points', time: 300 },
                { name: 'Conclusion', time: 60 }
            ],
            'Expository': [
                { name: 'Intro', time: 45 },
                { name: 'Body', time: 210 },
                { name: 'Conclusion', time: 45 }
            ],
            'Storytelling': [
                { name: 'Intro', time: 30 },
                { name: 'Story', time: 270 }
            ],
            'Prose/Poetry': [
                { name: 'Intro', time: 30 },
                { name: 'Reading', time: 270 }
            ],
            'Parliamentary (British)': [
                { name: 'Constructive', time: 420 },
                { name: 'Rebuttal', time: 240 }
            ],
            'Parliamentary (Asian)': [
                { name: 'Constructive', time: 420 },
                { name: 'Reply', time: 240 }
            ],
            'Model UN Speech': [
                { name: 'Intro', time: 15 },
                { name: 'Points', time: 60 },
                { name: 'Call to Action', time: 15 }
            ],
            'After Dinner Speaking': [
                { name: 'Intro', time: 60 },
                { name: 'Body (Humor)', time: 240 },
                { name: 'Conclusion', time: 60 }
            ],
            'Toast/Ceremonial': [
                { name: 'Intro', time: 30 },
                { name: 'Body', time: 120 },
                { name: 'Toast', time: 30 }
            ],
            'default': [
                { name: 'Speech', time: 600 }
            ]
        };

        const AudioVisualizer = ({ analyser, isRecording }) => {
            const canvasRef = useRef(null);

            useEffect(() => {
                if (!analyser || !isRecording || !canvasRef.current) return;

                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                let animationId;

                const draw = () => {
                    animationId = requestAnimationFrame(draw);
                    analyser.getByteFrequencyData(dataArray);

                    ctx.fillStyle = 'rgb(0, 0, 0, 0)'; // Transparent clear
                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    const barWidth = (canvas.width / bufferLength) * 2.5;
                    let barHeight;
                    let x = 0;

                    for (let i = 0; i < bufferLength; i++) {
                        barHeight = dataArray[i] / 2;

                        // Gradient color based on height
                        const gradient = ctx.createLinearGradient(0, canvas.height, 0, 0);
                        gradient.addColorStop(0, '#4f46e5'); // Indigo
                        gradient.addColorStop(1, '#a855f7'); // Purple

                        ctx.fillStyle = gradient;
                        ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);

                        x += barWidth + 1;
                    }
                };

                draw();

                return () => cancelAnimationFrame(animationId);
            }, [analyser, isRecording]);

            if (!isRecording) return null;

            return <canvas ref={canvasRef} width={300} height={100} className="w-full max-w-xs h-24 rounded-lg" />;
        };

        const ToneIndicator = ({ analyser, isRecording }) => {
            const [metrics, setMetrics] = useState({ volume: 0, brightness: 0 });
            const [feedback, setFeedback] = useState({ label: 'Ready', color: 'text-slate-400' });
            const smoothedMetrics = useRef({ volume: 0, brightness: 0 });

            useEffect(() => {
                if (!analyser || !isRecording) return;
                
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                const waveformArray = new Uint8Array(analyser.fftSize);
                
                let updateId;
                
                const update = () => {
                    analyser.getByteFrequencyData(dataArray);
                    analyser.getByteTimeDomainData(waveformArray);
                    
                    // Calculate Volume (RMS)
                    let sum = 0;
                    for(let i = 0; i < waveformArray.length; i++) {
                        const amplitude = (waveformArray[i] - 128) / 128;
                        sum += amplitude * amplitude;
                    }
                    const rawVolume = Math.sqrt(sum / waveformArray.length); // 0 to 1
                    
                    // Calculate Brightness (Spectral Centroid)
                    let numerator = 0;
                    let denominator = 0;
                    for(let i = 0; i < bufferLength; i++) {
                        numerator += i * dataArray[i];
                        denominator += dataArray[i];
                    }
                    const rawBrightness = denominator === 0 ? 0 : (numerator / denominator) / bufferLength; // 0 to 1
                    
                    // Apply Smoothing (Low-pass filter)
                    // alpha = 0.2 means 20% new value, 80% old value
                    const alpha = 0.15;
                    smoothedMetrics.current.volume = smoothedMetrics.current.volume * (1 - alpha) + rawVolume * alpha;
                    smoothedMetrics.current.brightness = smoothedMetrics.current.brightness * (1 - alpha) + rawBrightness * alpha;

                    const { volume, brightness } = smoothedMetrics.current;

                    setMetrics({ volume, brightness });
                    
                    // Determine Tone Label
                    if (volume < 0.01) {
                        setFeedback({ label: 'Listening...', color: 'text-slate-400' });
                    } else if (volume < 0.05) {
                        setFeedback({ label: 'Too Quiet', color: 'text-amber-500' });
                    } else if (volume > 0.6) {
                        setFeedback({ label: 'Too Loud / Aggressive', color: 'text-red-500' });
                    } else {
                        // Good volume range
                        if (brightness > 0.5) {
                            setFeedback({ label: 'Urgent / Intense', color: 'text-orange-500' });
                        } else if (brightness < 0.2) {
                            setFeedback({ label: 'Serious / Gravitas', color: 'text-indigo-500' });
                        } else {
                            setFeedback({ label: 'Balanced / Clear', color: 'text-green-500' });
                        }
                    }
                    
                    updateId = requestAnimationFrame(update);
                };
                
                update();
                return () => cancelAnimationFrame(updateId);
            }, [analyser, isRecording]);

            if (!isRecording) return null;

            return (
                <div className="flex flex-col items-center space-y-2 mt-4 animate-in fade-in">
                    <div className={`text-lg font-bold ${feedback.color} transition-colors duration-300`}>
                        {feedback.label}
                    </div>
                    <div className="flex space-x-4 text-xs text-slate-400">
                        <div className="flex flex-col items-center">
                            <div className="h-16 w-4 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden relative">
                                <div 
                                    className="absolute bottom-0 left-0 w-full bg-indigo-500 transition-all duration-100"
                                    style={{ height: `${Math.min(metrics.volume * 200, 100)}%` }}
                                ></div>
                            </div>
                            <span className="mt-1">Vol</span>
                        </div>
                        <div className="flex flex-col items-center">
                            <div className="h-16 w-4 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden relative">
                                <div 
                                    className="absolute bottom-0 left-0 w-full bg-purple-500 transition-all duration-100"
                                    style={{ height: `${Math.min(metrics.brightness * 300, 100)}%` }}
                                ></div>
                            </div>
                            <span className="mt-1">Tone</span>
                        </div>
                    </div>
                </div>
            );
        };

        const rubrics = {
            'Public Forum (PF)': `
                - **Evidence & Warrants (30%)**: Quality of evidence, logical links.
                - **Impact Calculus (30%)**: Magnitude, probability, timeframe.
                - **Clash & Rebuttal (20%)**: Direct responsiveness to opponent.
                - **Delivery (10%)**: Clarity, persuasion, speed.
                - **Crossfire (10%)**: Question quality and dominance.
            `,
            'Lincoln-Douglas (LD)': `
                - **Value & Criterion (30%)**: Framework clarity and application.
                - **Contentions (30%)**: Logical consistency and evidence.
                - **Philosophical Depth (20%)**: Understanding of core values.
                - **Clash (10%)**: Direct refutation.
                - **Delivery (10%)**: Persuasiveness.
            `,
            'Policy Debate (CX)': `
                - **Stock Issues (30%)**: Harms, Solvency, Inherency, Topicality, Significance.
                - **Evidence Quality (25%)**: Source credibility and recency.
                - **Flow & Organization (20%)**: Line-by-line refutation.
                - **Impact Analysis (15%)**: Terminal impacts.
                - **Delivery (10%)**: Clarity (even if spreading).
            `,
            'World Schools Debate': `
                - **Content (40%)**: Logic and relevance of arguments.
                - **Style (40%)**: Rhetoric, delivery, tone.
                - **Strategy (20%)**: Structure, timing, teamwork.
            `,
            'Congressional Debate': `
                - **Argumentation (35%)**: New analysis, evidence.
                - **Rhetoric (35%)**: Persuasion, delivery, style.
                - **Parliamentary Procedure (15%)**: Knowledge of rules.
                - **Questioning (15%)**: Engagement in chamber.
            `,
            'Big Questions Debate': `
                - **Argumentation (40%)**: Logic, evidence, and analysis.
                - **Affirmative/Negative Burden (30%)**: Fulfilling side obligations.
                - **Delivery (20%)**: Persuasion and clarity.
                - **Questioning (10%)**: Effectiveness in Q&A.
            `,
            'United States Extemp (USX)': `
                - **Analysis (40%)**: Depth of answer to the question.
                - **Sourcing (20%)**: Variety and quality of sources.
                - **Organization (20%)**: Structure (Intro, Points, Conclusion).
                - **Delivery (20%)**: Fluency, tone, and poise.
            `,
            'International Extemp (IX)': `
                - **Analysis (40%)**: Depth of answer to the question.
                - **Sourcing (20%)**: Variety and quality of sources.
                - **Organization (20%)**: Structure (Intro, Points, Conclusion).
                - **Delivery (20%)**: Fluency, tone, and poise.
            `,
            'Original Oratory (OO)': `
                - **Topic/Content (40%)**: Originality, significance, and depth.
                - **Delivery (40%)**: Vocal variety, movement, and emotion.
                - **Structure (20%)**: Flow and organization.
            `,
            'Informative Speaking (INFO)': `
                - **Topic/Content (50%)**: Educational value and originality.
                - **Delivery (30%)**: Engagement and clarity.
                - **Structure (20%)**: Organization.
            `,
            'Dramatic Interpretation (DI)': `
                - **Characterization (40%)**: Depth and believability.
                - **Cutting (30%)**: Story arc and coherence.
                - **Delivery (30%)**: Vocal and physical control.
            `,
            'Humorous Interpretation (HI)': `
                - **Characterization (40%)**: Distinct voices and physical comedy.
                - **Cutting (30%)**: Story arc and humor.
                - **Delivery (30%)**: Timing and execution.
            `,
            'Duo Interpretation': `
                - **Interaction (30%)**: Chemistry and timing (without touching).
                - **Characterization (30%)**: Distinct roles.
                - **Cutting (20%)**: Story coherence.
                - **Blocking (20%)**: Creative use of space.
            `,
            'Program Oral Interpretation (POI)': `
                - **Programming (40%)**: Weaving of different genres/pieces.
                - **Theme (30%)**: Coherence of the central argument.
                - **Delivery (30%)**: Character differentiation and binder technique.
            `,
            'Impromptu': `
                - **Organization (40%)**: Clear structure (Intro, 2-3 points, Conclusion).
                - **Analysis (40%)**: Depth of interpretation of the prompt.
                - **Delivery (20%)**: Fluency and poise.
            `,
            'Extemporaneous Commentary': `
                - **Analysis (50%)**: Insight into the topic.
                - **Delivery (30%)**: Conversational yet professional style.
                - **Structure (20%)**: Clear organization.
            `,
            'Expository': `
                - **Content (50%)**: Informative and well-researched.
                - **Delivery (30%)**: Engaging and clear.
                - **Organization (20%)**: Logical flow.
            `,
            'Storytelling': `
                - **Narrative (40%)**: Plot and pacing.
                - **Characterization (30%)**: Voices and physicalization.
                - **Engagement (30%)**: Connection with audience.
            `,
            'Prose/Poetry': `
                - **Interpretation (40%)**: Understanding of the text.
                - **Delivery (40%)**: Vocal variety and emotion.
                - **Binder Technique (20%)**: Professional use of the book.
            `,
            'Parliamentary (British)': `
                - **Matter (40%)**: Content and logic.
                - **Manner (40%)**: Style and delivery.
                - **Method (20%)**: Structure and responsiveness.
            `,
            'Parliamentary (Asian)': `
                - **Matter (40%)**: Content and logic.
                - **Manner (40%)**: Style and delivery.
                - **Method (20%)**: Structure and responsiveness.
            `,
            'Model UN Speech': `
                - **Diplomacy (30%)**: Tone and adherence to policy.
                - **Content (40%)**: Substance and solutions.
                - **Rhetoric (30%)**: Persuasiveness.
            `,
            'After Dinner Speaking': `
                - **Humor (40%)**: Effectiveness of jokes.
                - **Message (30%)**: Underlying serious point.
                - **Delivery (30%)**: Timing and style.
            `,
            'Toast/Ceremonial': `
                - **Sentiment (40%)**: Appropriateness and emotion.
                - **Brevity (20%)**: Concise and focused.
                - **Delivery (40%)**: Connection with audience.
            `,
            'default': `
                - **Argumentation (40%)**: Logic, evidence, structure.
                - **Delivery (30%)**: Tone, pace, clarity.
                - **Strategy (20%)**: Time management, focus.
                - **Responsiveness (10%)**: Engagement with the topic.
            `
        };

        const Sidebar = ({ activeTab, setActiveTab, user, logout, theme, setTheme, setShowLogin, isOpen, setIsOpen }) => {
            const navItems = [
                { id: 'dashboard', label: 'Dashboard', icon: Layout },
                { id: 'speech', label: 'Judge Text', icon: Mic },
                { id: 'board', label: 'Evaluate Board', icon: ImageIcon },
                { id: 'strategy', label: 'Board Gen', icon: Zap },
                { id: 'listen', label: 'Live Coach', icon: Activity },
                { id: 'coach', label: 'Judge Tools', icon: Gavel },
                { id: 'history', label: 'History', icon: History },
                { id: 'settings', label: 'Configuration', icon: Settings },
            ];

            return (
                <div className="fixed inset-y-0 left-0 z-50 w-16 bg-slate-950 border-r border-slate-800 flex flex-col items-center py-4">
                    {/* Logo */}
                    <div className="mb-8 p-2 bg-indigo-600 rounded-sm shadow-[0_0_10px_rgba(79,70,229,0.5)]">
                        <Gavel className="w-6 h-6 text-white" />
                    </div>

                    {/* Nav Items */}
                    <nav className="flex-1 w-full flex flex-col items-center space-y-4">
                        {navItems.map(item => (
                            <button
                                key={item.id}
                                onClick={() => setActiveTab(item.id)}
                                title={item.label}
                                className={`p-3 rounded-sm transition-all duration-200 group relative ${
                                    activeTab === item.id 
                                        ? 'text-cyan-400 bg-slate-900 border-l-2 border-cyan-500' 
                                        : 'text-slate-500 hover:text-slate-300 hover:bg-slate-900'
                                }`}
                            >
                                <item.icon className="w-5 h-5" />
                                {activeTab === item.id && (
                                    <div className="absolute inset-0 bg-cyan-500/10 blur-sm"></div>
                                )}
                            </button>
                        ))}
                    </nav>

                    {/* Footer / User */}
                    <div className="mt-auto flex flex-col items-center space-y-4">
                        <button 
                            onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')} 
                            className="p-2 text-slate-500 hover:text-slate-300"
                        >
                            {theme === 'dark' ? <Moon className="w-5 h-5" /> : <Sun className="w-5 h-5" />}
                        </button>
                        
                        <button onClick={() => setActiveTab('profile')} className={`w-8 h-8 rounded-full bg-slate-800 border border-slate-700 flex items-center justify-center text-xs font-mono text-slate-300 hover:border-cyan-500 hover:text-cyan-500 transition-colors ${activeTab === 'profile' ? 'border-cyan-500 text-cyan-500' : ''}`}>
                            {user ? (user.username || user.email)[0].toUpperCase() : <User className="w-4 h-4" />}
                        </button>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ user, history, setActiveTab, provider, apiKey, openaiKey }) => {
            const [tip, setTip] = useState('');

            useEffect(() => {
                const tips = [
                    "Flowing is essential: Use two different colored pens for Aff and Neg arguments.",
                    "In Cross-Ex, ask open-ended questions to force your opponent to explain, not just say yes/no.",
                    "Signposting helps the judge follow your speech. Clearly state which contention you are addressing.",
                    "Impact calculus: Tell the judge why your impacts matter more (Magnitude, Probability, Timeframe).",
                    "Don't drop arguments. If an opponent makes a point, you must address it or it stands.",
                    "Eye contact matters. Look at the judge, not just your paper.",
                    "Use 'even if' arguments to layer your defense.",
                ];
                setTip(tips[Math.floor(Math.random() * tips.length)]);
            }, []);

            const calculateAverageScore = () => {
                if (!history || history.length === 0) return 'N/A';
                let total = 0;
                let count = 0;
                history.forEach(h => {
                    const content = h.result || h.content || '';
                    const tableMatch = content.match(/\|\s*\*\*Total\*\*\s*\|\s*\*\*(\d+)\*\*\s*\|/);
                    const simpleMatch = content.match(/Score:\s*(\d+)/i);
                    if (tableMatch && tableMatch[1]) {
                        total += parseInt(tableMatch[1]);
                        count++;
                    } else if (simpleMatch && simpleMatch[1]) {
                        total += parseInt(simpleMatch[1]);
                        count++;
                    }
                });
                return count > 0 ? Math.round(total / count) : 'N/A';
            };

            const stats = [
                { label: 'TOTAL SESSIONS', value: history.length, icon: Activity, color: 'text-blue-400' },
                { label: 'LATEST TOPIC', value: history[0]?.topic || 'N/A', icon: BookOpen, color: 'text-purple-400' },
                { label: 'AVG SCORE', value: calculateAverageScore(), icon: Award, color: 'text-amber-400' },
            ];

            const tools = [
                { id: 'speech', title: 'JUDGE SPEECH', desc: 'Paste transcripts for instant scoring.', icon: Mic, color: 'text-cyan-400' },
                { id: 'board', title: 'EVALUATE FLOW', desc: 'Upload flow photos for analysis.', icon: ImageIcon, color: 'text-pink-400' },
                { id: 'strategy', title: 'BOARD GEN', desc: 'Generate flow layouts & arguments.', icon: Zap, color: 'text-yellow-400' },
                { id: 'listen', title: 'LIVE COACH', desc: 'Real-time audio analysis.', icon: Activity, color: 'text-red-400' }
            ];

            return (
                <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500 p-6">
                    {/* Header */}
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center border-b border-slate-800 pb-6">
                        <div>
                            <h2 className="text-2xl font-mono font-bold text-white tracking-tight mb-1">
                                DASHBOARD // {user?.username || 'GUEST'}
                            </h2>
                            <p className="text-slate-500 font-mono text-xs uppercase tracking-widest">
                                ONLINE • {new Date().toLocaleDateString()}
                            </p>
                        </div>
                        <div className="mt-4 md:mt-0 flex items-center space-x-4">
                            {tip && (
                                <div className="hidden md:flex items-center px-3 py-1 border border-slate-800 bg-slate-900/50 text-xs font-mono text-slate-400">
                                    <Lightbulb className="w-3 h-3 mr-2 text-yellow-500" />
                                    {tip.substring(0, 40)}...
                                </div>
                            )}
                            <button onClick={() => setActiveTab('speech')} className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white font-mono text-xs font-bold uppercase tracking-wider transition-colors">
                                + NEW ANALYSIS
                            </button>
                        </div>
                    </div>

                    {/* Stats Grid */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        {stats.map((stat, i) => (
                            <div key={i} className="bg-slate-900 border border-slate-800 p-4 flex items-center justify-between group hover:border-slate-600 transition-colors">
                                <div>
                                    <p className="text-[10px] font-mono text-slate-500 uppercase tracking-widest mb-1">{stat.label}</p>
                                    <p className="text-2xl font-mono font-bold text-white truncate">{stat.value}</p>
                                </div>
                                <stat.icon className={`w-6 h-6 ${stat.color} opacity-50 group-hover:opacity-100 transition-opacity`} />
                            </div>
                        ))}
                    </div>

                    {/* Quick Actions */}
                    <div>
                        <h3 className="text-xs font-mono font-bold text-slate-500 uppercase tracking-widest mb-4 flex items-center">
                            <Zap className="w-3 h-3 mr-2 text-amber-500" /> QUICK ACTIONS
                        </h3>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            {tools.map((tool) => (
                                <button 
                                    key={tool.id}
                                    onClick={() => setActiveTab(tool.id)}
                                    className="group bg-slate-900 border border-slate-800 p-6 hover:bg-slate-800 hover:border-cyan-500/50 transition-all duration-300 text-left relative overflow-hidden"
                                >
                                    <div className="relative z-10">
                                        <tool.icon className={`w-6 h-6 ${tool.color} mb-4`} />
                                        <h4 className="text-sm font-mono font-bold text-white mb-2 group-hover:text-cyan-400 transition-colors">{tool.title}</h4>
                                        <p className="text-xs text-slate-500 font-mono leading-relaxed">{tool.desc}</p>
                                    </div>
                                    <div className="absolute top-0 right-0 p-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <ArrowRight className="w-4 h-4 text-cyan-500" />
                                    </div>
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Extemp Generator */}
                    <ExtempQuestionGenerator provider={provider} apiKey={apiKey} openaiKey={openaiKey} />

                    {/* Recent History */}
                    <div className="border border-slate-800 bg-slate-900">
                        <div className="p-4 border-b border-slate-800 flex justify-between items-center bg-slate-950">
                            <h3 className="text-xs font-mono font-bold text-slate-400 uppercase tracking-widest flex items-center">
                                <History className="w-3 h-3 mr-2" /> RECENT HISTORY
                            </h3>
                            <button onClick={() => setActiveTab('history')} className="text-[10px] font-mono text-cyan-500 hover:text-cyan-400 uppercase">VIEW ALL</button>
                        </div>
                        <div className="divide-y divide-slate-800">
                            {history.length === 0 ? (
                                <div className="p-8 text-center text-slate-600 font-mono text-xs">No history found. Start a new session.</div>
                            ) : (
                                history.slice(0, 5).map(item => (
                                    <div key={item.id} className="p-3 hover:bg-slate-800 transition-colors flex items-center justify-between group cursor-pointer">
                                        <div className="flex items-center space-x-4">
                                            <div className={`w-1.5 h-1.5 ${item.type === 'speech' ? 'bg-blue-500' : item.type === 'board' ? 'bg-pink-500' : 'bg-green-500'}`}></div>
                                            <div>
                                                <p className="font-mono text-xs font-bold text-slate-300 group-hover:text-white">{item.topic}</p>
                                                <p className="text-[10px] font-mono text-slate-600">{item.date} • {item.type.toUpperCase()}</p>
                                            </div>
                                        </div>
                                        <div className="text-[10px] font-mono text-slate-600 group-hover:text-cyan-500">OPEN</div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- App Component ---
        function App() {
            // State Management
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [activeTab, setActiveTab] = useState('dashboard'); 
            const [provider, setProvider] = useState('gemini'); // gemini, openai
            const [apiKey, setApiKey] = useState('');
            const [openaiKey, setOpenaiKey] = useState('');
            const [loading, setLoading] = useState(false);
            const [result, setResult] = useState(null);
            const [error, setError] = useState('');
            const [showHelp, setShowHelp] = useState(false);
            const [showHistory, setShowHistory] = useState(false);
            const [history, setHistory] = useState([]);
            const [theme, setTheme] = useState('light'); // light, dark, neon
            const [radarData, setRadarData] = useState(null);
            
            // Auth State
            const [user, setUser] = useState(null);
            const [showLogin, setShowLogin] = useState(false);
            const [authMode, setAuthMode] = useState('login'); // login, signup
            const [authUsername, setAuthUsername] = useState('');
            const [authEmail, setAuthEmail] = useState('');
            const [authPassword, setAuthPassword] = useState('');
            const [authError, setAuthError] = useState('');
            const [showUsernameSetup, setShowUsernameSetup] = useState(false);
            const [isFirebaseReady, setIsFirebaseReady] = useState(false);
            const [verificationStatus, setVerificationStatus] = useState({ gemini: 'idle', openai: 'idle' }); // idle, loading, success, error

            useEffect(() => {
                const savedTheme = localStorage.getItem('theme') || 'light';
                setTheme(savedTheme);
                
                // Check if Firebase is initialized
                if (window.auth && window.firebaseAuth) {
                    setIsFirebaseReady(true);
                    const unsubscribe = window.firebaseAuth.onAuthStateChanged(window.auth, async (currentUser) => {
                        if (currentUser) {
                            // Fetch additional user data (username)
                            let username = null;
                            let storedGeminiKey = '';
                            let storedOpenaiKey = '';
                            try {
                                const userDoc = await window.firebaseDb.getDoc(window.firebaseDb.doc(window.db, "users", currentUser.uid));
                                if (userDoc.exists()) {
                                    const data = userDoc.data();
                                    username = data.username;
                                    storedGeminiKey = data.geminiKey || '';
                                    storedOpenaiKey = data.openaiKey || '';
                                }
                            } catch (e) {
                                console.error("Error fetching user profile:", e);
                            }
                            
                            // Merge username into the user object or state
                            const enhancedUser = { ...currentUser, username };
                            // Admin Check
                            if (username === 'Daniel' || currentUser.email === 'danielschool293@gmail.com') {
                                enhancedUser.isAdmin = true;
                            }
                            
                            setUser(enhancedUser);
                            setApiKey(storedGeminiKey);
                            setOpenaiKey(storedOpenaiKey);
                            
                            setShowLogin(false);
                            if (!username) {
                                setShowUsernameSetup(true);
                            }
                            loadUserHistory(currentUser.uid);
                        } else {
                            setUser(null);
                            setShowLogin(true);
                        }
                    });
                    return () => unsubscribe();
                } else {
                    // Fallback for when config is missing
                    console.warn("Firebase not configured. Using local storage fallback.");
                    const sessionUser = localStorage.getItem('activeUser');
                    if (sessionUser) {
                        const userData = JSON.parse(sessionUser);
                        // Admin Check (Local)
                        if (userData.username === 'Daniel' || userData.email === 'danielschool293@gmail.com') {
                            userData.isAdmin = true;
                        }
                        setUser(userData);
                        
                        // Load keys from local profile
                        const profile = JSON.parse(localStorage.getItem(`profile_${userData.email}`) || '{}');
                        setApiKey(profile.geminiKey || '');
                        setOpenaiKey(profile.openaiKey || '');

                        setShowLogin(false);
                        loadUserHistory(userData.email); // Fallback uses email as ID
                    } else {
                        setShowLogin(true);
                    }
                }
            }, []);

            // Load history
            const loadUserHistory = async (userId) => {
                if (window.db && window.firebaseDb) {
                    try {
                        const docRef = window.firebaseDb.doc(window.db, "users", userId);
                        const docSnap = await window.firebaseDb.getDoc(docRef);
                        if (docSnap.exists()) {
                            setHistory(docSnap.data().history || []);
                        } else {
                            setHistory([]);
                        }
                    } catch (e) {
                        console.error("Error loading history:", e);
                    }
                } else {
                    // Fallback
                    const savedHistory = localStorage.getItem(`debateHistory_${userId}`);
                    if (savedHistory) setHistory(JSON.parse(savedHistory));
                    else setHistory([]);
                }
            };

            // Save history
            const saveHistoryToCloud = async (newHistory, userId) => {
                if (window.db && window.firebaseDb) {
                    try {
                        const userRef = window.firebaseDb.doc(window.db, "users", userId);
                        await window.firebaseDb.setDoc(userRef, { history: newHistory }, { merge: true });
                    } catch (e) {
                        console.error("Error saving history:", e);
                    }
                }
            };

            // Effect to sync history changes
            useEffect(() => {
                if (user) {
                    const userId = user.uid || user.email;
                    // Local backup
                    localStorage.setItem(`debateHistory_${userId}`, JSON.stringify(history));
                    
                    // Cloud sync
                    if (user.uid && window.db) {
                        saveHistoryToCloud(history, user.uid);
                    }
                }
            }, [history, user]);

            // Help Popup Logic
            useEffect(() => {
                if (user && !showLogin) {
                    const userId = user.uid || user.email;
                    const hasVisited = localStorage.getItem(`hasVisited_${userId}`);
                    if (!hasVisited) {
                        setShowHelp(true);
                        localStorage.setItem(`hasVisited_${userId}`, 'true');
                    }
                }
            }, [user, showLogin]);

            const handleAuth = async (e) => {
                e.preventDefault();
                setAuthError('');
                
                if (!authEmail || !authPassword || (authMode === 'signup' && !authUsername)) {
                    setAuthError('Please fill in all fields');
                    return;
                }

                if (window.auth && window.firebaseAuth && window.auth.app.options.apiKey !== "YOUR_API_KEY_HERE") {
                    // Firebase Auth
                    try {
                        if (authMode === 'signup') {
                            // 1. Check if username is taken
                            const usernameRef = window.firebaseDb.doc(window.db, "usernames", authUsername);
                            const usernameSnap = await window.firebaseDb.getDoc(usernameRef);
                            
                            if (usernameSnap.exists()) {
                                setAuthError('Username is already taken.');
                                return;
                            }

                            // 2. Create User
                            const userCredential = await window.firebaseAuth.createUserWithEmailAndPassword(window.auth, authEmail, authPassword);
                            const user = userCredential.user;

                            // 3. Reserve Username & Create Profile
                            const batch = window.db.batch ? window.db.batch() : null; // Handle if batch isn't available in this simplified import
                            
                            // Fallback to individual writes if batch not easily accessible in this context, 
                            // but let's try standard writes.
                            await window.firebaseDb.setDoc(window.firebaseDb.doc(window.db, "users", user.uid), {
                                email: authEmail,
                                username: authUsername,
                                createdAt: new Date().toISOString(),
                                history: []
                            });
                            
                            await window.firebaseDb.setDoc(window.firebaseDb.doc(window.db, "usernames", authUsername), {
                                uid: user.uid
                            });

                            await window.firebaseAuth.sendEmailVerification(user);
                            setAuthError('Account created! Please check your email to verify your account.');
                        } else {
                            const userCredential = await window.firebaseAuth.signInWithEmailAndPassword(window.auth, authEmail, authPassword);
                            if (!userCredential.user.emailVerified) {
                                // setAuthError('Please verify your email address before signing in.');
                                // Optional: Allow login anyway
                            }
                        }
                        setAuthEmail('');
                        setAuthPassword('');
                        setAuthUsername('');
                    } catch (error) {
                        console.error(error);
                        let msg = error.message;
                        if (error.code === 'auth/invalid-credential') msg = 'Invalid email or password.';
                        if (error.code === 'auth/email-already-in-use') msg = 'Email already in use.';
                        if (error.code === 'auth/weak-password') msg = 'Password should be at least 6 characters.';
                        setAuthError(msg);
                    }
                } else {
                    // Local Storage Fallback (Demo Mode)
                    const users = JSON.parse(localStorage.getItem('registeredUsers') || '{}');
                    const takenUsernames = JSON.parse(localStorage.getItem('takenUsernames') || '{}');

                    if (authMode === 'signup') {
                        if (users[authEmail]) { setAuthError('User already exists'); return; }
                        if (takenUsernames[authUsername]) { setAuthError('Username already taken'); return; }
                        
                        users[authEmail] = authPassword;
                        takenUsernames[authUsername] = authEmail;
                        
                        localStorage.setItem('registeredUsers', JSON.stringify(users));
                        localStorage.setItem('takenUsernames', JSON.stringify(takenUsernames));
                        
                        // Save profile
                        const userProfile = { email: authEmail, username: authUsername };
                        localStorage.setItem(`profile_${authEmail}`, JSON.stringify(userProfile));

                        loginUserLocal(authEmail);
                    } else {
                        if (users[authEmail] && users[authEmail] === authPassword) {
                            loginUserLocal(authEmail);
                        } else {
                            setAuthError('Invalid email or password (Demo Mode)');
                        }
                    }
                }
            };

            const handleGoogleLogin = async () => {
                if (window.auth && window.firebaseAuth && window.googleProvider) {
                    try {
                        await window.firebaseAuth.signInWithPopup(window.auth, window.googleProvider);
                    } catch (error) {
                        console.error(error);
                        setAuthError(error.message);
                    }
                } else {
                    setAuthError("Google Sign-In not configured or available in Demo Mode.");
                }
            };

            const loginUserLocal = (email) => {
                const profile = JSON.parse(localStorage.getItem(`profile_${email}`) || '{}');
                const userData = { email, uid: null, username: profile.username || null }; // No UID for local users
                setUser(userData);
                setApiKey(profile.geminiKey || '');
                setOpenaiKey(profile.openaiKey || '');
                localStorage.setItem('activeUser', JSON.stringify(userData));
                setShowLogin(false);
                if (!userData.username) {
                    setShowUsernameSetup(true);
                }
                loadUserHistory(email);
                setAuthEmail('');
                setAuthPassword('');
                setAuthUsername('');
            };

            const verifyAndSaveKey = async (type, key) => {
                if (!key) return;
                setVerificationStatus(prev => ({ ...prev, [type]: 'loading' }));
                
                try {
                    if (type === 'gemini') {
                        // Test call - List Models (lighter weight check, avoids model-specific 404s)
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                        
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            console.error("Gemini Verification Failed:", errorData);
                            throw new Error(errorData.error?.message || "Invalid Key");
                        }
                        
                        // Save
                        if (user) {
                            if (window.auth && window.firebaseAuth && isFirebaseReady) {
                                await window.firebaseDb.setDoc(window.firebaseDb.doc(window.db, "users", user.uid), {
                                    geminiKey: key
                                }, { merge: true });
                            } else {
                                // Local
                                const profile = JSON.parse(localStorage.getItem(`profile_${user.email}`) || '{}');
                                profile.geminiKey = key;
                                localStorage.setItem(`profile_${user.email}`, JSON.stringify(profile));
                            }
                        }
                        setVerificationStatus(prev => ({ ...prev, [type]: 'success' }));
                        setTimeout(() => setVerificationStatus(prev => ({ ...prev, [type]: 'idle' })), 3000);
                    } else {
                        // OpenAI test - List Models (lighter weight check, avoids model-specific 404s)
                        const response = await fetch('https://api.openai.com/v1/models', {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${key}`
                            }
                        });

                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            console.error("OpenAI Verification Failed:", errorData);
                            throw new Error(errorData.error?.message || "Invalid Key");
                        }
                        
                        // Save
                        if (user) {
                            if (window.auth && window.firebaseAuth && isFirebaseReady) {
                                await window.firebaseDb.setDoc(window.firebaseDb.doc(window.db, "users", user.uid), {
                                    openaiKey: key
                                }, { merge: true });
                            } else {
                                // Local
                                const profile = JSON.parse(localStorage.getItem(`profile_${user.email}`) || '{}');
                                profile.openaiKey = key;
                                localStorage.setItem(`profile_${user.email}`, JSON.stringify(profile));
                            }
                        }
                        setVerificationStatus(prev => ({ ...prev, [type]: 'success' }));
                        setTimeout(() => setVerificationStatus(prev => ({ ...prev, [type]: 'idle' })), 3000);
                    }
                } catch (e) {
                    console.error(e);
                    setVerificationStatus(prev => ({ ...prev, [type]: 'error' }));
                    setTimeout(() => setVerificationStatus(prev => ({ ...prev, [type]: 'idle' })), 3000);
                }
            };

            const handleUsernameSetup = async (e) => {
                e.preventDefault();
                setAuthError('');
                
                if (!authUsername) {
                    setAuthError('Please enter a username');
                    return;
                }

                const offensiveWords = ['admin', 'root', 'system', 'support', 'moderator', 'staff', 'bitch', 'fuck', 'shit', 'ass', 'nigger', 'faggot', 'cunt', 'whore', 'slut', 'dick', 'pussy', 'cock', 'bastard'];
                if (offensiveWords.some(word => authUsername.toLowerCase().includes(word))) {
                    setAuthError('Username contains restricted words.');
                    return;
                }

                if (window.auth && window.firebaseAuth && window.auth.app.options.apiKey !== "YOUR_API_KEY_HERE") {
                    try {
                        // 1. Check if username is taken
                        const usernameRef = window.firebaseDb.doc(window.db, "usernames", authUsername);
                        const usernameSnap = await window.firebaseDb.getDoc(usernameRef);
                        
                        if (usernameSnap.exists()) {
                            setAuthError('Username is already taken.');
                            return;
                        }

                        // 2. Reserve Username & Update Profile
                        const userId = user.uid;
                        await window.firebaseDb.setDoc(window.firebaseDb.doc(window.db, "users", userId), {
                            username: authUsername
                        }, { merge: true });
                        
                        await window.firebaseDb.setDoc(window.firebaseDb.doc(window.db, "usernames", authUsername), {
                            uid: userId
                        });

                        // Update local state
                        setUser(prev => ({ ...prev, username: authUsername }));
                        setShowUsernameSetup(false);
                        setAuthUsername('');
                    } catch (error) {
                        console.error(error);
                        setAuthError(error.message);
                    }
                } else {
                    // Local Storage Fallback
                    const takenUsernames = JSON.parse(localStorage.getItem('takenUsernames') || '{}');
                    if (takenUsernames[authUsername]) { setAuthError('Username already taken'); return; }
                    
                    takenUsernames[authUsername] = user.email;
                    localStorage.setItem('takenUsernames', JSON.stringify(takenUsernames));
                    
                    const userProfile = JSON.parse(localStorage.getItem(`profile_${user.email}`) || '{}');
                    userProfile.username = authUsername;
                    localStorage.setItem(`profile_${user.email}`, JSON.stringify(userProfile));

                    // Update local state
                    const updatedUser = { ...user, username: authUsername };
                    setUser(updatedUser);
                    localStorage.setItem('activeUser', JSON.stringify(updatedUser));
                    
                    setShowUsernameSetup(false);
                    setAuthUsername('');
                }
            };

            const logout = async () => {
                if (window.auth && window.firebaseAuth) {
                    try {
                        await window.firebaseAuth.signOut(window.auth);
                    } catch (e) { console.error(e); }
                }
                setUser(null);
                localStorage.removeItem('activeUser');
                setShowLogin(true);
                setHistory([]);
                setResult(null);
                setTranscript('');
                setBoardImages([]);
                setAudioData(null);
            };

            useEffect(() => {
                const root = document.documentElement;
                const body = document.body;
                
                // Reset
                root.classList.remove('dark');
                body.classList.remove('theme-forest', 'theme-coffee', 'theme-ocean', 'theme-midnight');
                
                if (theme === 'dark') {
                    root.classList.add('dark');
                } else if (theme === 'forest') {
                    root.classList.add('dark');
                    body.classList.add('theme-forest');
                } else if (theme === 'coffee') {
                    root.classList.add('dark');
                    body.classList.add('theme-coffee');
                } else if (theme === 'ocean') {
                    root.classList.add('dark');
                    body.classList.add('theme-ocean');
                } else if (theme === 'midnight') {
                    root.classList.add('dark');
                    body.classList.add('theme-midnight');
                }
                
                localStorage.setItem('theme', theme);
            }, [theme]);

            useEffect(() => {
                const hasVisited = localStorage.getItem('hasVisited');
                if (!hasVisited) {
                    setShowHelp(true);
                    localStorage.setItem('hasVisited', 'true');
                }
            }, []);
            
            // Speech Form State
            const [speechType, setSpeechType] = useState('Public Forum (PF)');
            const [side, setSide] = useState('Proposition/Affirmative');
            const [topic, setTopic] = useState('');
            const [transcript, setTranscript] = useState('');

            // Board Form State
            const [boardDescription, setBoardDescription] = useState('');
            const [boardImages, setBoardImages] = useState([]); 
            const fileInputRef = useRef(null);

            // Audio Recording State
            const [isRecording, setIsRecording] = useState(false);
            const [recordingTime, setRecordingTime] = useState(0);
            const [audioData, setAudioData] = useState(null); 
            const [selectedSection, setSelectedSection] = useState(null);
            const [analyser, setAnalyser] = useState(null);
            
            const mediaRecorderRef = useRef(null);
            const timerRef = useRef(null);
            const chunksRef = useRef([]);
            const audioContextRef = useRef(null);
            const analyserRef = useRef(null);
            const sourceRef = useRef(null);

            // Update selected section when speech type changes
            useEffect(() => {
                const sections = speechTimes[speechType] || speechTimes['default'];
                setSelectedSection(sections[0]);
            }, [speechType]);

            // Options
            const speechTypes = [
                'Policy Debate (CX)', 'Lincoln-Douglas (LD)', 'Public Forum (PF)', 'Big Questions Debate',
                'World Schools Debate', 'Congressional Debate', 'Original Oratory (OO)', 'Informative Speaking (INFO)',
                'United States Extemp (USX)', 'International Extemp (IX)', 'Dramatic Interpretation (DI)',
                'Humorous Interpretation (HI)', 'Duo Interpretation', 'Program Oral Interpretation (POI)',
                'Impromptu', 'Extemporaneous Commentary', 'Expository', 'Storytelling', 'Prose/Poetry',
                'Parliamentary (British)', 'Parliamentary (Asian)', 'Model UN Speech', 'After Dinner Speaking', 'Toast/Ceremonial'
            ];

            const sides = [
                'Proposition/Affirmative', 'Opposition/Negative', 'Government', 'Opposition',
                'Pro', 'Con', 'Opening Member', 'Closing Member/Whip', 'Sponsor (Congress)',
                'Individual/Solo', 'Neutral/Evaluator'
            ];

            // Handlers
            const handleImageUpload = (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;
                files.forEach(file => {
                    if (file.size > 4 * 1024 * 1024) {
                        setError(prev => (prev ? `${prev} ` : '') + `Skipped ${file.name} (too large).`);
                        return;
                    }
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const base64String = reader.result.split(',')[1];
                        setBoardImages(prev => [...prev, {
                            id: Math.random().toString(36).substr(2, 9),
                            url: reader.result,
                            raw: base64String,
                            mimeType: file.type,
                            name: file.name
                        }]);
                    };
                    reader.readAsDataURL(file);
                });
                if (fileInputRef.current) fileInputRef.current.value = '';
            };

            const removeImage = (id) => {
                setBoardImages(prev => prev.filter(img => img.id !== id));
            };

            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            };

            const startRecording = async () => {
                setError('');
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    
                    // Audio Context Setup for Visualization
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const analyserNode = audioContext.createAnalyser();
                    const source = audioContext.createMediaStreamSource(stream);
                    source.connect(analyserNode);
                    analyserNode.fftSize = 256;
                    
                    audioContextRef.current = audioContext;
                    analyserRef.current = analyserNode;
                    sourceRef.current = source;
                    setAnalyser(analyserNode);

                    mediaRecorderRef.current = new MediaRecorder(stream);
                    chunksRef.current = [];
                    mediaRecorderRef.current.ondataavailable = (e) => {
                        if (e.data.size > 0) chunksRef.current.push(e.data);
                    };
                    mediaRecorderRef.current.onstop = () => {
                        const blob = new Blob(chunksRef.current, { type: 'audio/webm' });
                        const reader = new FileReader();
                        reader.readAsDataURL(blob);
                        reader.onloadend = () => {
                            const base64String = reader.result.split(',')[1];
                            setAudioData({ raw: base64String, mimeType: blob.type });
                        };
                        stream.getTracks().forEach(track => track.stop());
                        
                        // Cleanup Audio Context
                        if (audioContextRef.current) {
                            audioContextRef.current.close();
                            audioContextRef.current = null;
                            setAnalyser(null);
                        }
                    };
                    mediaRecorderRef.current.start();
                    setIsRecording(true);
                    setRecordingTime(0);
                    setAudioData(null);
                    timerRef.current = setInterval(() => setRecordingTime(prev => prev + 1), 1000);
                } catch (err) {
                    setError("Could not access microphone. Ensure permissions are granted (may require HTTPS or localhost).");
                    console.error(err);
                }
            };

            const stopRecording = () => {
                if (mediaRecorderRef.current && isRecording) {
                    mediaRecorderRef.current.stop();
                    setIsRecording(false);
                    clearInterval(timerRef.current);
                }
            };

            const resetAudio = () => {
                setAudioData(null);
                setRecordingTime(0);
                setError('');
            };

            const addToHistory = (generatedText, type, inputData) => {
                const newItem = {
                    id: Date.now(),
                    date: new Date().toLocaleString(),
                    type,
                    topic: topic || 'Untitled',
                    result: generatedText,
                    input: inputData,
                    preview: generatedText.substring(0, 150) + '...'
                };
                setHistory(prev => [newItem, ...prev]);
            };

            const clearHistory = () => {
                if (confirm('Are you sure you want to clear all history?')) {
                    setHistory([]);
                }
            };

            // --- Coach Tools Component ---
            const CoachTools = ({ speechTimes, rubrics }) => {
                const [format, setFormat] = useState('Public Forum (PF)');
                const [activeSpeech, setActiveSpeech] = useState(null);
                
                // Main Speech Timer
                const [mainTimer, setMainTimer] = useState(0);
                const [isMainRunning, setIsMainRunning] = useState(false);
                const mainInterval = useRef(null);

                // Prep Timers
                const [prepA, setPrepA] = useState(180); // 3 mins default
                const [isPrepARunning, setIsPrepARunning] = useState(false);
                const prepAInterval = useRef(null);

                const [prepB, setPrepB] = useState(180);
                const [isPrepBRunning, setIsPrepBRunning] = useState(false);
                const prepBInterval = useRef(null);

                // Grace Timers
                const [graceA, setGraceA] = useState(120); // 2 mins default
                const [isGraceARunning, setIsGraceARunning] = useState(false);
                const graceAInterval = useRef(null);

                const [graceB, setGraceB] = useState(120);
                const [isGraceBRunning, setIsGraceBRunning] = useState(false);
                const graceBInterval = useRef(null);

                // Event Configuration
                const eventSettings = {
                    'Public Forum (PF)': { type: 'debate', showPrep: true, prepTime: 180, teamA: 'Pro', teamB: 'Con' },
                    'Lincoln-Douglas (LD)': { type: 'debate', showPrep: true, prepTime: 240, teamA: 'Aff', teamB: 'Neg' },
                    'Policy Debate (CX)': { type: 'debate', showPrep: true, prepTime: 300, teamA: 'Aff', teamB: 'Neg' },
                    'Big Questions Debate': { type: 'debate', showPrep: true, prepTime: 180, teamA: 'Aff', teamB: 'Neg' },
                    'World Schools Debate': { type: 'debate', showPrep: false, teamA: 'Prop', teamB: 'Opp' },
                    'Parliamentary (British)': { type: 'debate', showPrep: false, teamA: 'Gov', teamB: 'Opp' },
                    'Parliamentary (Asian)': { type: 'debate', showPrep: false, teamA: 'Gov', teamB: 'Opp' },
                    'Congressional Debate': { type: 'congress', showPrep: false },
                    'default': { type: 'speech', showPrep: false, teamA: 'Team A', teamB: 'Team B' }
                };

                const currentSettings = eventSettings[format] || eventSettings['default'];

                useEffect(() => {
                    if (speechTimes[format]) {
                        setActiveSpeech(speechTimes[format][0]);
                        setMainTimer(speechTimes[format][0].time);
                    }
                    // Reset prep timers based on format
                    if (currentSettings.showPrep) {
                        setPrepA(currentSettings.prepTime);
                        setPrepB(currentSettings.prepTime);
                    }
                }, [format]);

                useEffect(() => {
                    if (activeSpeech) {
                        setMainTimer(activeSpeech.time);
                        setIsMainRunning(false);
                        clearInterval(mainInterval.current);
                    }
                }, [activeSpeech]);

                const toggleTimer = (timerState, setTimerState, intervalRef, setTime) => {
                    if (timerState) {
                        clearInterval(intervalRef.current);
                        setTimerState(false);
                    } else {
                        setTimerState(true);
                        intervalRef.current = setInterval(() => {
                            setTime(prev => {
                                if (prev <= 0) {
                                    clearInterval(intervalRef.current);
                                    setTimerState(false);
                                    return 0;
                                }
                                return prev - 1;
                            });
                        }, 1000);
                    }
                };

                const resetTimer = (setTime, initialValue, setRunning, intervalRef) => {
                    clearInterval(intervalRef.current);
                    setRunning(false);
                    setTime(initialValue);
                };

                const formatTime = (seconds) => {
                    const mins = Math.floor(seconds / 60);
                    const secs = seconds % 60;
                    return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
                };

                return (
                    <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4">
                        {/* Header & Format Selection */}
                        <div className="bg-slate-900/50 p-6 border border-slate-800">
                            <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                                <div>
                                    <h2 className="text-xl font-bold text-white uppercase tracking-widest">Debate Timers</h2>
                                    <p className="text-slate-400 text-xs font-mono">Official Timing Tools</p>
                                </div>
                                    <div className="w-full md:w-64">
                                    <label className="block text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Format</label>
                                    <div className="relative group">
                                        <select 
                                            className="w-full appearance-none bg-black border border-slate-700 text-cyan-400 py-2 px-3 text-xs font-mono uppercase outline-none focus:border-cyan-500 transition-all cursor-pointer"
                                            value={format}
                                            onChange={(e) => setFormat(e.target.value)}
                                        >
                                            {Object.keys(speechTimes).filter(k => k !== 'default').map(k => (
                                                <option key={k} value={k}>{k}</option>
                                            ))}
                                        </select>
                                        <div className="absolute right-3 top-3 pointer-events-none">
                                            <div className="w-0 h-0 border-l-[4px] border-l-transparent border-r-[4px] border-r-transparent border-t-[4px] border-t-cyan-500"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Main Speech Timer */}
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div className="lg:col-span-2 bg-slate-900/50 p-6 border border-slate-800 flex flex-col relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-2 h-2 border-t border-l border-cyan-500"></div>
                                <div className="absolute top-0 right-0 w-2 h-2 border-t border-r border-cyan-500"></div>
                                <div className="absolute bottom-0 left-0 w-2 h-2 border-b border-l border-cyan-500"></div>
                                <div className="absolute bottom-0 right-0 w-2 h-2 border-b border-r border-cyan-500"></div>

                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="font-bold text-sm text-cyan-500 uppercase tracking-widest flex items-center">
                                        <Mic className="w-4 h-4 mr-2" /> Main Timer
                                    </h3>
                                    <div className="flex space-x-2 flex-wrap gap-y-2">
                                        {speechTimes[format]?.map((s, idx) => (
                                            <button 
                                                key={idx}
                                                onClick={() => setActiveSpeech(s)}
                                                className={`px-3 py-1 text-[10px] font-mono uppercase border transition-all ${activeSpeech?.name === s.name ? 'bg-cyan-900/50 border-cyan-500 text-cyan-400' : 'bg-transparent border-slate-700 text-slate-500 hover:border-slate-500'}`}
                                            >
                                                {s.name}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                
                                <div className="flex-1 flex flex-col items-center justify-center py-8">
                                    <div className="text-center mb-4">
                                        <span className="text-xs font-bold text-slate-500 uppercase tracking-[0.2em]">{activeSpeech?.name || 'Select Speech'}</span>
                                    </div>
                                    <div className={`text-8xl font-mono font-bold tracking-tighter mb-8 tabular-nums ${mainTimer < 30 ? 'text-red-500 animate-pulse' : 'text-white'}`}>
                                        {formatTime(mainTimer)}
                                    </div>
                                    
                                    {/* Progress Bar */}
                                    {activeSpeech && (
                                        <div className="w-full max-w-md h-2 bg-slate-800 rounded-full overflow-hidden mb-8 border border-slate-700">
                                            <div 
                                                className={`h-full transition-all duration-1000 ease-linear ${mainTimer < 30 ? 'bg-red-500' : 'bg-cyan-500'}`}
                                                style={{ width: `${(mainTimer / activeSpeech.time) * 100}%` }}
                                            />
                                        </div>
                                    )}

                                    <div className="flex space-x-4">
                                        <button 
                                            onClick={() => toggleTimer(isMainRunning, setIsMainRunning, mainInterval, setMainTimer)}
                                            className={`w-32 py-3 font-bold text-xs uppercase tracking-widest border transition-all ${isMainRunning ? 'bg-amber-900/20 border-amber-500 text-amber-500 hover:bg-amber-900/40' : 'bg-cyan-900/20 border-cyan-500 text-cyan-400 hover:bg-cyan-900/40'}`}
                                        >
                                            {isMainRunning ? 'Pause' : 'Start'}
                                        </button>
                                        <button 
                                            onClick={() => resetTimer(setMainTimer, activeSpeech?.time || 0, setIsMainRunning, mainInterval)}
                                            className="w-32 py-3 font-bold text-xs uppercase tracking-widest border border-slate-700 text-slate-400 hover:border-slate-500 hover:text-slate-200 transition-colors"
                                        >
                                            Reset
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {/* Prep & Grace Timers - Only show for Debate formats */}
                            {currentSettings.type === 'debate' && (
                                <div className="space-y-6">
                                    {/* Prep Time - Only if format has prep */}
                                    {currentSettings.showPrep && (
                                        <div className="bg-slate-900/50 p-5 border border-slate-800">
                                            <h3 className="font-bold text-xs text-slate-500 uppercase tracking-widest mb-4 flex items-center">
                                                <History className="w-3 h-3 mr-2" /> Prep Time
                                            </h3>
                                            <div className="space-y-4">
                                                {/* Team A */}
                                                <div className="bg-black p-3 border border-slate-800">
                                                    <div className="flex justify-between items-center mb-2">
                                                        <span className="text-[10px] font-bold text-cyan-500 uppercase">{currentSettings.teamA} Prep</span>
                                                        <span className={`font-mono font-bold text-xl ${prepA < 30 ? 'text-red-500' : 'text-slate-200'}`}>{formatTime(prepA)}</span>
                                                    </div>
                                                    <div className="flex space-x-2">
                                                        <button onClick={() => toggleTimer(isPrepARunning, setIsPrepARunning, prepAInterval, setPrepA)} className={`flex-1 py-1 text-[10px] font-mono uppercase border ${isPrepARunning ? 'border-amber-500 text-amber-500' : 'border-cyan-500 text-cyan-500 hover:bg-cyan-900/20'}`}>{isPrepARunning ? 'Stop' : 'Start'}</button>
                                                        <button onClick={() => resetTimer(setPrepA, currentSettings.prepTime, setIsPrepARunning, prepAInterval)} className="px-3 py-1 text-[10px] font-mono uppercase border border-slate-700 text-slate-500 hover:text-slate-300">Rst</button>
                                                    </div>
                                                </div>
                                                {/* Team B */}
                                                <div className="bg-black p-3 border border-slate-800">
                                                    <div className="flex justify-between items-center mb-2">
                                                        <span className="text-[10px] font-bold text-purple-500 uppercase">{currentSettings.teamB} Prep</span>
                                                        <span className={`font-mono font-bold text-xl ${prepB < 30 ? 'text-red-500' : 'text-slate-200'}`}>{formatTime(prepB)}</span>
                                                    </div>
                                                    <div className="flex space-x-2">
                                                        <button onClick={() => toggleTimer(isPrepBRunning, setIsPrepBRunning, prepBInterval, setPrepB)} className={`flex-1 py-1 text-[10px] font-mono uppercase border ${isPrepBRunning ? 'border-amber-500 text-amber-500' : 'border-purple-500 text-purple-500 hover:bg-purple-900/20'}`}>{isPrepBRunning ? 'Stop' : 'Start'}</button>
                                                        <button onClick={() => resetTimer(setPrepB, currentSettings.prepTime, setIsPrepBRunning, prepBInterval)} className="px-3 py-1 text-[10px] font-mono uppercase border border-slate-700 text-slate-500 hover:text-slate-300">Rst</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* Grace / Tech Time - Show for all debates */}
                                    <div className="bg-slate-900/50 p-5 border border-slate-800">
                                        <h3 className="font-bold text-xs text-slate-500 uppercase tracking-widest mb-4 flex items-center">
                                            <AlertCircle className="w-3 h-3 mr-2" /> Grace / Tech
                                        </h3>
                                        <div className="space-y-4">
                                            {/* Team A */}
                                            <div className="bg-black p-3 border border-slate-800">
                                                <div className="flex justify-between items-center mb-2">
                                                    <span className="text-[10px] font-bold text-cyan-500 uppercase">{currentSettings.teamA} Grace</span>
                                                    <span className={`font-mono font-bold text-xl ${graceA < 30 ? 'text-red-500' : 'text-slate-200'}`}>{formatTime(graceA)}</span>
                                                </div>
                                                <div className="flex space-x-2">
                                                    <button onClick={() => toggleTimer(isGraceARunning, setIsGraceARunning, graceAInterval, setGraceA)} className={`flex-1 py-1 text-[10px] font-mono uppercase border ${isGraceARunning ? 'border-amber-500 text-amber-500' : 'border-cyan-500 text-cyan-500 hover:bg-cyan-900/20'}`}>{isGraceARunning ? 'Stop' : 'Start'}</button>
                                                    <button onClick={() => resetTimer(setGraceA, 120, setIsGraceARunning, graceAInterval)} className="px-3 py-1 text-[10px] font-mono uppercase border border-slate-700 text-slate-500 hover:text-slate-300">Rst</button>
                                                </div>
                                            </div>
                                            {/* Team B */}
                                            <div className="bg-black p-3 border border-slate-800">
                                                <div className="flex justify-between items-center mb-2">
                                                    <span className="text-[10px] font-bold text-purple-500 uppercase">{currentSettings.teamB} Grace</span>
                                                    <span className={`font-mono font-bold text-xl ${graceB < 30 ? 'text-red-500' : 'text-slate-200'}`}>{formatTime(graceB)}</span>
                                                </div>
                                                <div className="flex space-x-2">
                                                    <button onClick={() => toggleTimer(isGraceBRunning, setIsGraceBRunning, graceBInterval, setGraceB)} className={`flex-1 py-1 text-[10px] font-mono uppercase border ${isGraceBRunning ? 'border-amber-500 text-amber-500' : 'border-purple-500 text-purple-500 hover:bg-purple-900/20'}`}>{isGraceBRunning ? 'Stop' : 'Start'}</button>
                                                    <button onClick={() => resetTimer(setGraceB, 120, setIsGraceBRunning, graceBInterval)} className="px-3 py-1 text-[10px] font-mono uppercase border border-slate-700 text-slate-500 hover:text-slate-300">Rst</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Resources / Rubric */}
                        <div className="bg-slate-900/50 border border-slate-800">
                            <div className="px-6 py-4 border-b border-slate-800 bg-black">
                                <h3 className="font-bold text-sm text-white uppercase tracking-widest">Judging Resources: {format}</h3>
                            </div>
                            <div className="p-6 prose prose-invert max-w-none font-mono text-sm text-slate-400">
                                <MarkdownRenderer content={rubrics[format] || rubrics['default']} />
                            </div>
                        </div>
                    </div>
                );
            };

            const handleAnalyze = async (isBoardGen = false) => {
                const currentKey = provider === 'gemini' ? apiKey : openaiKey;
                if (!currentKey) { setError(`Please enter a valid ${provider === 'gemini' ? 'Gemini' : 'OpenAI'} API Key.`); return; }
                
                if (!isBoardGen) {
                    if (activeTab === 'speech' && !transcript) { setError('Please enter speech text.'); return; }
                    if (activeTab === 'board' && !boardDescription && boardImages.length === 0) { setError('Please provide images or description.'); return; }
                    if (activeTab === 'listen' && !audioData) { setError('Please record audio first.'); return; }
                    if (activeTab === 'listen' && provider === 'openai') { setError('Live Audio analysis is currently only available with Gemini.'); return; }
                }
                
                setLoading(true);
                setError('');
                setResult(null);

                try {
                    let generatedText = '';
                    const rubric = rubrics[speechType] || rubrics['default'];

                    if (provider === 'gemini') {
                        let payloadParts = [];
                        let systemPrompt = '';
                        
                        // Prompt Construction
                        if (isBoardGen) {
                             systemPrompt = `Act as an expert Debate Coach. For the topic "${topic}" and side "${side}" in ${speechType} format, describe an ideal debate board/flow layout. 
                             Include:
                             1. Strategic grouping of arguments.
                             2. How to use colors/columns effectively.
                             3. A text-based outline of the main content blocks.
                             4. Key "win conditions" to highlight on the board.
                             Do NOT generate an image, just a detailed text description.`;
                             payloadParts = [{ text: systemPrompt }];
                        } else if (activeTab === 'speech') {
                            systemPrompt = `
                                You are an expert Debate Adjudicator for ${speechType}. 
                                Topic: ${topic}. Side: ${side}.
                                
                                Evaluate the following speech based on this rubric:
                                ${rubric}

                                IMPORTANT: Do NOT penalize for missing visual aids, boards, or props, as this is a text-only evaluation.

                                Please provide the output in the following Markdown format:
                                ## Executive Summary
                                (Brief overview of performance)

                                ## Scorecard
                                | Category | Score (0-10) | Notes |
                                | --- | --- | --- |
                                (Fill based on rubric)
                                | **Total** | **(Sum)** | |

                                ## Radar Data
                                (Provide a JSON object with scores for each category, e.g., {"Argumentation": 8, "Delivery": 7, ...})

                                ## Key Argument Analysis
                                (Bullet points on specific arguments made)

                                ## Constructive Feedback
                                - **Strengths**: ...
                                - **Areas for Improvement**: ...

                                ## Recommended Drills
                                (Specific exercises to improve weak areas)

                                SPEECH TEXT:
                                ${transcript}
                            `;
                            payloadParts = [{ text: systemPrompt }];
                        } else if (activeTab === 'board') {
                            systemPrompt = `Expert Debate Coach (Flowing). Evaluate board/flow. Context: ${speechType}, ${side}, Topic: ${topic}. Assess Organization, Grouping, Legibility, Suggestions. User Notes: ${boardDescription}. 
                            
                            Please provide the output in the following Markdown format:
                            ## Executive Summary
                            (Brief overview)

                            ## Scorecard
                            | Category | Score (0-10) | Notes |
                            | --- | --- | --- |
                            | Organization | | |
                            | Grouping | | |
                            | Legibility | | |
                            | Strategy | | |
                            | **Total** | **(Sum)** | |

                            ## Radar Data
                            (Provide a JSON object with scores for each category: {"Organization": 8, "Grouping": 7, "Legibility": 6, "Strategy": 9})

                            ## Detailed Feedback
                            ...
                            `;
                            payloadParts = [{ text: systemPrompt }];
                            boardImages.forEach(img => payloadParts.push({ inlineData: { mimeType: img.mimeType, data: img.raw } }));
                        } else if (activeTab === 'listen') {
                            systemPrompt = `Expert Speech Coach. Listen to audio. Context: ${speechType}, ${side}, Topic: ${topic}. Evaluate: 1. Vocal Delivery (Pace, Tone, Fluency). 2. Content. 3. Score (0-100).
                            
                            Please provide the output in the following Markdown format:
                            ## Executive Summary
                            (Brief overview)

                            ## Scorecard
                            | Category | Score (0-10) | Notes |
                            | --- | --- | --- |
                            | Vocal Delivery | | |
                            | Content | | |
                            | Persuasion | | |
                            | **Total** | **(Sum)** | |

                            ## Radar Data
                            (Provide a JSON object with scores for each category: {"Vocal Delivery": 8, "Content": 7, "Persuasion": 6})

                            ## Detailed Feedback
                            ...
                            `;
                            payloadParts = [{ text: systemPrompt }, { inlineData: { mimeType: audioData.mimeType, data: audioData.raw } }];
                        }

                        // Try Primary Model (Gemini 2.0 Flash Exp), then Fallback (Gemini 1.5 Flash)
                        const modelsToTry = ['gemini-2.0-flash-exp', 'gemini-1.5-flash'];
                        let success = false;

                        for (const model of modelsToTry) {
                            try {
                                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ contents: [{ parts: payloadParts }] })
                                });

                                if (!response.ok) {
                                    // If it's the last model, throw the error
                                    if (model === modelsToTry[modelsToTry.length - 1]) {
                                        const errorData = await response.json().catch(() => ({}));
                                        throw new Error(`Gemini API Error (${model}): ${errorData.error?.message || response.statusText || response.status}`);
                                    }
                                    // Otherwise continue to next model
                                    console.warn(`Model ${model} failed, falling back...`);
                                    continue;
                                }

                                const data = await response.json();
                                generatedText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                                success = true;
                                break; // Exit loop on success
                            } catch (e) {
                                if (model === modelsToTry[modelsToTry.length - 1]) throw e;
                            }
                        }

                    } else if (provider === 'openai') {
                        let messages = [];
                        
                        if (isBoardGen) {
                            messages = [{
                                role: "system", content: "You are an expert Debate Coach."
                            }, {
                                role: "user", content: `For the topic "${topic}" and side "${side}" in ${speechType} format, describe an ideal debate board/flow layout. Include strategic grouping, colors, outline, and win conditions. Text description only.`
                            }];
                        } else if (activeTab === 'speech') {
                            messages = [{
                                role: "system", content: `You are an expert Debate Adjudicator for ${speechType}. Use the following rubric: ${rubric}. IMPORTANT: Do NOT penalize for missing visual aids, boards, or props, as this is a text-only evaluation.`
                            }, {
                                role: "user", content: `
                                    Topic: ${topic}. Side: ${side}.
                                    Evaluate this speech.
                                    
                                    Output Format:
                                    ## Executive Summary
                                    ## Scorecard (Table)
                                    ## Key Argument Analysis
                                    ## Constructive Feedback
                                    ## Recommended Drills

                                    SPEECH: ${transcript}`
                            }];
                        } else if (activeTab === 'board') {
                            const content = [
                                { type: "text", text: `Expert Debate Coach. Evaluate this debate flow/board. Context: ${speechType}, ${side}, Topic: ${topic}. User Notes: ${boardDescription}` }
                            ];
                            boardImages.forEach(img => {
                                content.push({ type: "image_url", image_url: { url: img.url } });
                            });
                            messages = [{ role: "user", content }];
                        }

                        const response = await fetch('https://api.openai.com/v1/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${openaiKey}`
                            },
                            body: JSON.stringify({
                                model: "gpt-4o",
                                messages: messages,
                                max_tokens: 2000
                            })
                        });

                        if (!response.ok) {
                            const errData = await response.json();
                            throw new Error(`OpenAI Error: ${errData.error?.message || response.statusText}`);
                        }
                        const data = await response.json();
                        generatedText = data.choices[0].message.content;
                    }

                    if (generatedText) {
                        setResult(generatedText);
                        
                        // Parse Radar Data
                        try {
                            const radarMatch = generatedText.match(/## Radar Data\s*\n\s*({[\s\S]*?})/);
                            if (radarMatch && radarMatch[1]) {
                                const parsed = JSON.parse(radarMatch[1]);
                                const transformed = Object.keys(parsed).map(key => ({
                                    subject: key,
                                    A: parsed[key],
                                    fullMark: 10
                                }));
                                setRadarData(transformed);
                            } else {
                                setRadarData(null);
                            }
                        } catch (e) {
                            console.error("Error parsing radar data", e);
                            setRadarData(null);
                        }

                        let inputData = null;
                        if (activeTab === 'speech') inputData = transcript;
                        else if (activeTab === 'listen') inputData = audioData;
                        else if (activeTab === 'board') inputData = { description: boardDescription, images: boardImages };
                        
                        addToHistory(generatedText, isBoardGen ? 'Strategy Gen' : activeTab, inputData);
                    } else {
                        throw new Error('No analysis returned.');
                    }

                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            // Render UI
            return (
                <div className="flex min-h-screen bg-slate-950 text-slate-300 font-mono selection:bg-cyan-900 selection:text-cyan-100 overflow-hidden">
                    {/* Sidebar */}
                    <Sidebar 
                        activeTab={activeTab} 
                        setActiveTab={setActiveTab} 
                        theme={theme} 
                        setTheme={setTheme} 
                        user={user} 
                        logout={logout} 
                        setShowLogin={setShowLogin}
                        isOpen={isSidebarOpen}
                        setIsOpen={setIsSidebarOpen}
                    />

                    {/* Main Content */}
                    <main className="flex-1 ml-16 h-screen overflow-hidden flex flex-col relative">
                        {/* Command Header */}
                        <header className="h-14 bg-slate-950 border-b border-slate-800 flex items-center justify-between px-6 shrink-0 z-20">
                             <div className="flex items-center space-x-4">
                                <div className="flex items-center text-cyan-500 space-x-2">
                                    <Activity className="w-4 h-4 animate-pulse" />
                                    <span className="text-xs font-bold tracking-[0.2em] uppercase">Adjudicator Ready</span>
                                </div>
                                <div className="h-4 w-px bg-slate-800"></div>
                                <h2 className="text-sm font-bold text-slate-100 uppercase tracking-widest">
                                    {activeTab === 'speech' ? 'Speech Analysis' : 
                                     activeTab === 'board' ? 'Flow Evaluation' : 
                                     activeTab === 'listen' ? 'Live Coaching' : 
                                     activeTab === 'strategy' ? 'Board Generator' :
                                     activeTab}
                                </h2>
                             </div>
                             <div className="flex items-center space-x-6">
                                <div className="hidden md:flex items-center space-x-4 text-xs text-slate-500 font-mono">
                                    <span>CPU: <span className="text-green-400">12%</span></span>
                                    <span>MEM: <span className="text-green-400">4.2GB</span></span>
                                    <span>NET: <span className="text-green-400">1.2Gbps</span></span>
                                </div>
                                <div className="h-4 w-px bg-slate-800"></div>
                                {user ? (
                                    <div className="flex items-center space-x-3">
                                        <div className="text-right hidden sm:block">
                                            <div className="text-xs font-bold text-cyan-400 uppercase">{user.username || 'User'}</div>
                                            <div className="text-[10px] text-slate-500 uppercase tracking-wider">Pro Account</div>
                                        </div>
                                        <div className="w-8 h-8 rounded bg-slate-900 border border-slate-700 flex items-center justify-center text-cyan-500 font-bold">
                                            {(user.username || user.email)[0].toUpperCase()}
                                        </div>
                                        <button onClick={logout} className="text-slate-500 hover:text-red-500 transition-colors"><LogOut className="w-4 h-4" /></button>
                                    </div>
                                ) : (
                                    <button onClick={() => setShowLogin(true)} className="text-xs font-bold text-cyan-500 hover:text-cyan-400 uppercase tracking-wider border border-cyan-900 hover:border-cyan-500 px-4 py-1.5 rounded transition-all">Sign In</button>
                                )}
                             </div>
                        </header>

                        <div className="flex-1 overflow-hidden relative">
                            {activeTab === 'dashboard' && (
                                <div className="h-full overflow-y-auto p-6">
                                    <Dashboard 
                                        user={user} 
                                        history={history} 
                                        setActiveTab={setActiveTab} 
                                        provider={provider}
                                        apiKey={apiKey}
                                        openaiKey={openaiKey}
                                    />
                                </div>
                            )}

                            {activeTab === 'coach' && (
                                <div className="h-full overflow-y-auto p-6">
                                    <CoachTools speechTimes={speechTimes} rubrics={rubrics} />
                                </div>
                            )}

                            {['speech', 'board', 'listen', 'strategy'].includes(activeTab) && (
                                <div className="flex flex-col lg:flex-row h-full">
                                    {/* LEFT PANE - DATA INGESTION */}
                                    <div className="w-full lg:w-5/12 flex flex-col border-r border-slate-800 bg-black relative z-10">
                                        
                                        {/* Control Panel */}
                                        <div className="p-4 border-b border-slate-800 bg-slate-950/50">
                                            <div className="grid grid-cols-2 gap-4 mb-4">
                                                <div>
                                                    <label className="block text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Format</label>
                                                    <div className="relative">
                                                        <select className="w-full appearance-none bg-black border border-slate-700 text-cyan-400 py-2 px-3 text-xs font-mono uppercase outline-none focus:border-cyan-500 transition-colors cursor-pointer" value={speechType} onChange={(e) => setSpeechType(e.target.value)}>
                                                            {speechTypes.map(t => <option key={t} value={t}>{t}</option>)}
                                                        </select>
                                                        <div className="absolute right-2 top-2.5 pointer-events-none">
                                                            <div className="w-0 h-0 border-l-[4px] border-l-transparent border-r-[4px] border-r-transparent border-t-[4px] border-t-cyan-500"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div>
                                                    <label className="block text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Side</label>
                                                    <div className="relative">
                                                        <select className="w-full appearance-none bg-black border border-slate-700 text-cyan-400 py-2 px-3 text-xs font-mono uppercase outline-none focus:border-cyan-500 transition-colors cursor-pointer" value={side} onChange={(e) => setSide(e.target.value)}>
                                                            {sides.map(s => <option key={s} value={s}>{s}</option>)}
                                                        </select>
                                                        <div className="absolute right-2 top-2.5 pointer-events-none">
                                                            <div className="w-0 h-0 border-l-[4px] border-l-transparent border-r-[4px] border-r-transparent border-t-[4px] border-t-cyan-500"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="relative">
                                                <span className="absolute left-3 top-2.5 text-slate-600 font-mono text-xs">{'>'}</span>
                                                <input type="text" placeholder="Enter Topic / Resolution..." className="w-full bg-black border border-slate-700 text-green-400 py-2 pl-8 pr-3 text-xs font-mono focus:border-green-500 outline-none placeholder:text-slate-700 uppercase" value={topic} onChange={(e) => setTopic(e.target.value)} />
                                            </div>
                                        </div>

                                        {/* Input Terminal */}
                                        <div className="flex-1 overflow-y-auto relative custom-scrollbar bg-black p-1">
                                            {activeTab === 'strategy' && (
                                                <div className="h-full flex flex-col items-center justify-center p-6 text-center space-y-4">
                                                    <div className="w-24 h-24 bg-slate-900/50 border border-slate-800 rounded-full flex items-center justify-center">
                                                        <Zap className="w-10 h-10 text-yellow-500" />
                                                    </div>
                                                    <div>
                                                        <h3 className="text-lg font-bold text-white uppercase tracking-widest">Strategy Generator</h3>
                                                        <p className="text-slate-500 font-mono text-xs mt-2 max-w-xs mx-auto">Enter your topic, format, and side above, then click Generate to receive a detailed flow strategy.</p>
                                                    </div>
                                                </div>
                                            )}
                                            {activeTab === 'speech' && (
                                                <textarea 
                                                    className="w-full h-full p-4 bg-black text-green-400 font-mono text-xs leading-relaxed outline-none resize-none placeholder:text-slate-800" 
                                                    placeholder="// Paste speech transcript here..." 
                                                    value={transcript} 
                                                    onChange={(e) => setTranscript(e.target.value)} 
                                                    spellCheck="false"
                                                />
                                            )}
                                            {activeTab === 'board' && (
                                                <div className="p-6 space-y-6">
                                                    {boardImages.length === 0 ? (
                                                        <div className="border border-dashed border-slate-700 bg-slate-900/20 p-12 text-center hover:bg-slate-900/40 cursor-pointer transition-colors group" onClick={() => fileInputRef.current?.click()}>
                                                            <Upload className="w-12 h-12 text-slate-600 group-hover:text-cyan-500 mb-4 mx-auto transition-colors" />
                                                            <p className="text-xs text-slate-500 font-mono uppercase tracking-widest">Upload Flow Sheets</p>
                                                        </div>
                                                    ) : (
                                                        <div className="grid grid-cols-2 gap-4">
                                                            {boardImages.map((img, idx) => (
                                                                <div key={img.id} className="relative border border-slate-700 bg-slate-900 p-1 group">
                                                                    <div className="absolute top-0 left-0 px-2 py-1 text-[10px] font-bold bg-cyan-900/50 text-cyan-400 border-b border-r border-slate-700 z-10">Image {idx + 1}</div>
                                                                    <img src={img.url} alt="" className="w-full h-32 object-cover opacity-80 group-hover:opacity-100 transition-opacity grayscale group-hover:grayscale-0" />
                                                                    <button onClick={() => removeImage(img.id)} className="absolute top-1 right-1 text-red-500 hover:text-red-400"><X className="w-4 h-4" /></button>
                                                                </div>
                                                            ))}
                                                            <div onClick={() => fileInputRef.current?.click()} className="flex items-center justify-center h-32 border border-dashed border-slate-700 cursor-pointer hover:border-cyan-500/50 transition-colors">
                                                                <Plus className="w-6 h-6 text-slate-600" />
                                                            </div>
                                                        </div>
                                                    )}
                                                    <input type="file" multiple ref={fileInputRef} className="hidden" accept="image/*" onChange={handleImageUpload} />
                                                    <textarea className="w-full h-32 p-3 bg-black border border-slate-700 text-green-400 font-mono text-xs outline-none focus:border-green-500 transition-colors resize-none" placeholder="// Add context notes..." value={boardDescription} onChange={(e) => setBoardDescription(e.target.value)} />
                                                </div>
                                            )}
                                            {activeTab === 'listen' && (
                                                <div className="h-full flex flex-col items-center justify-center p-6 space-y-8">
                                                    <div className="w-full max-w-md border border-slate-700 bg-slate-900/30 p-6 relative overflow-hidden">
                                                        <div className="absolute top-0 left-0 w-2 h-2 border-t border-l border-cyan-500"></div>
                                                        <div className="absolute top-0 right-0 w-2 h-2 border-t border-r border-cyan-500"></div>
                                                        <div className="absolute bottom-0 left-0 w-2 h-2 border-b border-l border-cyan-500"></div>
                                                        <div className="absolute bottom-0 right-0 w-2 h-2 border-b border-r border-cyan-500"></div>
                                                        
                                                        <div className="text-center mb-6">
                                                            <div className="text-xs font-mono text-cyan-500 mb-2 uppercase tracking-widest">Audio Recorder</div>
                                                            <div className="text-4xl font-mono font-bold text-white tracking-tighter">
                                                                {formatTime(recordingTime)}
                                                            </div>
                                                        </div>

                                                        <div className="h-24 bg-black border border-slate-800 flex items-center justify-center mb-6 relative overflow-hidden">
                                                            {isRecording ? (
                                                                <AudioVisualizer analyser={analyser} isRecording={isRecording} />
                                                            ) : (
                                                                <div className="text-[10px] text-slate-600 font-mono uppercase">No Audio</div>
                                                            )}
                                                            <div className="absolute inset-0 bg-[linear-gradient(rgba(16,185,129,0.05)_1px,transparent_1px),linear-gradient(90deg,rgba(16,185,129,0.05)_1px,transparent_1px)] bg-[size:20px_20px] pointer-events-none"></div>
                                                        </div>

                                                        <div className="flex justify-center">
                                                            <button 
                                                                onClick={isRecording ? stopRecording : startRecording}
                                                                className={`w-16 h-16 rounded-full flex items-center justify-center border-2 transition-all ${isRecording ? 'border-red-500 bg-red-500/10 text-red-500 animate-pulse' : 'border-cyan-500 bg-cyan-500/10 text-cyan-500 hover:bg-cyan-500/20'}`}
                                                            >
                                                                {isRecording ? <Square className="w-6 h-6 fill-current" /> : <Mic className="w-6 h-6" />}
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                        </div>

                                        {/* Action Footer */}
                                        <div className="p-4 border-t border-slate-800 bg-slate-950">
                                            {error && (
                                                <div className="mb-3 text-[10px] text-red-400 font-mono border border-red-900/50 bg-red-900/10 p-2 flex items-center">
                                                    <AlertCircle className="w-3 h-3 mr-2" /> {error}
                                                </div>
                                            )}
                                            <button onClick={() => handleAnalyze(activeTab === 'strategy')} disabled={loading} className={`w-full flex items-center justify-center px-6 py-3 font-bold text-xs uppercase tracking-widest transition-all border ${loading ? 'bg-slate-900 border-slate-700 text-slate-500 cursor-not-allowed' : 'bg-cyan-900/20 border-cyan-500 text-cyan-400 hover:bg-cyan-500 hover:text-black'}`}>
                                                {loading ? <><Loader2 className="w-4 h-4 mr-2 animate-spin" /> Processing...</> : <><Send className="w-4 h-4 mr-2" /> {activeTab === 'strategy' ? 'Generate Strategy' : 'Analyze Speech'}</>}
                                            </button>
                                        </div>
                                    </div>

                                    {/* RIGHT PANE - ANALYSIS TERMINAL */}
                                    <div className="w-full lg:w-7/12 overflow-y-auto bg-slate-950 p-6 lg:p-10 relative custom-scrollbar">
                                        {/* Background Grid */}
                                        <div className="absolute inset-0 bg-[linear-gradient(rgba(30,41,59,0.2)_1px,transparent_1px),linear-gradient(90deg,rgba(30,41,59,0.2)_1px,transparent_1px)] bg-[size:40px_40px] pointer-events-none"></div>

                                        {result ? (
                                            <div className="max-w-4xl mx-auto space-y-8 relative z-10 animate-in slide-in-from-bottom-4 duration-500">
                                                {/* Radar Hologram */}
                                                {radarData && (
                                                    <div className="border border-slate-800 bg-slate-900/50 p-6 relative overflow-hidden">
                                                        <div className="absolute top-0 left-0 w-2 h-2 border-t border-l border-cyan-500"></div>
                                                        <div className="absolute top-0 right-0 w-2 h-2 border-t border-r border-cyan-500"></div>
                                                        <div className="absolute bottom-0 left-0 w-2 h-2 border-b border-l border-cyan-500"></div>
                                                        <div className="absolute bottom-0 right-0 w-2 h-2 border-b border-r border-cyan-500"></div>
                                                        
                                                        <h3 className="text-xs font-bold text-cyan-500 uppercase tracking-widest mb-6 text-center border-b border-slate-800 pb-2">Skills Radar</h3>
                                                        <div className="h-64 w-full">
                                                            <ResponsiveContainer width="100%" height="100%">
                                                                <RadarChart cx="50%" cy="50%" outerRadius="70%" data={radarData}>
                                                                    <PolarGrid stroke="#1e293b" />
                                                                    <PolarAngleAxis dataKey="subject" tick={{ fill: '#94a3b8', fontSize: 10, fontFamily: 'monospace' }} />
                                                                    <PolarRadiusAxis angle={30} domain={[0, 10]} tick={false} axisLine={false} />
                                                                    <Radar name="Score" dataKey="A" stroke="#06b6d4" strokeWidth={2} fill="#06b6d4" fillOpacity={0.2} />
                                                                </RadarChart>
                                                            </ResponsiveContainer>
                                                        </div>
                                                    </div>
                                                )}
                                                
                                                {/* Analysis Output */}
                                                <div className="border border-slate-800 bg-black p-8 relative">
                                                    <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-cyan-500 via-purple-500 to-cyan-500 opacity-50"></div>
                                                    <div className="prose prose-invert max-w-none font-mono text-sm leading-loose text-slate-300">
                                                        <MarkdownRenderer content={result} />
                                                    </div>
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="h-full flex flex-col items-center justify-center text-slate-600 opacity-50">
                                                <div className="w-32 h-32 border border-slate-800 rounded-full flex items-center justify-center mb-6 animate-pulse">
                                                    <Activity className="w-12 h-12" />
                                                </div>
                                                <p className="text-xs font-mono uppercase tracking-widest">Ready for Input</p>
                                                <p className="text-[10px] font-mono mt-2">Enter data to begin</p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                            
                            {activeTab === 'contact' && (
                                <div className="p-12 flex justify-center">
                                    <div className="max-w-md w-full border border-slate-800 bg-slate-900/50 p-8 text-center">
                                        <Mail className="w-12 h-12 text-cyan-500 mx-auto mb-4" />
                                        <h3 className="text-lg font-bold text-white uppercase tracking-widest mb-2">Contact Support</h3>
                                        <p className="text-slate-400 font-mono text-sm mb-6">adjucatorai@gmail.com</p>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'settings' && (
                                <div className="p-12 flex justify-center">
                                    <div className="max-w-lg w-full border border-slate-800 bg-slate-900/50 p-8">
                                        <h3 className="text-lg font-bold text-white uppercase tracking-widest mb-6 border-b border-slate-800 pb-4">Settings</h3>
                                        
                                        <div className="space-y-6">
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 uppercase mb-2">AI Model</label>
                                                <div className="flex space-x-4">
                                                    <button onClick={() => setProvider('gemini')} className={`flex-1 py-2 border ${provider === 'gemini' ? 'border-cyan-500 text-cyan-400 bg-cyan-900/20' : 'border-slate-700 text-slate-500'} text-xs font-mono uppercase transition-all`}>Gemini</button>
                                                    <button onClick={() => setProvider('openai')} className={`flex-1 py-2 border ${provider === 'openai' ? 'border-cyan-500 text-cyan-400 bg-cyan-900/20' : 'border-slate-700 text-slate-500'} text-xs font-mono uppercase transition-all`}>OpenAI</button>
                                                </div>
                                            </div>

                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 uppercase mb-2">API Key</label>
                                                <div className="flex space-x-2">
                                                    <input type="password" className="flex-1 bg-black border border-slate-700 text-slate-300 px-3 py-2 text-xs font-mono outline-none focus:border-cyan-500" value={provider === 'gemini' ? apiKey : openaiKey} onChange={(e) => provider === 'gemini' ? setApiKey(e.target.value) : setOpenaiKey(e.target.value)} placeholder="••••••••••••••••" />
                                                    <button onClick={() => verifyAndSaveKey(provider, provider === 'gemini' ? apiKey : openaiKey)} className="px-4 py-2 bg-cyan-900/20 border border-cyan-500 text-cyan-400 text-xs font-bold uppercase hover:bg-cyan-500 hover:text-black transition-all">Save</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'profile' && (
                                <div className="p-12 flex justify-center animate-in fade-in slide-in-from-bottom-4 duration-500">
                                    <div className="max-w-lg w-full border border-slate-800 bg-slate-900/50 p-8 relative">
                                        <button onClick={() => setActiveTab('dashboard')} className="absolute top-4 right-4 text-slate-500 hover:text-white">
                                            <X className="w-5 h-5" />
                                        </button>
                                        
                                        <div className="text-center mb-8">
                                            <div className="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4 border-2 border-cyan-500 shadow-[0_0_15px_rgba(6,182,212,0.3)]">
                                                <span className="text-3xl font-mono text-cyan-500 font-bold">
                                                    {(user?.username || user?.email || '?')[0].toUpperCase()}
                                                </span>
                                            </div>
                                            <h2 className="text-xl font-bold text-white uppercase tracking-widest">{user?.username || 'Guest Operative'}</h2>
                                            <p className="text-slate-500 font-mono text-xs">{user?.email || 'Local Session'}</p>
                                            {user?.isAdmin && <span className="inline-block mt-2 px-2 py-0.5 bg-cyan-900/30 border border-cyan-500/50 text-cyan-400 text-[10px] font-bold uppercase tracking-wider rounded">Administrator</span>}
                                        </div>

                                        <div className="grid grid-cols-2 gap-4 mb-8">
                                            <div className="bg-black border border-slate-800 p-4 text-center group hover:border-slate-600 transition-colors">
                                                <div className="text-2xl font-bold text-white font-mono">{history.length}</div>
                                                <div className="text-[10px] text-slate-500 uppercase tracking-widest mt-1 group-hover:text-cyan-500 transition-colors">Total Sessions</div>
                                            </div>
                                            <div className="bg-black border border-slate-800 p-4 text-center group hover:border-slate-600 transition-colors">
                                                <div className="text-2xl font-bold text-white font-mono">
                                                    {(() => {
                                                        if (!history || history.length === 0) return 'N/A';
                                                        let total = 0;
                                                        let count = 0;
                                                        history.forEach(h => {
                                                            const content = h.result || h.content || '';
                                                            const match = content.match(/\|\s*\*\*Total\*\*\s*\|\s*\*\*(\d+)\*\*\s*\|/) || content.match(/Score:\s*(\d+)/i);
                                                            if (match && match[1]) {
                                                                total += parseInt(match[1]);
                                                                count++;
                                                            }
                                                        });
                                                        return count > 0 ? Math.round(total / count) : 'N/A';
                                                    })()}
                                                </div>
                                                <div className="text-[10px] text-slate-500 uppercase tracking-widest mt-1 group-hover:text-amber-500 transition-colors">Avg Score</div>
                                            </div>
                                        </div>

                                        <div className="space-y-3">
                                            {user ? (
                                                <button onClick={logout} className="w-full py-3 border border-red-900/50 text-red-500 hover:bg-red-900/20 hover:border-red-500 font-bold text-xs uppercase tracking-widest transition-all flex items-center justify-center">
                                                    <LogOut className="w-4 h-4 mr-2" /> Sign Out
                                                </button>
                                            ) : (
                                                <button onClick={() => setShowLogin(true)} className="w-full py-3 bg-cyan-600 hover:bg-cyan-500 text-black font-bold text-xs uppercase tracking-widest transition-colors flex items-center justify-center">
                                                    Sign In / Register
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'history' && (
                                <div className="p-6 h-full overflow-y-auto">
                                    <div className="max-w-4xl mx-auto">
                                        <div className="flex justify-between items-center mb-6 border-b border-slate-800 pb-4">
                                            <h3 className="text-lg font-bold text-white uppercase tracking-widest">History</h3>
                                            {history.length > 0 && (
                                                <button onClick={clearHistory} className="text-red-500 text-xs font-mono uppercase hover:text-red-400 flex items-center">
                                                    <Trash2 className="w-3 h-3 mr-1" /> Clear All
                                                </button>
                                            )}
                                        </div>
                                        <div className="space-y-2">
                                            {history.map((item) => (
                                                <div key={item.id} onClick={() => { 
                                                    setResult(item.result || item.content); 
                                                    setTopic(item.topic);
                                                    if (item.type === 'speech' || item.type === 'Judge Text') {
                                                        setTranscript(typeof item.input === 'string' ? item.input : '');
                                                        setActiveTab('speech');
                                                    } else if (item.type === 'listen' || item.type === 'Live Coach') {
                                                        if (item.input && item.input.raw) setAudioData(item.input);
                                                        setActiveTab('listen');
                                                    } else if (item.type === 'board' || item.type === 'Evaluate Board') {
                                                        if (item.input) {
                                                            setBoardDescription(item.input.description || '');
                                                            setBoardImages(item.input.images || []);
                                                        }
                                                        setActiveTab('board');
                                                    }
                                                }} className="bg-slate-900/30 border border-slate-800 p-4 cursor-pointer hover:border-cyan-500/50 hover:bg-slate-900/50 transition-all group">
                                                    <div className="flex justify-between items-start">
                                                        <div>
                                                            <span className="text-[10px] font-bold text-cyan-500 uppercase tracking-wider border border-cyan-900/50 px-1.5 py-0.5 bg-cyan-900/10">{item.type}</span>
                                                            <h4 className="text-sm font-mono text-slate-300 mt-2 group-hover:text-white">{item.topic}</h4>
                                                        </div>
                                                        <span className="text-[10px] text-slate-600 font-mono">{new Date(item.date).toLocaleDateString()}</span>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>

                    {/* Modals (Login, etc) - Simplified for Dark Mode */}
                    {showLogin && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
                            <div className="bg-slate-950 border border-slate-700 max-w-md w-full p-8 relative">
                                <button onClick={() => setShowLogin(false)} className="absolute top-4 right-4 text-slate-500 hover:text-white"><X className="w-5 h-5" /></button>
                                <div className="text-center mb-8">
                                    <div className="w-12 h-12 bg-cyan-900/20 border border-cyan-500/50 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <User className="w-6 h-6 text-cyan-500" />
                                    </div>
                                    <h2 className="text-xl font-bold text-white uppercase tracking-widest">Login</h2>
                                </div>
                                
                                <form onSubmit={handleAuth} className="space-y-4">
                                    {authMode === 'signup' && (
                                        <input type="text" placeholder="Username" className="w-full bg-black border border-slate-700 text-white px-4 py-3 text-xs font-mono outline-none focus:border-cyan-500" value={authUsername} onChange={(e) => setAuthUsername(e.target.value)} />
                                    )}
                                    <input type="email" placeholder="Email" className="w-full bg-black border border-slate-700 text-white px-4 py-3 text-xs font-mono outline-none focus:border-cyan-500" value={authEmail} onChange={(e) => setAuthEmail(e.target.value)} />
                                    <input type="password" placeholder="Password" className="w-full bg-black border border-slate-700 text-white px-4 py-3 text-xs font-mono outline-none focus:border-cyan-500" value={authPassword} onChange={(e) => setAuthPassword(e.target.value)} />
                                    
                                    {authError && <div className="text-red-500 text-xs text-center">{authError}</div>}

                                    <button type="submit" className="w-full py-3 bg-cyan-600 hover:bg-cyan-500 text-black font-bold text-xs uppercase tracking-widest transition-colors">
                                        {authMode === 'login' ? 'Sign In' : 'Create Account'}
                                    </button>
                                </form>

                                <div className="mt-4">
                                    <button onClick={handleGoogleLogin} className="w-full py-3 bg-white hover:bg-slate-200 text-black font-bold text-xs uppercase tracking-widest transition-colors flex items-center justify-center">
                                        <svg className="w-4 h-4 mr-2" viewBox="0 0 24 24">
                                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
                                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
                                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" />
                                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
                                        </svg>
                                        Sign in with Google
                                    </button>
                                </div>
                                
                                <div className="mt-6 text-center">
                                    <button onClick={() => setAuthMode(authMode === 'login' ? 'signup' : 'login')} className="text-xs text-slate-500 hover:text-cyan-400 uppercase tracking-wider">
                                        {authMode === 'login' ? 'Switch to Sign Up' : 'Return to Login'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>