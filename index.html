<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adjudicator AI</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Configuration for Dark Mode -->
    <script>
        tailwind.config = {
            darkMode: 'class', // or 'media'
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>

    <!-- React & ReactDOM via ESM -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>
    
    <!-- Babel for JSX translation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDKs (Modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, sendEmailVerification } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- PASTE YOUR FIREBASE CONFIG HERE ---
        const firebaseConfig = {
            apiKey: "AIzaSyAgGkHhRcdGatNvRsm5BQv_RerjG8qt70M",
            authDomain: "adjucator-ai.firebaseapp.com",
            projectId: "adjucator-ai",
            storageBucket: "adjucator-ai.firebasestorage.app",
            messagingSenderId: "82725691768",
            appId: "1:82725691768:web:6186a5b41b8a0aa1e7688d",
            measurementId: "G-N92VEHSKDE"
        };
        // ---------------------------------------

        const app = initializeApp(firebaseConfig);
        window.auth = getAuth(app);
        window.db = getFirestore(app);
        window.googleProvider = new GoogleAuthProvider();
        window.firebaseAuth = { createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInWithPopup, sendEmailVerification };
        window.firebaseDb = { doc, setDoc, getDoc, updateDoc, arrayUnion };
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Hide scrollbar for cleaner UI */
        textarea::-webkit-scrollbar { width: 8px; }
        textarea::-webkit-scrollbar-track { background: transparent; }
        textarea::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }

        /* --- Theme: Forest --- */
        .theme-forest body { background-color: #1c2321 !important; color: #e8f5e9 !important; }
        
        /* Backgrounds */
        .theme-forest .bg-white, .theme-forest .bg-slate-50, .theme-forest .bg-slate-100, .theme-forest .bg-slate-200, .theme-forest .bg-slate-800, .theme-forest .bg-slate-900 {
            background-color: #2d3b36 !important;
            border-color: #4a5d55 !important;
            color: #e8f5e9 !important;
        }
        .theme-forest .bg-indigo-50 { background-color: rgba(46, 125, 50, 0.1) !important; }
        .theme-forest .bg-indigo-100 { background-color: rgba(46, 125, 50, 0.2) !important; }
        .theme-forest .bg-purple-100 { background-color: rgba(0, 105, 92, 0.2) !important; }
        .theme-forest .bg-amber-100 { background-color: rgba(249, 168, 37, 0.2) !important; }
        .theme-forest .bg-blue-100 { background-color: rgba(2, 119, 189, 0.2) !important; }
        
        /* Text */
        .theme-forest .text-slate-900, .theme-forest .text-slate-800, .theme-forest .text-slate-700, .theme-forest .text-slate-600, .theme-forest .text-slate-500, .theme-forest .text-slate-400 { color: #b8cbb8 !important; }
        .theme-forest .text-indigo-600, .theme-forest .text-indigo-500, .theme-forest .text-indigo-700 { color: #76c893 !important; }
        .theme-forest .text-purple-600 { color: #4db6ac !important; }
        .theme-forest .text-blue-600 { color: #4dd0e1 !important; }
        .theme-forest .text-amber-600 { color: #dce775 !important; }
        
        /* Inputs & Generic Buttons */
        .theme-forest button:not([class*="bg-indigo-"]):not([class*="bg-red-"]):not([class*="bg-gradient-"]), 
        .theme-forest input, .theme-forest select, .theme-forest textarea {
            background-color: #1c2321 !important;
            border-color: #4a5d55 !important;
            color: #e8f5e9 !important;
        }

        /* Primary Actions & Gradients */
        .theme-forest .bg-indigo-600 { background-color: #2e7d32 !important; }
        .theme-forest .hover\:bg-indigo-700:hover { background-color: #1b5e20 !important; }
        .theme-forest .from-indigo-600 { --tw-gradient-from: #2e7d32 !important; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to) !important; }
        .theme-forest .to-purple-600 { --tw-gradient-to: #00695c !important; }
        .theme-forest .bg-gradient-to-r { background-image: linear-gradient(to right, var(--tw-gradient-from), var(--tw-gradient-to)) !important; }
        
        /* Shadows */
        .theme-forest .shadow-indigo-500\/30 { --tw-shadow-color: rgba(46, 125, 50, 0.3) !important; box-shadow: var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow) !important; }
        
        /* Borders */
        .theme-forest .border-slate-100, .theme-forest .border-slate-200, .theme-forest .border-slate-300, .theme-forest .border-slate-700, .theme-forest .border-indigo-100 {
            border-color: #4a5d55 !important;
        }


        /* --- Theme: Coffee --- */
        .theme-coffee body { background-color: #2b2118 !important; color: #dcc8b3 !important; }
        
        /* Backgrounds */
        .theme-coffee .bg-white, .theme-coffee .bg-slate-50, .theme-coffee .bg-slate-100, .theme-coffee .bg-slate-200, .theme-coffee .bg-slate-800, .theme-coffee .bg-slate-900 {
            background-color: #3d2f24 !important;
            border-color: #5c4738 !important;
            color: #dcc8b3 !important;
        }
        .theme-coffee .bg-indigo-50 { background-color: rgba(210, 105, 30, 0.1) !important; }
        .theme-coffee .bg-indigo-100 { background-color: rgba(210, 105, 30, 0.2) !important; }
        .theme-coffee .bg-purple-100 { background-color: rgba(160, 82, 45, 0.2) !important; }
        .theme-coffee .bg-amber-100 { background-color: rgba(218, 165, 32, 0.2) !important; }
        .theme-coffee .bg-blue-100 { background-color: rgba(139, 69, 19, 0.2) !important; }

        /* Text */
        .theme-coffee .text-slate-900, .theme-coffee .text-slate-800, .theme-coffee .text-slate-700, .theme-coffee .text-slate-600, .theme-coffee .text-slate-500, .theme-coffee .text-slate-400 { color: #a69076 !important; }
        .theme-coffee .text-indigo-600, .theme-coffee .text-indigo-500, .theme-coffee .text-indigo-700 { color: #d2691e !important; }
        .theme-coffee .text-purple-600 { color: #cd853f !important; }
        .theme-coffee .text-blue-600 { color: #8d6e63 !important; }
        .theme-coffee .text-amber-600 { color: #ffb74d !important; }

        /* Inputs & Generic Buttons */
        .theme-coffee button:not([class*="bg-indigo-"]):not([class*="bg-red-"]):not([class*="bg-gradient-"]), 
        .theme-coffee input, .theme-coffee select, .theme-coffee textarea {
            background-color: #2b2118 !important;
            border-color: #5c4738 !important;
            color: #dcc8b3 !important;
        }

        /* Primary Actions & Gradients */
        .theme-coffee .bg-indigo-600 { background-color: #8b4513 !important; }
        .theme-coffee .hover\:bg-indigo-700:hover { background-color: #5e2f0d !important; }
        .theme-coffee .from-indigo-600 { --tw-gradient-from: #8b4513 !important; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to) !important; }
        .theme-coffee .to-purple-600 { --tw-gradient-to: #a0522d !important; }
        .theme-coffee .bg-gradient-to-r { background-image: linear-gradient(to right, var(--tw-gradient-from), var(--tw-gradient-to)) !important; }

        /* Shadows */
        .theme-coffee .shadow-indigo-500\/30 { --tw-shadow-color: rgba(139, 69, 19, 0.3) !important; box-shadow: var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow) !important; }

        /* Borders */
        .theme-coffee .border-slate-100, .theme-coffee .border-slate-200, .theme-coffee .border-slate-300, .theme-coffee .border-slate-700, .theme-coffee .border-indigo-100 {
            border-color: #5c4738 !important;
        }

        /* --- Theme: Ocean --- */
        .theme-ocean body { background-color: #0f172a !important; color: #e2e8f0 !important; }
        .theme-ocean .bg-white, .theme-ocean .bg-slate-50, .theme-ocean .bg-slate-100, .theme-ocean .bg-slate-200, .theme-ocean .bg-slate-800, .theme-ocean .bg-slate-900 {
            background-color: #1e293b !important;
            border-color: #334155 !important;
            color: #e2e8f0 !important;
        }
        .theme-ocean .text-slate-900, .theme-ocean .text-slate-800, .theme-ocean .text-slate-700, .theme-ocean .text-slate-600, .theme-ocean .text-slate-500, .theme-ocean .text-slate-400 { color: #94a3b8 !important; }
        .theme-ocean .text-indigo-600, .theme-ocean .text-indigo-500, .theme-ocean .text-indigo-700 { color: #38bdf8 !important; } /* Sky Blue */
        .theme-ocean .bg-indigo-600 { background-color: #0ea5e9 !important; }
        .theme-ocean .hover\:bg-indigo-700:hover { background-color: #0284c7 !important; }
        .theme-ocean .from-indigo-600 { --tw-gradient-from: #0ea5e9 !important; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to) !important; }
        .theme-ocean .to-purple-600 { --tw-gradient-to: #6366f1 !important; }
        .theme-ocean .bg-gradient-to-r { background-image: linear-gradient(to right, var(--tw-gradient-from), var(--tw-gradient-to)) !important; }
        .theme-ocean .border-slate-100, .theme-ocean .border-slate-200, .theme-ocean .border-slate-300, .theme-ocean .border-slate-700, .theme-ocean .border-indigo-100 { border-color: #334155 !important; }
        .theme-ocean input, .theme-ocean select, .theme-ocean textarea { background-color: #0f172a !important; border-color: #334155 !important; color: #e2e8f0 !important; }
        .theme-ocean button:not([class*="bg-indigo-"]):not([class*="bg-red-"]):not([class*="bg-gradient-"]) { background-color: #1e293b !important; border-color: #334155 !important; color: #e2e8f0 !important; }

        /* --- Theme: Midnight --- */
        .theme-midnight body { background-color: #000000 !important; color: #e5e5e5 !important; }
        .theme-midnight .bg-white, .theme-midnight .bg-slate-50, .theme-midnight .bg-slate-100, .theme-midnight .bg-slate-200, .theme-midnight .bg-slate-800, .theme-midnight .bg-slate-900 {
            background-color: #171717 !important;
            border-color: #404040 !important;
            color: #e5e5e5 !important;
        }
        .theme-midnight .text-slate-900, .theme-midnight .text-slate-800, .theme-midnight .text-slate-700, .theme-midnight .text-slate-600, .theme-midnight .text-slate-500, .theme-midnight .text-slate-400 { color: #a3a3a3 !important; }
        .theme-midnight .text-indigo-600, .theme-midnight .text-indigo-500, .theme-midnight .text-indigo-700 { color: #818cf8 !important; } /* Indigo */
        .theme-midnight .bg-indigo-600 { background-color: #4f46e5 !important; }
        .theme-midnight .hover\:bg-indigo-700:hover { background-color: #4338ca !important; }
        .theme-midnight .from-indigo-600 { --tw-gradient-from: #4f46e5 !important; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to) !important; }
        .theme-midnight .to-purple-600 { --tw-gradient-to: #9333ea !important; }
        .theme-midnight .bg-gradient-to-r { background-image: linear-gradient(to right, var(--tw-gradient-from), var(--tw-gradient-to)) !important; }
        .theme-midnight .border-slate-100, .theme-midnight .border-slate-200, .theme-midnight .border-slate-300, .theme-midnight .border-slate-700, .theme-midnight .border-indigo-100 { border-color: #404040 !important; }
        .theme-midnight input, .theme-midnight select, .theme-midnight textarea { background-color: #000000 !important; border-color: #404040 !important; color: #e5e5e5 !important; }
        .theme-midnight button:not([class*="bg-indigo-"]):not([class*="bg-red-"]):not([class*="bg-gradient-"]) { background-color: #171717 !important; border-color: #404040 !important; color: #e5e5e5 !important; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-100">
    
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useRef, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Gavel, 
            Mic, 
            Settings, 
            AlertCircle, 
            CheckCircle2, 
            ChevronDown, 
            Send, 
            Loader2, 
            Award, 
            BookOpen, 
            Layout, 
            Image as ImageIcon, 
            Upload, 
            X, 
            Plus, 
            Square, 
            Activity,
            HelpCircle,
            Palette,
            Lightbulb,
            Moon,
            Sun,
            Coffee,
            Leaf,
            History,
            Trash2,
            Download,
            Copy,
            LogOut,
            User,
            Lock,
            Menu,
            Droplets,
            CloudSun,
            Star
        } from 'lucide-react';

        // --- Components ---

        const MarkdownRenderer = ({ content }) => {
            if (!content) return null;

            const parseInline = (text) => {
                const parts = text.split(/(\*\*.*?\*\*)/g);
                return parts.map((part, index) => {
                    if (part.startsWith('**') && part.endsWith('**')) {
                        return <strong key={index} className="font-bold text-indigo-700 dark:text-indigo-300">{part.slice(2, -2)}</strong>;
                    }
                    return part;
                });
            };
            
            const lines = content.split('\n');
            
            return (
                <div className="space-y-2 text-slate-700 dark:text-slate-300 leading-relaxed">
                {lines.map((line, i) => {
                    if (line.startsWith('#### ')) {
                        return <h4 key={i} className="text-md font-bold text-slate-800 dark:text-slate-200 mt-4 mb-2">{parseInline(line.replace('#### ', ''))}</h4>;
                    }
                    if (line.startsWith('### ')) {
                        return <h3 key={i} className="text-lg font-semibold text-slate-800 dark:text-slate-200 mt-4 mb-2">{parseInline(line.replace('### ', ''))}</h3>;
                    }
                    if (line.startsWith('## ')) {
                        return <h2 key={i} className="text-xl font-bold text-indigo-600 dark:text-indigo-400 mt-6 mb-3 border-b border-slate-200 dark:border-slate-700 pb-2">{parseInline(line.replace('## ', ''))}</h2>;
                    }
                    if (line.trim().startsWith('* ') || line.trim().startsWith('- ')) {
                        return (
                            <div key={i} className="flex items-start space-x-2 ml-4">
                                <span className="text-indigo-500 mt-1.5">â€¢</span>
                                <span>{parseInline(line.replace(/^[\*\-]\s/, ''))}</span>
                            </div>
                        );
                    }
                    if (line.trim() === '') return <div key={i} className="h-2"></div>;
                    
                    return <p key={i}>{parseInline(line)}</p>;
                })}
                </div>
            );
        };

        const speechTimes = {
            'Public Forum (PF)': [
                { name: 'Constructive', time: 240 },
                { name: 'Rebuttal', time: 240 },
                { name: 'Summary', time: 180 },
                { name: 'Final Focus', time: 120 },
                { name: 'Crossfire', time: 180 }
            ],
            'Lincoln-Douglas (LD)': [
                { name: 'Aff Constructive (AC)', time: 360 },
                { name: 'Neg Constructive (NC)', time: 420 },
                { name: '1st Aff Rebuttal (1AR)', time: 240 },
                { name: 'Neg Rebuttal (NR)', time: 360 },
                { name: '2nd Aff Rebuttal (2AR)', time: 180 }
            ],
            'Policy Debate (CX)': [
                { name: 'Constructive', time: 480 },
                { name: 'Rebuttal', time: 300 },
                { name: 'Cross-Ex', time: 180 }
            ],
            'World Schools Debate': [
                { name: 'Main Speech', time: 480 },
                { name: 'Reply Speech', time: 240 }
            ],
            'Congressional Debate': [
                { name: 'Sponsorship/Auth', time: 180 },
                { name: 'Questioning', time: 120 }
            ],
            'Big Questions Debate': [
                { name: 'Constructive', time: 300 },
                { name: 'Rebuttal', time: 180 },
                { name: 'Consolidation', time: 180 },
                { name: 'Rationale', time: 180 }
            ],
            'United States Extemp (USX)': [
                { name: 'AGD', time: 45 },
                { name: 'Background', time: 45 },
                { name: 'Umbrella/Sig', time: 30 },
                { name: 'Point 1', time: 90 },
                { name: 'Point 2', time: 90 },
                { name: 'Point 3', time: 90 },
                { name: 'Conclusion', time: 30 }
            ],
            'International Extemp (IX)': [
                { name: 'AGD', time: 45 },
                { name: 'Background', time: 45 },
                { name: 'Umbrella/Sig', time: 30 },
                { name: 'Point 1', time: 90 },
                { name: 'Point 2', time: 90 },
                { name: 'Point 3', time: 90 },
                { name: 'Conclusion', time: 30 }
            ],
            'Original Oratory (OO)': [
                { name: 'Intro', time: 90 },
                { name: 'Body 1', time: 150 },
                { name: 'Body 2', time: 150 },
                { name: 'Body 3', time: 150 },
                { name: 'Conclusion', time: 60 }
            ],
            'Informative Speaking (INFO)': [
                { name: 'Intro', time: 90 },
                { name: 'Body 1', time: 150 },
                { name: 'Body 2', time: 150 },
                { name: 'Body 3', time: 150 },
                { name: 'Conclusion', time: 60 }
            ],
            'Dramatic Interpretation (DI)': [
                { name: 'Teaser', time: 90 },
                { name: 'Intro', time: 45 },
                { name: 'Performance', time: 465 }
            ],
            'Humorous Interpretation (HI)': [
                { name: 'Teaser', time: 90 },
                { name: 'Intro', time: 45 },
                { name: 'Performance', time: 465 }
            ],
            'Duo Interpretation': [
                { name: 'Teaser', time: 90 },
                { name: 'Intro', time: 45 },
                { name: 'Performance', time: 465 }
            ],
            'Program Oral Interpretation (POI)': [
                { name: 'Teaser', time: 90 },
                { name: 'Intro', time: 45 },
                { name: 'Performance', time: 465 }
            ],
            'Impromptu': [
                { name: 'Prep', time: 120 },
                { name: 'Speech', time: 300 }
            ],
            'Extemporaneous Commentary': [
                { name: 'Intro', time: 60 },
                { name: 'Points', time: 300 },
                { name: 'Conclusion', time: 60 }
            ],
            'Expository': [
                { name: 'Intro', time: 45 },
                { name: 'Body', time: 210 },
                { name: 'Conclusion', time: 45 }
            ],
            'Storytelling': [
                { name: 'Intro', time: 30 },
                { name: 'Story', time: 270 }
            ],
            'Prose/Poetry': [
                { name: 'Intro', time: 30 },
                { name: 'Reading', time: 270 }
            ],
            'Parliamentary (British)': [
                { name: 'Constructive', time: 420 },
                { name: 'Rebuttal', time: 240 }
            ],
            'Parliamentary (Asian)': [
                { name: 'Constructive', time: 420 },
                { name: 'Reply', time: 240 }
            ],
            'Model UN Speech': [
                { name: 'Intro', time: 15 },
                { name: 'Points', time: 60 },
                { name: 'Call to Action', time: 15 }
            ],
            'After Dinner Speaking': [
                { name: 'Intro', time: 60 },
                { name: 'Body (Humor)', time: 240 },
                { name: 'Conclusion', time: 60 }
            ],
            'Toast/Ceremonial': [
                { name: 'Intro', time: 30 },
                { name: 'Body', time: 120 },
                { name: 'Toast', time: 30 }
            ],
            'default': [
                { name: 'Speech', time: 600 }
            ]
        };

        const AudioVisualizer = ({ analyser, isRecording }) => {
            const canvasRef = useRef(null);

            useEffect(() => {
                if (!analyser || !isRecording || !canvasRef.current) return;

                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                let animationId;

                const draw = () => {
                    animationId = requestAnimationFrame(draw);
                    analyser.getByteFrequencyData(dataArray);

                    ctx.fillStyle = 'rgb(0, 0, 0, 0)'; // Transparent clear
                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    const barWidth = (canvas.width / bufferLength) * 2.5;
                    let barHeight;
                    let x = 0;

                    for (let i = 0; i < bufferLength; i++) {
                        barHeight = dataArray[i] / 2;

                        // Gradient color based on height
                        const gradient = ctx.createLinearGradient(0, canvas.height, 0, 0);
                        gradient.addColorStop(0, '#4f46e5'); // Indigo
                        gradient.addColorStop(1, '#a855f7'); // Purple

                        ctx.fillStyle = gradient;
                        ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);

                        x += barWidth + 1;
                    }
                };

                draw();

                return () => cancelAnimationFrame(animationId);
            }, [analyser, isRecording]);

            if (!isRecording) return null;

            return <canvas ref={canvasRef} width={300} height={100} className="w-full max-w-xs h-24 rounded-lg" />;
        };

        const ToneIndicator = ({ analyser, isRecording }) => {
            const [metrics, setMetrics] = useState({ volume: 0, brightness: 0 });
            const [feedback, setFeedback] = useState({ label: 'Ready', color: 'text-slate-400' });

            useEffect(() => {
                if (!analyser || !isRecording) return;
                
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                const waveformArray = new Uint8Array(analyser.fftSize);
                
                let updateId;
                
                const update = () => {
                    analyser.getByteFrequencyData(dataArray);
                    analyser.getByteTimeDomainData(waveformArray);
                    
                    // Calculate Volume (RMS)
                    let sum = 0;
                    for(let i = 0; i < waveformArray.length; i++) {
                        const amplitude = (waveformArray[i] - 128) / 128;
                        sum += amplitude * amplitude;
                    }
                    const volume = Math.sqrt(sum / waveformArray.length); // 0 to 1
                    
                    // Calculate Brightness (Spectral Centroid)
                    let numerator = 0;
                    let denominator = 0;
                    for(let i = 0; i < bufferLength; i++) {
                        numerator += i * dataArray[i];
                        denominator += dataArray[i];
                    }
                    const brightness = denominator === 0 ? 0 : (numerator / denominator) / bufferLength; // 0 to 1
                    
                    setMetrics({ volume, brightness });
                    
                    // Determine Tone Label
                    if (volume < 0.02) {
                        setFeedback({ label: 'Listening...', color: 'text-slate-400' });
                    } else if (volume < 0.1) {
                        setFeedback({ label: 'Too Quiet', color: 'text-amber-500' });
                    } else if (volume > 0.5) {
                        setFeedback({ label: 'Too Loud / Aggressive', color: 'text-red-500' });
                    } else {
                        // Good volume range
                        if (brightness > 0.4) {
                            setFeedback({ label: 'Urgent / Intense', color: 'text-orange-500' });
                        } else if (brightness < 0.15) {
                            setFeedback({ label: 'Serious / Gravitas', color: 'text-indigo-500' });
                        } else {
                            setFeedback({ label: 'Balanced / Clear', color: 'text-green-500' });
                        }
                    }
                    
                    updateId = requestAnimationFrame(update);
                };
                
                update();
                return () => cancelAnimationFrame(updateId);
            }, [analyser, isRecording]);

            if (!isRecording) return null;

            return (
                <div className="flex flex-col items-center space-y-2 mt-4 animate-in fade-in">
                    <div className={`text-lg font-bold ${feedback.color} transition-colors duration-300`}>
                        {feedback.label}
                    </div>
                    <div className="flex space-x-4 text-xs text-slate-400">
                        <div className="flex flex-col items-center">
                            <div className="h-16 w-4 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden relative">
                                <div 
                                    className="absolute bottom-0 left-0 w-full bg-indigo-500 transition-all duration-100"
                                    style={{ height: `${Math.min(metrics.volume * 200, 100)}%` }}
                                ></div>
                            </div>
                            <span className="mt-1">Vol</span>
                        </div>
                        <div className="flex flex-col items-center">
                            <div className="h-16 w-4 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden relative">
                                <div 
                                    className="absolute bottom-0 left-0 w-full bg-purple-500 transition-all duration-100"
                                    style={{ height: `${Math.min(metrics.brightness * 300, 100)}%` }}
                                ></div>
                            </div>
                            <span className="mt-1">Tone</span>
                        </div>
                    </div>
                </div>
            );
        };

        const rubrics = {
            'Public Forum (PF)': `
                - **Evidence & Warrants (30%)**: Quality of evidence, logical links.
                - **Impact Calculus (30%)**: Magnitude, probability, timeframe.
                - **Clash & Rebuttal (20%)**: Direct responsiveness to opponent.
                - **Delivery (10%)**: Clarity, persuasion, speed.
                - **Crossfire (10%)**: Question quality and dominance.
            `,
            'Lincoln-Douglas (LD)': `
                - **Value & Criterion (30%)**: Framework clarity and application.
                - **Contentions (30%)**: Logical consistency and evidence.
                - **Philosophical Depth (20%)**: Understanding of core values.
                - **Clash (10%)**: Direct refutation.
                - **Delivery (10%)**: Persuasiveness.
            `,
            'Policy Debate (CX)': `
                - **Stock Issues (30%)**: Harms, Solvency, Inherency, Topicality, Significance.
                - **Evidence Quality (25%)**: Source credibility and recency.
                - **Flow & Organization (20%)**: Line-by-line refutation.
                - **Impact Analysis (15%)**: Terminal impacts.
                - **Delivery (10%)**: Clarity (even if spreading).
            `,
            'World Schools Debate': `
                - **Content (40%)**: Logic and relevance of arguments.
                - **Style (40%)**: Rhetoric, delivery, tone.
                - **Strategy (20%)**: Structure, timing, teamwork.
            `,
            'Congressional Debate': `
                - **Argumentation (35%)**: New analysis, evidence.
                - **Rhetoric (35%)**: Persuasion, delivery, style.
                - **Parliamentary Procedure (15%)**: Knowledge of rules.
                - **Questioning (15%)**: Engagement in chamber.
            `,
            'Big Questions Debate': `
                - **Argumentation (40%)**: Logic, evidence, and analysis.
                - **Affirmative/Negative Burden (30%)**: Fulfilling side obligations.
                - **Delivery (20%)**: Persuasion and clarity.
                - **Questioning (10%)**: Effectiveness in Q&A.
            `,
            'United States Extemp (USX)': `
                - **Analysis (40%)**: Depth of answer to the question.
                - **Sourcing (20%)**: Variety and quality of sources.
                - **Organization (20%)**: Structure (Intro, Points, Conclusion).
                - **Delivery (20%)**: Fluency, tone, and poise.
            `,
            'International Extemp (IX)': `
                - **Analysis (40%)**: Depth of answer to the question.
                - **Sourcing (20%)**: Variety and quality of sources.
                - **Organization (20%)**: Structure (Intro, Points, Conclusion).
                - **Delivery (20%)**: Fluency, tone, and poise.
            `,
            'Original Oratory (OO)': `
                - **Topic/Content (40%)**: Originality, significance, and depth.
                - **Delivery (40%)**: Vocal variety, movement, and emotion.
                - **Structure (20%)**: Flow and organization.
            `,
            'Informative Speaking (INFO)': `
                - **Topic/Content (40%)**: Educational value and originality.
                - **Visual Aids (20%)**: Quality and integration of props/boards.
                - **Delivery (30%)**: Engagement and clarity.
                - **Structure (10%)**: Organization.
            `,
            'Dramatic Interpretation (DI)': `
                - **Characterization (40%)**: Depth and believability.
                - **Cutting (30%)**: Story arc and coherence.
                - **Delivery (30%)**: Vocal and physical control.
            `,
            'Humorous Interpretation (HI)': `
                - **Characterization (40%)**: Distinct voices and physical comedy.
                - **Cutting (30%)**: Story arc and humor.
                - **Delivery (30%)**: Timing and execution.
            `,
            'Duo Interpretation': `
                - **Interaction (30%)**: Chemistry and timing (without touching).
                - **Characterization (30%)**: Distinct roles.
                - **Cutting (20%)**: Story coherence.
                - **Blocking (20%)**: Creative use of space.
            `,
            'Program Oral Interpretation (POI)': `
                - **Programming (40%)**: Weaving of different genres/pieces.
                - **Theme (30%)**: Coherence of the central argument.
                - **Delivery (30%)**: Character differentiation and binder technique.
            `,
            'Impromptu': `
                - **Organization (40%)**: Clear structure (Intro, 2-3 points, Conclusion).
                - **Analysis (40%)**: Depth of interpretation of the prompt.
                - **Delivery (20%)**: Fluency and poise.
            `,
            'Extemporaneous Commentary': `
                - **Analysis (50%)**: Insight into the topic.
                - **Delivery (30%)**: Conversational yet professional style.
                - **Structure (20%)**: Clear organization.
            `,
            'Expository': `
                - **Content (50%)**: Informative and well-researched.
                - **Delivery (30%)**: Engaging and clear.
                - **Organization (20%)**: Logical flow.
            `,
            'Storytelling': `
                - **Narrative (40%)**: Plot and pacing.
                - **Characterization (30%)**: Voices and physicalization.
                - **Engagement (30%)**: Connection with audience.
            `,
            'Prose/Poetry': `
                - **Interpretation (40%)**: Understanding of the text.
                - **Delivery (40%)**: Vocal variety and emotion.
                - **Binder Technique (20%)**: Professional use of the book.
            `,
            'Parliamentary (British)': `
                - **Matter (40%)**: Content and logic.
                - **Manner (40%)**: Style and delivery.
                - **Method (20%)**: Structure and responsiveness.
            `,
            'Parliamentary (Asian)': `
                - **Matter (40%)**: Content and logic.
                - **Manner (40%)**: Style and delivery.
                - **Method (20%)**: Structure and responsiveness.
            `,
            'Model UN Speech': `
                - **Diplomacy (30%)**: Tone and adherence to policy.
                - **Content (40%)**: Substance and solutions.
                - **Rhetoric (30%)**: Persuasiveness.
            `,
            'After Dinner Speaking': `
                - **Humor (40%)**: Effectiveness of jokes.
                - **Message (30%)**: Underlying serious point.
                - **Delivery (30%)**: Timing and style.
            `,
            'Toast/Ceremonial': `
                - **Sentiment (40%)**: Appropriateness and emotion.
                - **Brevity (20%)**: Concise and focused.
                - **Delivery (40%)**: Connection with audience.
            `,
            'default': `
                - **Argumentation (40%)**: Logic, evidence, structure.
                - **Delivery (30%)**: Tone, pace, clarity.
                - **Strategy (20%)**: Time management, focus.
                - **Responsiveness (10%)**: Engagement with the topic.
            `
        };

        const Sidebar = ({ activeTab, setActiveTab, user, logout, theme, setTheme, setShowLogin, isOpen, setIsOpen }) => {
            const navItems = [
                { id: 'dashboard', label: 'Dashboard', icon: Layout },
                { id: 'speech', label: 'Judge Text', icon: Mic },
                { id: 'board', label: 'Evaluate Board', icon: ImageIcon },
                { id: 'listen', label: 'Live Coach', icon: Activity },
                { id: 'coach', label: 'Judge Tools', icon: Gavel },
                { id: 'history', label: 'History', icon: History },
                { id: 'settings', label: 'Configuration', icon: Settings },
            ];

            return (
                <>
                    {/* Mobile Overlay */}
                    {isOpen && (
                        <div 
                            className="fixed inset-0 bg-black/50 z-30 lg:hidden backdrop-blur-sm transition-opacity"
                            onClick={() => setIsOpen(false)}
                        />
                    )}

                    {/* Sidebar Container */}
                    <div className={`
                        fixed lg:static inset-y-0 left-0 z-40 w-64 bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-700 
                        flex flex-col transition-transform duration-300 ease-in-out shadow-2xl lg:shadow-none
                        ${isOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'}
                    `}>
                        {/* Logo Area */}
                        <div className="h-16 flex items-center px-6 border-b border-slate-100 dark:border-slate-800">
                            <div className="bg-indigo-600 p-2 rounded-lg shadow-lg shadow-indigo-500/30 mr-3">
                                <Gavel className="w-5 h-5 text-white" />
                            </div>
                            <span className="text-lg font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-600 dark:from-indigo-400 dark:to-purple-400">
                                Adjudicator
                            </span>
                        </div>

                        {/* Navigation */}
                        <nav className="flex-1 p-4 space-y-1 overflow-y-auto">
                            <div className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-4 px-4 mt-2">Menu</div>
                            {navItems.map(item => (
                                <button
                                    key={item.id}
                                    onClick={() => { setActiveTab(item.id); setIsOpen(false); }}
                                    className={`w-full flex items-center px-4 py-3 rounded-xl text-sm font-medium transition-all duration-200 group ${
                                        activeTab === item.id 
                                            ? 'bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600 dark:text-indigo-400 shadow-sm' 
                                            : 'text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-slate-200'
                                    }`}
                                >
                                    <item.icon className={`w-5 h-5 mr-3 transition-colors ${activeTab === item.id ? 'text-indigo-600 dark:text-indigo-400' : 'text-slate-400 group-hover:text-slate-600 dark:group-hover:text-slate-300'}`} />
                                    {item.label}
                                </button>
                            ))}
                        </nav>

                        {/* Footer Controls */}
                        <div className="p-4 border-t border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-900/50">
                            <div className="flex items-center justify-between mb-4 px-2">
                                <span className="text-xs font-semibold text-slate-400 uppercase tracking-wider">Theme</span>
                                <div className="flex bg-white dark:bg-slate-800 rounded-lg p-1 border border-slate-200 dark:border-slate-700 shadow-sm">
                                    {[
                                        { id: 'light', icon: Sun, color: 'text-amber-500' },
                                        { id: 'dark', icon: Moon, color: 'text-indigo-400' },
                                        { id: 'forest', icon: Leaf, color: 'text-emerald-500' },
                                        { id: 'coffee', icon: Coffee, color: 'text-orange-400' },
                                        { id: 'ocean', icon: Droplets, color: 'text-blue-500' },
                                        { id: 'midnight', icon: Star, color: 'text-slate-400' }
                                    ].map(t => (
                                        <button 
                                            key={t.id}
                                            onClick={() => setTheme(t.id)} 
                                            className={`p-1.5 rounded-md transition-all ${theme === t.id ? 'bg-slate-100 dark:bg-slate-700 shadow-sm ' + t.color : 'text-slate-400 hover:text-slate-600'}`}
                                            title={t.id.charAt(0).toUpperCase() + t.id.slice(1)}
                                        >
                                            <t.icon className="w-3.5 h-3.5" />
                                        </button>
                                    ))}
                                </div>
                            </div>
                            
                            {user ? (
                                <div className="flex items-center p-3 bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm">
                                    <div className="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold text-xs mr-3 shadow-md">
                                        {(user.username || user.email)[0].toUpperCase()}
                                    </div>
                                    <div className="flex-1 min-w-0">
                                        <p className="text-xs font-medium text-slate-900 dark:text-white truncate">{user.username || user.email}</p>
                                        <button onClick={logout} className="text-[10px] text-red-500 hover:text-red-600 flex items-center mt-0.5 font-medium">
                                            <LogOut className="w-3 h-3 mr-1" /> Sign out
                                        </button>
                                    </div>
                                </div>
                            ) : (
                                <button onClick={() => setShowLogin(true)} className="w-full py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl text-sm font-medium transition-all shadow-lg shadow-indigo-500/30 flex items-center justify-center group">
                                    <User className="w-4 h-4 mr-2 group-hover:scale-110 transition-transform" />
                                    Sign In
                                </button>
                            )}
                        </div>
                    </div>
                </>
            );
        };

        const Dashboard = ({ user, history, setActiveTab }) => {
            const calculateAverageScore = () => {
                if (!history || history.length === 0) return 'N/A';
                let total = 0;
                let count = 0;
                history.forEach(h => {
                    const tableMatch = h.content && h.content.match(/\|\s*\*\*Total\*\*\s*\|\s*\*\*(\d+)\*\*\s*\|/);
                    const simpleMatch = h.content && h.content.match(/Score:\s*(\d+)/i);
                    if (tableMatch && tableMatch[1]) {
                        total += parseInt(tableMatch[1]);
                        count++;
                    } else if (simpleMatch && simpleMatch[1]) {
                        total += parseInt(simpleMatch[1]);
                        count++;
                    }
                });
                return count > 0 ? Math.round(total / count) : 'N/A';
            };

            const stats = [
                { label: 'Total Analyses', value: history.length, icon: Activity, color: 'text-blue-600', bg: 'bg-blue-100 dark:bg-blue-900/30' },
                { label: 'Last Topic', value: history[0]?.topic || 'N/A', icon: BookOpen, color: 'text-purple-600', bg: 'bg-purple-100 dark:bg-purple-900/30' },
                { label: 'Avg Score', value: calculateAverageScore(), icon: Award, color: 'text-amber-600', bg: 'bg-amber-100 dark:bg-amber-900/30' },
            ];

            const tools = [
                { id: 'speech', title: 'Judge Text', desc: 'Paste transcripts for instant scoring and feedback.', icon: Mic, color: 'from-blue-500 to-cyan-500' },
                { id: 'board', title: 'Evaluate Board', desc: 'Upload flow photos for strategic analysis.', icon: ImageIcon, color: 'from-purple-500 to-pink-500' },
                { id: 'listen', title: 'Live Coach', desc: 'Real-time audio analysis of tone and pace.', icon: Activity, color: 'from-orange-500 to-red-500' }
            ];

            return (
                <div className="space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
                    {/* Welcome Section */}
                    <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div>
                            <h2 className="text-3xl font-bold text-slate-900 dark:text-white tracking-tight">
                                Welcome back, <span className="text-indigo-600 dark:text-indigo-400">{user?.username || user?.email?.split('@')[0] || 'Guest'}</span>
                            </h2>
                            <p className="text-slate-500 dark:text-slate-400 mt-1">Ready to improve your debate skills today?</p>
                        </div>
                        <button onClick={() => setActiveTab('speech')} className="px-5 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-medium shadow-lg shadow-indigo-500/30 transition-all flex items-center justify-center transform hover:scale-105">
                            <Plus className="w-5 h-5 mr-2" /> New Analysis
                        </button>
                    </div>

                    {/* Stats Grid */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        {stats.map((stat, i) => (
                            <div key={i} className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 flex items-center space-x-4 hover:shadow-md transition-all duration-300">
                                <div className={`p-4 rounded-2xl ${stat.bg} ${stat.color}`}>
                                    <stat.icon className="w-6 h-6" />
                                </div>
                                <div className="min-w-0">
                                    <p className="text-sm text-slate-500 dark:text-slate-400 font-medium">{stat.label}</p>
                                    <p className="text-2xl font-bold text-slate-900 dark:text-white truncate">{stat.value}</p>
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* Quick Actions */}
                    <div>
                        <h3 className="text-lg font-bold text-slate-900 dark:text-white mb-4">Quick Actions</h3>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            {tools.map((tool) => (
                                <button 
                                    key={tool.id}
                                    onClick={() => setActiveTab(tool.id)}
                                    className="group relative overflow-hidden bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 hover:shadow-xl transition-all duration-300 text-left"
                                >
                                    <div className={`absolute top-0 right-0 w-24 h-24 bg-gradient-to-br ${tool.color} opacity-10 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-150 duration-500`}></div>
                                    <div className={`w-12 h-12 rounded-xl bg-gradient-to-br ${tool.color} flex items-center justify-center text-white mb-4 shadow-lg`}>
                                        <tool.icon className="w-6 h-6" />
                                    </div>
                                    <h4 className="text-lg font-bold text-slate-900 dark:text-white mb-1">{tool.title}</h4>
                                    <p className="text-sm text-slate-500 dark:text-slate-400">{tool.desc}</p>
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Recent History */}
                    <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                        <div className="p-6 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center bg-slate-50/50 dark:bg-slate-900/50">
                            <h3 className="font-bold text-slate-900 dark:text-white flex items-center">
                                <History className="w-5 h-5 mr-2 text-slate-400" /> Recent Activity
                            </h3>
                            <button onClick={() => setActiveTab('history')} className="text-sm font-medium text-indigo-600 dark:text-indigo-400 hover:text-indigo-700 hover:underline">View All</button>
                        </div>
                        <div className="divide-y divide-slate-100 dark:divide-slate-700">
                            {history.length === 0 ? (
                                <div className="p-8 text-center text-slate-500">No history yet. Start analyzing!</div>
                            ) : (
                                history.slice(0, 5).map(item => (
                                    <div key={item.id} className="p-4 hover:bg-slate-50 dark:hover:bg-slate-900/50 transition-colors flex items-center justify-between group">
                                        <div className="flex items-center space-x-4">
                                            <div className={`w-2 h-2 rounded-full ${item.type === 'speech' ? 'bg-blue-500' : item.type === 'board' ? 'bg-purple-500' : 'bg-green-500'}`}></div>
                                            <div>
                                                <p className="font-medium text-slate-900 dark:text-white">{item.topic}</p>
                                                <p className="text-xs text-slate-500">{item.date} â€¢ {item.type}</p>
                                            </div>
                                        </div>
                                        <ChevronDown className="w-4 h-4 text-slate-300 group-hover:text-slate-500 -rotate-90" />
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- App Component ---
        function App() {
            // State Management
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [activeTab, setActiveTab] = useState('dashboard'); 
            const [provider, setProvider] = useState('gemini'); // gemini, openai
            const [apiKey, setApiKey] = useState('');
            const [openaiKey, setOpenaiKey] = useState('');
            const [loading, setLoading] = useState(false);
            const [result, setResult] = useState(null);
            const [error, setError] = useState('');
            const [showHelp, setShowHelp] = useState(false);
            const [showHistory, setShowHistory] = useState(false);
            const [history, setHistory] = useState([]);
            const [theme, setTheme] = useState('light'); // light, dark, neon
            
            // Auth State
            const [user, setUser] = useState(null);
            const [showLogin, setShowLogin] = useState(false);
            const [authMode, setAuthMode] = useState('login'); // login, signup
            const [authUsername, setAuthUsername] = useState('');
            const [authEmail, setAuthEmail] = useState('');
            const [authPassword, setAuthPassword] = useState('');
            const [authError, setAuthError] = useState('');
            const [showUsernameSetup, setShowUsernameSetup] = useState(false);
            const [isFirebaseReady, setIsFirebaseReady] = useState(false);
            const [verificationStatus, setVerificationStatus] = useState({ gemini: 'idle', openai: 'idle' }); // idle, loading, success, error

            useEffect(() => {
                const savedTheme = localStorage.getItem('theme') || 'light';
                setTheme(savedTheme);
                
                // Check if Firebase is initialized
                if (window.auth && window.firebaseAuth) {
                    setIsFirebaseReady(true);
                    const unsubscribe = window.firebaseAuth.onAuthStateChanged(window.auth, async (currentUser) => {
                        if (currentUser) {
                            // Fetch additional user data (username)
                            let username = null;
                            let storedGeminiKey = '';
                            let storedOpenaiKey = '';
                            try {
                                const userDoc = await window.firebaseDb.getDoc(window.firebaseDb.doc(window.db, "users", currentUser.uid));
                                if (userDoc.exists()) {
                                    const data = userDoc.data();
                                    username = data.username;
                                    storedGeminiKey = data.geminiKey || '';
                                    storedOpenaiKey = data.openaiKey || '';
                                }
                            } catch (e) {
                                console.error("Error fetching user profile:", e);
                            }
                            
                            // Merge username into the user object or state
                            const enhancedUser = { ...currentUser, username };
                            setUser(enhancedUser);
                            setApiKey(storedGeminiKey);
                            setOpenaiKey(storedOpenaiKey);
                            
                            setShowLogin(false);
                            if (!username) {
                                setShowUsernameSetup(true);
                            }
                            loadUserHistory(currentUser.uid);
                        } else {
                            setUser(null);
                            setShowLogin(true);
                        }
                    });
                    return () => unsubscribe();
                } else {
                    // Fallback for when config is missing
                    console.warn("Firebase not configured. Using local storage fallback.");
                    const sessionUser = localStorage.getItem('activeUser');
                    if (sessionUser) {
                        const userData = JSON.parse(sessionUser);
                        setUser(userData);
                        
                        // Load keys from local profile
                        const profile = JSON.parse(localStorage.getItem(`profile_${userData.email}`) || '{}');
                        setApiKey(profile.geminiKey || '');
                        setOpenaiKey(profile.openaiKey || '');

                        setShowLogin(false);
                        loadUserHistory(userData.email); // Fallback uses email as ID
                    } else {
                        setShowLogin(true);
                    }
                }
            }, []);

            // Load history
            const loadUserHistory = async (userId) => {
                if (window.db && window.firebaseDb) {
                    try {
                        const docRef = window.firebaseDb.doc(window.db, "users", userId);
                        const docSnap = await window.firebaseDb.getDoc(docRef);
                        if (docSnap.exists()) {
                            setHistory(docSnap.data().history || []);
                        } else {
                            setHistory([]);
                        }
                    } catch (e) {
                        console.error("Error loading history:", e);
                    }
                } else {
                    // Fallback
                    const savedHistory = localStorage.getItem(`debateHistory_${userId}`);
                    if (savedHistory) setHistory(JSON.parse(savedHistory));
                    else setHistory([]);
                }
            };

            // Save history
            const saveHistoryToCloud = async (newHistory, userId) => {
                if (window.db && window.firebaseDb) {
                    try {
                        const userRef = window.firebaseDb.doc(window.db, "users", userId);
                        await window.firebaseDb.setDoc(userRef, { history: newHistory }, { merge: true });
                    } catch (e) {
                        console.error("Error saving history:", e);
                    }
                }
            };

            // Effect to sync history changes
            useEffect(() => {
                if (user) {
                    const userId = user.uid || user.email;
                    // Local backup
                    localStorage.setItem(`debateHistory_${userId}`, JSON.stringify(history));
                    
                    // Cloud sync
                    if (user.uid && window.db) {
                        saveHistoryToCloud(history, user.uid);
                    }
                }
            }, [history, user]);

            // Help Popup Logic
            useEffect(() => {
                if (user && !showLogin) {
                    const userId = user.uid || user.email;
                    const hasVisited = localStorage.getItem(`hasVisited_${userId}`);
                    if (!hasVisited) {
                        setShowHelp(true);
                        localStorage.setItem(`hasVisited_${userId}`, 'true');
                    }
                }
            }, [user, showLogin]);

            const handleAuth = async (e) => {
                e.preventDefault();
                setAuthError('');
                
                if (!authEmail || !authPassword || (authMode === 'signup' && !authUsername)) {
                    setAuthError('Please fill in all fields');
                    return;
                }

                if (window.auth && window.firebaseAuth && window.auth.app.options.apiKey !== "YOUR_API_KEY_HERE") {
                    // Firebase Auth
                    try {
                        if (authMode === 'signup') {
                            // 1. Check if username is taken
                            const usernameRef = window.firebaseDb.doc(window.db, "usernames", authUsername);
                            const usernameSnap = await window.firebaseDb.getDoc(usernameRef);
                            
                            if (usernameSnap.exists()) {
                                setAuthError('Username is already taken.');
                                return;
                            }

                            // 2. Create User
                            const userCredential = await window.firebaseAuth.createUserWithEmailAndPassword(window.auth, authEmail, authPassword);
                            const user = userCredential.user;

                            // 3. Reserve Username & Create Profile
                            const batch = window.db.batch ? window.db.batch() : null; // Handle if batch isn't available in this simplified import
                            
                            // Fallback to individual writes if batch not easily accessible in this context, 
                            // but let's try standard writes.
                            await window.firebaseDb.setDoc(window.firebaseDb.doc(window.db, "users", user.uid), {
                                email: authEmail,
                                username: authUsername,
                                createdAt: new Date().toISOString(),
                                history: []
                            });
                            
                            await window.firebaseDb.setDoc(window.firebaseDb.doc(window.db, "usernames", authUsername), {
                                uid: user.uid
                            });

                            await window.firebaseAuth.sendEmailVerification(user);
                            setAuthError('Account created! Please check your email to verify your account.');
                        } else {
                            const userCredential = await window.firebaseAuth.signInWithEmailAndPassword(window.auth, authEmail, authPassword);
                            if (!userCredential.user.emailVerified) {
                                // setAuthError('Please verify your email address before signing in.');
                                // Optional: Allow login anyway
                            }
                        }
                        setAuthEmail('');
                        setAuthPassword('');
                        setAuthUsername('');
                    } catch (error) {
                        console.error(error);
                        let msg = error.message;
                        if (error.code === 'auth/invalid-credential') msg = 'Invalid email or password.';
                        if (error.code === 'auth/email-already-in-use') msg = 'Email already in use.';
                        if (error.code === 'auth/weak-password') msg = 'Password should be at least 6 characters.';
                        setAuthError(msg);
                    }
                } else {
                    // Local Storage Fallback (Demo Mode)
                    const users = JSON.parse(localStorage.getItem('registeredUsers') || '{}');
                    const takenUsernames = JSON.parse(localStorage.getItem('takenUsernames') || '{}');

                    if (authMode === 'signup') {
                        if (users[authEmail]) { setAuthError('User already exists'); return; }
                        if (takenUsernames[authUsername]) { setAuthError('Username already taken'); return; }
                        
                        users[authEmail] = authPassword;
                        takenUsernames[authUsername] = authEmail;
                        
                        localStorage.setItem('registeredUsers', JSON.stringify(users));
                        localStorage.setItem('takenUsernames', JSON.stringify(takenUsernames));
                        
                        // Save profile
                        const userProfile = { email: authEmail, username: authUsername };
                        localStorage.setItem(`profile_${authEmail}`, JSON.stringify(userProfile));

                        loginUserLocal(authEmail);
                    } else {
                        if (users[authEmail] && users[authEmail] === authPassword) {
                            loginUserLocal(authEmail);
                        } else {
                            setAuthError('Invalid email or password (Demo Mode)');
                        }
                    }
                }
            };

            const handleGoogleLogin = async () => {
                if (window.auth && window.firebaseAuth && window.googleProvider) {
                    try {
                        await window.firebaseAuth.signInWithPopup(window.auth, window.googleProvider);
                    } catch (error) {
                        console.error(error);
                        setAuthError(error.message);
                    }
                } else {
                    setAuthError("Google Sign-In not configured or available in Demo Mode.");
                }
            };

            const loginUserLocal = (email) => {
                const profile = JSON.parse(localStorage.getItem(`profile_${email}`) || '{}');
                const userData = { email, uid: null, username: profile.username || null }; // No UID for local users
                setUser(userData);
                setApiKey(profile.geminiKey || '');
                setOpenaiKey(profile.openaiKey || '');
                localStorage.setItem('activeUser', JSON.stringify(userData));
                setShowLogin(false);
                if (!userData.username) {
                    setShowUsernameSetup(true);
                }
                loadUserHistory(email);
                setAuthEmail('');
                setAuthPassword('');
                setAuthUsername('');
            };

            const verifyAndSaveKey = async (type, key) => {
                if (!key) return;
                setVerificationStatus(prev => ({ ...prev, [type]: 'loading' }));
                
                try {
                    if (type === 'gemini') {
                        // Test call - List Models (lighter weight check, avoids model-specific 404s)
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                        
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            console.error("Gemini Verification Failed:", errorData);
                            throw new Error(errorData.error?.message || "Invalid Key");
                        }
                        
                        // Save
                        if (user) {
                            if (window.auth && window.firebaseAuth && isFirebaseReady) {
                                await window.firebaseDb.setDoc(window.firebaseDb.doc(window.db, "users", user.uid), {
                                    geminiKey: key
                                }, { merge: true });
                            } else {
                                // Local
                                const profile = JSON.parse(localStorage.getItem(`profile_${user.email}`) || '{}');
                                profile.geminiKey = key;
                                localStorage.setItem(`profile_${user.email}`, JSON.stringify(profile));
                            }
                        }
                        setVerificationStatus(prev => ({ ...prev, [type]: 'success' }));
                        setTimeout(() => setVerificationStatus(prev => ({ ...prev, [type]: 'idle' })), 3000);
                    } else {
                        // OpenAI test - List Models (lighter weight check, avoids model-specific 404s)
                        const response = await fetch('https://api.openai.com/v1/models', {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${key}`
                            }
                        });

                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            console.error("OpenAI Verification Failed:", errorData);
                            throw new Error(errorData.error?.message || "Invalid Key");
                        }
                        
                        // Save
                        if (user) {
                            if (window.auth && window.firebaseAuth && isFirebaseReady) {
                                await window.firebaseDb.setDoc(window.firebaseDb.doc(window.db, "users", user.uid), {
                                    openaiKey: key
                                }, { merge: true });
                            } else {
                                // Local
                                const profile = JSON.parse(localStorage.getItem(`profile_${user.email}`) || '{}');
                                profile.openaiKey = key;
                                localStorage.setItem(`profile_${user.email}`, JSON.stringify(profile));
                            }
                        }
                        setVerificationStatus(prev => ({ ...prev, [type]: 'success' }));
                        setTimeout(() => setVerificationStatus(prev => ({ ...prev, [type]: 'idle' })), 3000);
                    }
                } catch (e) {
                    console.error(e);
                    setVerificationStatus(prev => ({ ...prev, [type]: 'error' }));
                    setTimeout(() => setVerificationStatus(prev => ({ ...prev, [type]: 'idle' })), 3000);
                }
            };

            const handleUsernameSetup = async (e) => {
                e.preventDefault();
                setAuthError('');
                
                if (!authUsername) {
                    setAuthError('Please enter a username');
                    return;
                }

                if (window.auth && window.firebaseAuth && window.auth.app.options.apiKey !== "YOUR_API_KEY_HERE") {
                    try {
                        // 1. Check if username is taken
                        const usernameRef = window.firebaseDb.doc(window.db, "usernames", authUsername);
                        const usernameSnap = await window.firebaseDb.getDoc(usernameRef);
                        
                        if (usernameSnap.exists()) {
                            setAuthError('Username is already taken.');
                            return;
                        }

                        // 2. Reserve Username & Update Profile
                        const userId = user.uid;
                        await window.firebaseDb.setDoc(window.firebaseDb.doc(window.db, "users", userId), {
                            username: authUsername
                        }, { merge: true });
                        
                        await window.firebaseDb.setDoc(window.firebaseDb.doc(window.db, "usernames", authUsername), {
                            uid: userId
                        });

                        // Update local state
                        setUser(prev => ({ ...prev, username: authUsername }));
                        setShowUsernameSetup(false);
                        setAuthUsername('');
                    } catch (error) {
                        console.error(error);
                        setAuthError(error.message);
                    }
                } else {
                    // Local Storage Fallback
                    const takenUsernames = JSON.parse(localStorage.getItem('takenUsernames') || '{}');
                    if (takenUsernames[authUsername]) { setAuthError('Username already taken'); return; }
                    
                    takenUsernames[authUsername] = user.email;
                    localStorage.setItem('takenUsernames', JSON.stringify(takenUsernames));
                    
                    const userProfile = JSON.parse(localStorage.getItem(`profile_${user.email}`) || '{}');
                    userProfile.username = authUsername;
                    localStorage.setItem(`profile_${user.email}`, JSON.stringify(userProfile));

                    // Update local state
                    const updatedUser = { ...user, username: authUsername };
                    setUser(updatedUser);
                    localStorage.setItem('activeUser', JSON.stringify(updatedUser));
                    
                    setShowUsernameSetup(false);
                    setAuthUsername('');
                }
            };

            const logout = async () => {
                if (window.auth && window.firebaseAuth) {
                    try {
                        await window.firebaseAuth.signOut(window.auth);
                    } catch (e) { console.error(e); }
                }
                setUser(null);
                localStorage.removeItem('activeUser');
                setShowLogin(true);
                setHistory([]);
                setResult(null);
                setTranscript('');
                setBoardImages([]);
                setAudioData(null);
            };

            useEffect(() => {
                const root = document.documentElement;
                const body = document.body;
                
                // Reset
                root.classList.remove('dark');
                body.classList.remove('theme-forest', 'theme-coffee', 'theme-ocean', 'theme-midnight');
                
                if (theme === 'dark') {
                    root.classList.add('dark');
                } else if (theme === 'forest') {
                    root.classList.add('dark');
                    body.classList.add('theme-forest');
                } else if (theme === 'coffee') {
                    root.classList.add('dark');
                    body.classList.add('theme-coffee');
                } else if (theme === 'ocean') {
                    root.classList.add('dark');
                    body.classList.add('theme-ocean');
                } else if (theme === 'midnight') {
                    root.classList.add('dark');
                    body.classList.add('theme-midnight');
                }
                
                localStorage.setItem('theme', theme);
            }, [theme]);

            useEffect(() => {
                const hasVisited = localStorage.getItem('hasVisited');
                if (!hasVisited) {
                    setShowHelp(true);
                    localStorage.setItem('hasVisited', 'true');
                }
            }, []);
            
            // Speech Form State
            const [speechType, setSpeechType] = useState('Public Forum (PF)');
            const [side, setSide] = useState('Proposition/Affirmative');
            const [topic, setTopic] = useState('');
            const [transcript, setTranscript] = useState('');

            // Board Form State
            const [boardDescription, setBoardDescription] = useState('');
            const [boardImages, setBoardImages] = useState([]); 
            const fileInputRef = useRef(null);

            // Audio Recording State
            const [isRecording, setIsRecording] = useState(false);
            const [recordingTime, setRecordingTime] = useState(0);
            const [audioData, setAudioData] = useState(null); 
            const [selectedSection, setSelectedSection] = useState(null);
            const [analyser, setAnalyser] = useState(null);
            
            const mediaRecorderRef = useRef(null);
            const timerRef = useRef(null);
            const chunksRef = useRef([]);
            const audioContextRef = useRef(null);
            const analyserRef = useRef(null);
            const sourceRef = useRef(null);

            // Update selected section when speech type changes
            useEffect(() => {
                const sections = speechTimes[speechType] || speechTimes['default'];
                setSelectedSection(sections[0]);
            }, [speechType]);

            // Options
            const speechTypes = [
                'Policy Debate (CX)', 'Lincoln-Douglas (LD)', 'Public Forum (PF)', 'Big Questions Debate',
                'World Schools Debate', 'Congressional Debate', 'Original Oratory (OO)', 'Informative Speaking (INFO)',
                'United States Extemp (USX)', 'International Extemp (IX)', 'Dramatic Interpretation (DI)',
                'Humorous Interpretation (HI)', 'Duo Interpretation', 'Program Oral Interpretation (POI)',
                'Impromptu', 'Extemporaneous Commentary', 'Expository', 'Storytelling', 'Prose/Poetry',
                'Parliamentary (British)', 'Parliamentary (Asian)', 'Model UN Speech', 'After Dinner Speaking', 'Toast/Ceremonial'
            ];

            const sides = [
                'Proposition/Affirmative', 'Opposition/Negative', 'Government', 'Opposition',
                'Pro', 'Con', 'Opening Member', 'Closing Member/Whip', 'Sponsor (Congress)',
                'Individual/Solo', 'Neutral/Evaluator'
            ];

            // Handlers
            const handleImageUpload = (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;
                files.forEach(file => {
                    if (file.size > 4 * 1024 * 1024) {
                        setError(prev => (prev ? `${prev} ` : '') + `Skipped ${file.name} (too large).`);
                        return;
                    }
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const base64String = reader.result.split(',')[1];
                        setBoardImages(prev => [...prev, {
                            id: Math.random().toString(36).substr(2, 9),
                            url: reader.result,
                            raw: base64String,
                            mimeType: file.type,
                            name: file.name
                        }]);
                    };
                    reader.readAsDataURL(file);
                });
                if (fileInputRef.current) fileInputRef.current.value = '';
            };

            const removeImage = (id) => {
                setBoardImages(prev => prev.filter(img => img.id !== id));
            };

            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            };

            const startRecording = async () => {
                setError('');
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    
                    // Audio Context Setup for Visualization
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const analyserNode = audioContext.createAnalyser();
                    const source = audioContext.createMediaStreamSource(stream);
                    source.connect(analyserNode);
                    analyserNode.fftSize = 256;
                    
                    audioContextRef.current = audioContext;
                    analyserRef.current = analyserNode;
                    sourceRef.current = source;
                    setAnalyser(analyserNode);

                    mediaRecorderRef.current = new MediaRecorder(stream);
                    chunksRef.current = [];
                    mediaRecorderRef.current.ondataavailable = (e) => {
                        if (e.data.size > 0) chunksRef.current.push(e.data);
                    };
                    mediaRecorderRef.current.onstop = () => {
                        const blob = new Blob(chunksRef.current, { type: 'audio/webm' });
                        const reader = new FileReader();
                        reader.readAsDataURL(blob);
                        reader.onloadend = () => {
                            const base64String = reader.result.split(',')[1];
                            setAudioData({ raw: base64String, mimeType: blob.type });
                        };
                        stream.getTracks().forEach(track => track.stop());
                        
                        // Cleanup Audio Context
                        if (audioContextRef.current) {
                            audioContextRef.current.close();
                            audioContextRef.current = null;
                            setAnalyser(null);
                        }
                    };
                    mediaRecorderRef.current.start();
                    setIsRecording(true);
                    setRecordingTime(0);
                    setAudioData(null);
                    timerRef.current = setInterval(() => setRecordingTime(prev => prev + 1), 1000);
                } catch (err) {
                    setError("Could not access microphone. Ensure permissions are granted (may require HTTPS or localhost).");
                    console.error(err);
                }
            };

            const stopRecording = () => {
                if (mediaRecorderRef.current && isRecording) {
                    mediaRecorderRef.current.stop();
                    setIsRecording(false);
                    clearInterval(timerRef.current);
                }
            };

            const resetAudio = () => {
                setAudioData(null);
                setRecordingTime(0);
                setError('');
            };

            const addToHistory = (text, type) => {
                const newItem = {
                    id: Date.now(),
                    date: new Date().toLocaleString(),
                    type,
                    topic: topic || 'Untitled',
                    content: text
                };
                setHistory(prev => [newItem, ...prev]);
            };

            const clearHistory = () => {
                if (confirm('Are you sure you want to clear all history?')) {
                    setHistory([]);
                }
            };

            // --- Coach Tools Component ---
            const CoachTools = ({ speechTimes, rubrics }) => {
                const [format, setFormat] = useState('Public Forum (PF)');
                const [activeSpeech, setActiveSpeech] = useState(null);
                
                // Main Speech Timer
                const [mainTimer, setMainTimer] = useState(0);
                const [isMainRunning, setIsMainRunning] = useState(false);
                const mainInterval = useRef(null);

                // Prep Timers
                const [prepA, setPrepA] = useState(180); // 3 mins default
                const [isPrepARunning, setIsPrepARunning] = useState(false);
                const prepAInterval = useRef(null);

                const [prepB, setPrepB] = useState(180);
                const [isPrepBRunning, setIsPrepBRunning] = useState(false);
                const prepBInterval = useRef(null);

                // Grace Timers
                const [graceA, setGraceA] = useState(120); // 2 mins default
                const [isGraceARunning, setIsGraceARunning] = useState(false);
                const graceAInterval = useRef(null);

                const [graceB, setGraceB] = useState(120);
                const [isGraceBRunning, setIsGraceBRunning] = useState(false);
                const graceBInterval = useRef(null);

                // Event Configuration
                const eventSettings = {
                    'Public Forum (PF)': { type: 'debate', showPrep: true, prepTime: 180, teamA: 'Pro', teamB: 'Con' },
                    'Lincoln-Douglas (LD)': { type: 'debate', showPrep: true, prepTime: 240, teamA: 'Aff', teamB: 'Neg' },
                    'Policy Debate (CX)': { type: 'debate', showPrep: true, prepTime: 300, teamA: 'Aff', teamB: 'Neg' },
                    'Big Questions Debate': { type: 'debate', showPrep: true, prepTime: 180, teamA: 'Aff', teamB: 'Neg' },
                    'World Schools Debate': { type: 'debate', showPrep: false, teamA: 'Prop', teamB: 'Opp' },
                    'Parliamentary (British)': { type: 'debate', showPrep: false, teamA: 'Gov', teamB: 'Opp' },
                    'Parliamentary (Asian)': { type: 'debate', showPrep: false, teamA: 'Gov', teamB: 'Opp' },
                    'Congressional Debate': { type: 'congress', showPrep: false },
                    'default': { type: 'speech', showPrep: false, teamA: 'Team A', teamB: 'Team B' }
                };

                const currentSettings = eventSettings[format] || eventSettings['default'];

                useEffect(() => {
                    if (speechTimes[format]) {
                        setActiveSpeech(speechTimes[format][0]);
                        setMainTimer(speechTimes[format][0].time);
                    }
                    // Reset prep timers based on format
                    if (currentSettings.showPrep) {
                        setPrepA(currentSettings.prepTime);
                        setPrepB(currentSettings.prepTime);
                    }
                }, [format]);

                useEffect(() => {
                    if (activeSpeech) {
                        setMainTimer(activeSpeech.time);
                        setIsMainRunning(false);
                        clearInterval(mainInterval.current);
                    }
                }, [activeSpeech]);

                const toggleTimer = (timerState, setTimerState, intervalRef, setTime) => {
                    if (timerState) {
                        clearInterval(intervalRef.current);
                        setTimerState(false);
                    } else {
                        setTimerState(true);
                        intervalRef.current = setInterval(() => {
                            setTime(prev => {
                                if (prev <= 0) {
                                    clearInterval(intervalRef.current);
                                    setTimerState(false);
                                    return 0;
                                }
                                return prev - 1;
                            });
                        }, 1000);
                    }
                };

                const resetTimer = (setTime, initialValue, setRunning, intervalRef) => {
                    clearInterval(intervalRef.current);
                    setRunning(false);
                    setTime(initialValue);
                };

                const formatTime = (seconds) => {
                    const mins = Math.floor(seconds / 60);
                    const secs = seconds % 60;
                    return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
                };

                return (
                    <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4">
                        {/* Header & Format Selection */}
                        <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                            <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                                <div>
                                    <h2 className="text-2xl font-bold text-slate-900 dark:text-white">Judge & Coach Tools</h2>
                                    <p className="text-slate-500 dark:text-slate-400 text-sm">Comprehensive timer suite and resources for adjudication.</p>
                                </div>
                                <div className="w-full md:w-64">
                                    <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Debate Format</label>
                                    <div className="relative">
                                        <select 
                                            className="w-full appearance-none bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-slate-100 py-2.5 px-4 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition-all"
                                            value={format}
                                            onChange={(e) => setFormat(e.target.value)}
                                        >
                                            {Object.keys(speechTimes).filter(k => k !== 'default').map(k => (
                                                <option key={k} value={k}>{k}</option>
                                            ))}
                                        </select>
                                        <ChevronDown className="absolute right-3 top-3.5 w-4 h-4 text-slate-400 pointer-events-none" />
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Main Speech Timer */}
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div className="lg:col-span-2 bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 flex flex-col">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="font-bold text-lg text-slate-800 dark:text-slate-200 flex items-center">
                                        <Mic className="w-5 h-5 mr-2 text-indigo-500" /> Speech Timer
                                    </h3>
                                    <div className="flex space-x-2 flex-wrap gap-y-2">
                                        {speechTimes[format]?.map((s, idx) => (
                                            <button 
                                                key={idx}
                                                onClick={() => setActiveSpeech(s)}
                                                className={`px-3 py-1 text-xs rounded-full transition-all ${activeSpeech?.name === s.name ? 'bg-indigo-600 text-white' : 'bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600'}`}
                                            >
                                                {s.name}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                
                                <div className="flex-1 flex flex-col items-center justify-center py-8">
                                    <div className="text-center mb-2">
                                        <span className="text-sm font-medium text-slate-500 uppercase tracking-wider">{activeSpeech?.name || 'Select Speech'}</span>
                                    </div>
                                    <div className={`text-8xl font-mono font-bold tracking-tighter mb-8 tabular-nums ${mainTimer < 30 ? 'text-red-500 animate-pulse' : 'text-slate-900 dark:text-white'}`}>
                                        {formatTime(mainTimer)}
                                    </div>
                                    <div className="flex space-x-4">
                                        <button 
                                            onClick={() => toggleTimer(isMainRunning, setIsMainRunning, mainInterval, setMainTimer)}
                                            className={`w-32 py-3 rounded-xl font-bold text-white shadow-lg transition-transform active:scale-95 ${isMainRunning ? 'bg-amber-500 hover:bg-amber-600' : 'bg-indigo-600 hover:bg-indigo-700'}`}
                                        >
                                            {isMainRunning ? 'Pause' : 'Start'}
                                        </button>
                                        <button 
                                            onClick={() => resetTimer(setMainTimer, activeSpeech?.time || 0, setIsMainRunning, mainInterval)}
                                            className="w-32 py-3 rounded-xl font-bold text-slate-700 dark:text-slate-200 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors"
                                        >
                                            Reset
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {/* Prep & Grace Timers - Only show for Debate formats */}
                            {currentSettings.type === 'debate' && (
                                <div className="space-y-6">
                                    {/* Prep Time - Only if format has prep */}
                                    {currentSettings.showPrep && (
                                        <div className="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                                            <h3 className="font-bold text-sm text-slate-500 uppercase tracking-wider mb-4 flex items-center">
                                                <History className="w-4 h-4 mr-2" /> Prep Time
                                            </h3>
                                            <div className="space-y-4">
                                                {/* Team A */}
                                                <div className="bg-slate-50 dark:bg-slate-900/50 p-3 rounded-lg border border-slate-100 dark:border-slate-700">
                                                    <div className="flex justify-between items-center mb-2">
                                                        <span className="text-xs font-bold text-indigo-600 dark:text-indigo-400">{currentSettings.teamA} Prep</span>
                                                        <span className={`font-mono font-bold text-xl ${prepA < 30 ? 'text-red-500' : 'text-slate-800 dark:text-slate-200'}`}>{formatTime(prepA)}</span>
                                                    </div>
                                                    <div className="flex space-x-2">
                                                        <button onClick={() => toggleTimer(isPrepARunning, setIsPrepARunning, prepAInterval, setPrepA)} className={`flex-1 py-1 text-xs rounded font-medium text-white ${isPrepARunning ? 'bg-amber-500' : 'bg-indigo-500 hover:bg-indigo-600'}`}>{isPrepARunning ? 'Pause' : 'Start'}</button>
                                                        <button onClick={() => resetTimer(setPrepA, currentSettings.prepTime, setIsPrepARunning, prepAInterval)} className="px-3 py-1 text-xs rounded font-medium bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300">Reset</button>
                                                    </div>
                                                </div>
                                                {/* Team B */}
                                                <div className="bg-slate-50 dark:bg-slate-900/50 p-3 rounded-lg border border-slate-100 dark:border-slate-700">
                                                    <div className="flex justify-between items-center mb-2">
                                                        <span className="text-xs font-bold text-purple-600 dark:text-purple-400">{currentSettings.teamB} Prep</span>
                                                        <span className={`font-mono font-bold text-xl ${prepB < 30 ? 'text-red-500' : 'text-slate-800 dark:text-slate-200'}`}>{formatTime(prepB)}</span>
                                                    </div>
                                                    <div className="flex space-x-2">
                                                        <button onClick={() => toggleTimer(isPrepBRunning, setIsPrepBRunning, prepBInterval, setPrepB)} className={`flex-1 py-1 text-xs rounded font-medium text-white ${isPrepBRunning ? 'bg-amber-500' : 'bg-purple-500 hover:bg-purple-600'}`}>{isPrepBRunning ? 'Pause' : 'Start'}</button>
                                                        <button onClick={() => resetTimer(setPrepB, currentSettings.prepTime, setIsPrepBRunning, prepBInterval)} className="px-3 py-1 text-xs rounded font-medium bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300">Reset</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* Grace / Tech Time - Show for all debates */}
                                    <div className="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                                        <h3 className="font-bold text-sm text-slate-500 uppercase tracking-wider mb-4 flex items-center">
                                            <AlertCircle className="w-4 h-4 mr-2" /> Grace / Tech Time
                                        </h3>
                                        <div className="space-y-4">
                                            {/* Team A */}
                                            <div className="bg-slate-50 dark:bg-slate-900/50 p-3 rounded-lg border border-slate-100 dark:border-slate-700">
                                                <div className="flex justify-between items-center mb-2">
                                                    <span className="text-xs font-bold text-indigo-600 dark:text-indigo-400">{currentSettings.teamA} Grace</span>
                                                    <span className={`font-mono font-bold text-xl ${graceA < 30 ? 'text-red-500' : 'text-slate-800 dark:text-slate-200'}`}>{formatTime(graceA)}</span>
                                                </div>
                                                <div className="flex space-x-2">
                                                    <button onClick={() => toggleTimer(isGraceARunning, setIsGraceARunning, graceAInterval, setGraceA)} className={`flex-1 py-1 text-xs rounded font-medium text-white ${isGraceARunning ? 'bg-amber-500' : 'bg-indigo-500 hover:bg-indigo-600'}`}>{isGraceARunning ? 'Pause' : 'Start'}</button>
                                                    <button onClick={() => resetTimer(setGraceA, 120, setIsGraceARunning, graceAInterval)} className="px-3 py-1 text-xs rounded font-medium bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300">Reset</button>
                                                </div>
                                            </div>
                                            {/* Team B */}
                                            <div className="bg-slate-50 dark:bg-slate-900/50 p-3 rounded-lg border border-slate-100 dark:border-slate-700">
                                                <div className="flex justify-between items-center mb-2">
                                                    <span className="text-xs font-bold text-purple-600 dark:text-purple-400">{currentSettings.teamB} Grace</span>
                                                    <span className={`font-mono font-bold text-xl ${graceB < 30 ? 'text-red-500' : 'text-slate-800 dark:text-slate-200'}`}>{formatTime(graceB)}</span>
                                                </div>
                                                <div className="flex space-x-2">
                                                    <button onClick={() => toggleTimer(isGraceBRunning, setIsGraceBRunning, graceBInterval, setGraceB)} className={`flex-1 py-1 text-xs rounded font-medium text-white ${isGraceBRunning ? 'bg-amber-500' : 'bg-purple-500 hover:bg-purple-600'}`}>{isGraceBRunning ? 'Pause' : 'Start'}</button>
                                                    <button onClick={() => resetTimer(setGraceB, 120, setIsGraceBRunning, graceBInterval)} className="px-3 py-1 text-xs rounded font-medium bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300">Reset</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Resources / Rubric */}
                        <div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                            <div className="px-6 py-4 border-b border-slate-200 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-900/50">
                                <h3 className="font-bold text-lg text-slate-800 dark:text-slate-200">Judging Resources: {format}</h3>
                            </div>
                            <div className="p-6">
                                <MarkdownRenderer content={rubrics[format] || rubrics['default']} />
                            </div>
                        </div>
                    </div>
                );
            };

            const handleAnalyze = async (isBoardGen = false) => {
                const currentKey = provider === 'gemini' ? apiKey : openaiKey;
                if (!currentKey) { setError(`Please enter a valid ${provider === 'gemini' ? 'Gemini' : 'OpenAI'} API Key.`); return; }
                
                if (!isBoardGen) {
                    if (activeTab === 'speech' && !transcript) { setError('Please enter speech text.'); return; }
                    if (activeTab === 'board' && !boardDescription && boardImages.length === 0) { setError('Please provide images or description.'); return; }
                    if (activeTab === 'listen' && !audioData) { setError('Please record audio first.'); return; }
                    if (activeTab === 'listen' && provider === 'openai') { setError('Live Audio analysis is currently only available with Gemini.'); return; }
                }
                
                setLoading(true);
                setError('');
                setResult(null);

                try {
                    let generatedText = '';
                    const rubric = rubrics[speechType] || rubrics['default'];

                    if (provider === 'gemini') {
                        let payloadParts = [];
                        let systemPrompt = '';
                        
                        // Prompt Construction
                        if (isBoardGen) {
                             systemPrompt = `Act as an expert Debate Coach. For the topic "${topic}" and side "${side}" in ${speechType} format, describe an ideal debate board/flow layout. 
                             Include:
                             1. Strategic grouping of arguments.
                             2. How to use colors/columns effectively.
                             3. A text-based outline of the main content blocks.
                             4. Key "win conditions" to highlight on the board.
                             Do NOT generate an image, just a detailed text description.`;
                             payloadParts = [{ text: systemPrompt }];
                        } else if (activeTab === 'speech') {
                            systemPrompt = `
                                You are an expert Debate Adjudicator for ${speechType}. 
                                Topic: ${topic}. Side: ${side}.
                                
                                Evaluate the following speech based on this rubric:
                                ${rubric}

                                Please provide the output in the following Markdown format:
                                ## Executive Summary
                                (Brief overview of performance)

                                ## Scorecard
                                | Category | Score (0-10) | Notes |
                                | --- | --- | --- |
                                (Fill based on rubric)
                                | **Total** | **(Sum)** | |

                                ## Key Argument Analysis
                                (Bullet points on specific arguments made)

                                ## Constructive Feedback
                                - **Strengths**: ...
                                - **Areas for Improvement**: ...

                                ## Recommended Drills
                                (Specific exercises to improve weak areas)

                                SPEECH TEXT:
                                ${transcript}
                            `;
                            payloadParts = [{ text: systemPrompt }];
                        } else if (activeTab === 'board') {
                            systemPrompt = `Expert Debate Coach (Flowing). Evaluate board/flow. Context: ${speechType}, ${side}, Topic: ${topic}. Assess Organization, Grouping, Legibility, Suggestions. User Notes: ${boardDescription}`;
                            payloadParts = [{ text: systemPrompt }];
                            boardImages.forEach(img => payloadParts.push({ inlineData: { mimeType: img.mimeType, data: img.raw } }));
                        } else if (activeTab === 'listen') {
                            systemPrompt = `Expert Speech Coach. Listen to audio. Context: ${speechType}, ${side}, Topic: ${topic}. Evaluate: 1. Vocal Delivery (Pace, Tone, Fluency). 2. Content. 3. Score (0-100).`;
                            payloadParts = [{ text: systemPrompt }, { inlineData: { mimeType: audioData.mimeType, data: audioData.raw } }];
                        }

                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: payloadParts }] })
                        });

                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(`Gemini API Error: ${errorData.error?.message || response.statusText || response.status}`);
                        }
                        const data = await response.json();
                        generatedText = data.candidates?.[0]?.content?.parts?.[0]?.text;

                    } else if (provider === 'openai') {
                        let messages = [];
                        
                        if (isBoardGen) {
                            messages = [{
                                role: "system", content: "You are an expert Debate Coach."
                            }, {
                                role: "user", content: `For the topic "${topic}" and side "${side}" in ${speechType} format, describe an ideal debate board/flow layout. Include strategic grouping, colors, outline, and win conditions. Text description only.`
                            }];
                        } else if (activeTab === 'speech') {
                            messages = [{
                                role: "system", content: `You are an expert Debate Adjudicator for ${speechType}. Use the following rubric: ${rubric}`
                            }, {
                                role: "user", content: `
                                    Topic: ${topic}. Side: ${side}.
                                    Evaluate this speech.
                                    
                                    Output Format:
                                    ## Executive Summary
                                    ## Scorecard (Table)
                                    ## Key Argument Analysis
                                    ## Constructive Feedback
                                    ## Recommended Drills

                                    SPEECH: ${transcript}`
                            }];
                        } else if (activeTab === 'board') {
                            const content = [
                                { type: "text", text: `Expert Debate Coach. Evaluate this debate flow/board. Context: ${speechType}, ${side}, Topic: ${topic}. User Notes: ${boardDescription}` }
                            ];
                            boardImages.forEach(img => {
                                content.push({ type: "image_url", image_url: { url: img.url } });
                            });
                            messages = [{ role: "user", content }];
                        }

                        const response = await fetch('https://api.openai.com/v1/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${openaiKey}`
                            },
                            body: JSON.stringify({
                                model: "gpt-4o",
                                messages: messages,
                                max_tokens: 2000
                            })
                        });

                        if (!response.ok) {
                            const errData = await response.json();
                            throw new Error(`OpenAI Error: ${errData.error?.message || response.statusText}`);
                        }
                        const data = await response.json();
                        generatedText = data.choices[0].message.content;
                    }

                    if (generatedText) {
                        setResult(generatedText);
                        addToHistory(generatedText, isBoardGen ? 'Strategy Gen' : activeTab);
                    } else {
                        throw new Error('No analysis returned.');
                    }

                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            // Render UI
            return (
                <div className="flex h-screen bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100 font-sans selection:bg-indigo-100 dark:selection:bg-indigo-900 transition-colors duration-200 overflow-hidden">
                    {/* Sidebar */}
                    <Sidebar 
                        activeTab={activeTab} 
                        setActiveTab={setActiveTab} 
                        theme={theme} 
                        setTheme={setTheme} 
                        user={user} 
                        logout={logout} 
                        setShowLogin={setShowLogin}
                        isOpen={isSidebarOpen}
                        setIsOpen={setIsSidebarOpen}
                    />

                    {/* Main Content */}
                    <main className="flex-1 overflow-y-auto h-full relative">
                        {/* Top Bar */}
                        <header className="bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 sticky top-0 z-20 px-6 py-3 flex items-center justify-between">
                             <div className="flex items-center">
                                <button 
                                    onClick={() => setIsSidebarOpen(true)} 
                                    className="lg:hidden mr-4 p-2 -ml-2 text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
                                >
                                    <Menu className="w-6 h-6" />
                                </button>
                                <h2 className="text-lg font-semibold text-slate-800 dark:text-slate-200 capitalize">
                                    {activeTab === 'speech' ? 'Judge Text' : 
                                     activeTab === 'board' ? 'Evaluate Board' : 
                                     activeTab === 'listen' ? 'Live Coach' : 
                                     activeTab}
                                </h2>
                             </div>
                             <div className="flex items-center space-x-4">
                                <div className="flex items-center bg-slate-100 dark:bg-slate-700 rounded-full p-1">
                                    <button onClick={() => setTheme('light')} className={`p-1.5 rounded-full transition-all ${theme === 'light' ? 'bg-white shadow text-yellow-500' : 'text-slate-400 hover:text-slate-600'}`} title="Light"><Sun className="w-4 h-4" /></button>
                                    <button onClick={() => setTheme('dark')} className={`p-1.5 rounded-full transition-all ${theme === 'dark' ? 'bg-slate-600 shadow text-indigo-300' : 'text-slate-400 hover:text-slate-600'}`} title="Dark"><Moon className="w-4 h-4" /></button>
                                    <button onClick={() => setTheme('forest')} className={`p-1.5 rounded-full transition-all ${theme === 'forest' ? 'bg-[#1c2321] shadow text-green-300 border border-green-800' : 'text-slate-400 hover:text-slate-600'}`} title="Forest"><Leaf className="w-4 h-4" /></button>
                                    <button onClick={() => setTheme('coffee')} className={`p-1.5 rounded-full transition-all ${theme === 'coffee' ? 'bg-[#2b2118] shadow text-orange-300 border border-orange-800' : 'text-slate-400 hover:text-slate-600'}`} title="Coffee"><Coffee className="w-4 h-4" /></button>
                                    <button onClick={() => setTheme('ocean')} className={`p-1.5 rounded-full transition-all ${theme === 'ocean' ? 'bg-[#0f172a] shadow text-blue-300 border border-blue-800' : 'text-slate-400 hover:text-slate-600'}`} title="Ocean"><Droplets className="w-4 h-4" /></button>
                                    <button onClick={() => setTheme('midnight')} className={`p-1.5 rounded-full transition-all ${theme === 'midnight' ? 'bg-[#000000] shadow text-slate-300 border border-slate-700' : 'text-slate-400 hover:text-slate-600'}`} title="Midnight"><Star className="w-4 h-4" /></button>
                                </div>
                                {user ? (
                                    <div className="flex items-center">
                                        <div className="w-8 h-8 rounded-full bg-indigo-100 dark:bg-indigo-900/50 flex items-center justify-center text-indigo-600 dark:text-indigo-400 font-bold mr-2">
                                            {(user.username || user.email)[0].toUpperCase()}
                                        </div>
                                        <button onClick={logout} className="text-slate-400 hover:text-red-500 transition-colors"><LogOut className="w-4 h-4" /></button>
                                    </div>
                                ) : (
                                    <button onClick={() => setShowLogin(true)} className="text-sm font-medium text-indigo-600 hover:text-indigo-700">Sign In</button>
                                )}
                             </div>
                        </header>

                        <div className="p-6 max-w-7xl mx-auto">
                            {activeTab === 'dashboard' && (
                                <Dashboard 
                                    user={user} 
                                    history={history} 
                                    setActiveTab={setActiveTab} 
                                />
                            )}

                            {activeTab === 'settings' && (
                                <div className="max-w-2xl mx-auto">
                                    <div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                                        <div className="px-6 py-4 border-b border-slate-200 dark:border-slate-700">
                                            <h3 className="text-lg font-semibold">Configuration</h3>
                                            <p className="text-sm text-slate-500">Manage your API keys and preferences</p>
                                        </div>
                                        <div className="p-6 space-y-6">
                                            <div>
                                                <label className="block text-sm font-medium mb-2">AI Provider</label>
                                                <div className="flex space-x-4 mb-4">
                                                    <label className="flex items-center cursor-pointer p-3 border border-slate-200 dark:border-slate-700 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-900/50 transition-colors flex-1">
                                                        <input type="radio" name="provider" value="gemini" checked={provider === 'gemini'} onChange={() => setProvider('gemini')} className="mr-3" />
                                                        <span className="font-medium">Google Gemini</span>
                                                    </label>
                                                    <label className="flex items-center cursor-pointer p-3 border border-slate-200 dark:border-slate-700 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-900/50 transition-colors flex-1">
                                                        <input type="radio" name="provider" value="openai" checked={provider === 'openai'} onChange={() => setProvider('openai')} className="mr-3" />
                                                        <span className="font-medium">OpenAI (GPT-4o)</span>
                                                    </label>
                                                </div>
                                                
                                                {provider === 'gemini' ? (
                                                    <div>
                                                        <label className="block text-sm font-medium mb-2">
                                                            Gemini API Key
                                                            <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" className="text-xs text-indigo-600 hover:underline ml-2 font-normal">(Get Key)</a>
                                                        </label>
                                                        <div className="flex space-x-2">
                                                            <input type="password" placeholder="Paste your Gemini API key..." className="flex-1 px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 focus:ring-2 focus:ring-indigo-500 outline-none transition-all" value={apiKey} onChange={(e) => setApiKey(e.target.value)} />
                                                            <button 
                                                                onClick={() => verifyAndSaveKey('gemini', apiKey)}
                                                                disabled={verificationStatus.gemini === 'loading' || !apiKey}
                                                                className={`px-4 py-2 rounded-lg font-medium text-white transition-all ${
                                                                    verificationStatus.gemini === 'success' ? 'bg-green-600 hover:bg-green-700' :
                                                                    verificationStatus.gemini === 'error' ? 'bg-red-600 hover:bg-red-700' :
                                                                    'bg-indigo-600 hover:bg-indigo-700'
                                                                }`}
                                                            >
                                                                {verificationStatus.gemini === 'loading' ? <Loader2 className="w-5 h-5 animate-spin" /> : 
                                                                 verificationStatus.gemini === 'success' ? <CheckCircle2 className="w-5 h-5" /> : 
                                                                 verificationStatus.gemini === 'error' ? <AlertCircle className="w-5 h-5" /> : 
                                                                 'Verify & Save'}
                                                            </button>
                                                        </div>
                                                        {verificationStatus.gemini === 'success' && <p className="text-xs text-green-600 mt-1">Key verified and saved!</p>}
                                                        {verificationStatus.gemini === 'error' && <p className="text-xs text-red-600 mt-1">Invalid API Key. Please check and try again.</p>}
                                                    </div>
                                                ) : (
                                                    <div>
                                                        <label className="block text-sm font-medium mb-2">
                                                            OpenAI API Key
                                                            <a href="https://platform.openai.com/api-keys" target="_blank" rel="noopener noreferrer" className="text-xs text-indigo-600 hover:underline ml-2 font-normal">(Get Key)</a>
                                                        </label>
                                                        <div className="flex space-x-2">
                                                            <input type="password" placeholder="Paste your OpenAI API key..." className="flex-1 px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 focus:ring-2 focus:ring-indigo-500 outline-none transition-all" value={openaiKey} onChange={(e) => setOpenaiKey(e.target.value)} />
                                                            <button 
                                                                onClick={() => verifyAndSaveKey('openai', openaiKey)}
                                                                disabled={verificationStatus.openai === 'loading' || !openaiKey}
                                                                className={`px-4 py-2 rounded-lg font-medium text-white transition-all ${
                                                                    verificationStatus.openai === 'success' ? 'bg-green-600 hover:bg-green-700' :
                                                                    verificationStatus.openai === 'error' ? 'bg-red-600 hover:bg-red-700' :
                                                                    'bg-indigo-600 hover:bg-indigo-700'
                                                                }`}
                                                            >
                                                                {verificationStatus.openai === 'loading' ? <Loader2 className="w-5 h-5 animate-spin" /> : 
                                                                 verificationStatus.openai === 'success' ? <CheckCircle2 className="w-5 h-5" /> : 
                                                                 verificationStatus.openai === 'error' ? <AlertCircle className="w-5 h-5" /> : 
                                                                 'Verify & Save'}
                                                            </button>
                                                        </div>
                                                        {verificationStatus.openai === 'success' && <p className="text-xs text-green-600 mt-1">Key verified and saved!</p>}
                                                        {verificationStatus.openai === 'error' && <p className="text-xs text-red-600 mt-1">Invalid API Key. Please check and try again.</p>}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'history' && (
                                <div className="space-y-4">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="text-lg font-semibold">Analysis History</h3>
                                        {history.length > 0 && (
                                            <button onClick={clearHistory} className="text-red-500 hover:text-red-700 text-sm flex items-center px-3 py-1 rounded hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">
                                                <Trash2 className="w-4 h-4 mr-1" /> Clear All
                                            </button>
                                        )}
                                    </div>
                                    {history.length === 0 ? (
                                        <div className="text-center py-12 text-slate-500">No history yet. Start analyzing!</div>
                                    ) : (
                                        history.map((item) => (
                                            <div key={item.id} className="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-700 hover:shadow-md transition-shadow cursor-pointer" onClick={() => { setResult(item.result); setActiveTab('speech'); }}>
                                                <div className="flex justify-between items-start mb-2">
                                                    <span className="px-2 py-1 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 text-xs rounded-full font-medium uppercase">{item.type}</span>
                                                    <span className="text-xs text-slate-400">{new Date(item.timestamp).toLocaleString()}</span>
                                                </div>
                                                <p className="text-sm text-slate-600 dark:text-slate-300 line-clamp-2">{item.preview}</p>
                                            </div>
                                        ))
                                    )}
                                </div>
                            )}

                            {activeTab === 'coach' && (
                                <CoachTools speechTimes={speechTimes} rubrics={rubrics} />
                            )}

                            {['speech', 'board', 'listen'].includes(activeTab) && (
                                <div className="grid lg:grid-cols-3 gap-8 animate-in fade-in slide-in-from-bottom-4">
                                    {/* Context Panel */}
                                    <div className="lg:col-span-1 space-y-6">
                                        <div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6 sticky top-24">
                                            <div className="flex items-center mb-6 text-indigo-600 dark:text-indigo-400">
                                                <BookOpen className="w-5 h-5 mr-2" />
                                                <h2 className="font-bold text-lg">Debate Context</h2>
                                            </div>
                                            <div className="space-y-5">
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Format</label>
                                                    <div className="relative">
                                                        <select className="w-full appearance-none bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-slate-100 py-2.5 px-4 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition-all" value={speechType} onChange={(e) => setSpeechType(e.target.value)}>
                                                            {speechTypes.map(t => <option key={t} value={t}>{t}</option>)}
                                                        </select>
                                                        <ChevronDown className="absolute right-3 top-3.5 w-4 h-4 text-slate-400 pointer-events-none" />
                                                    </div>
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Role</label>
                                                    <div className="relative">
                                                        <select className="w-full appearance-none bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-slate-100 py-2.5 px-4 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition-all" value={side} onChange={(e) => setSide(e.target.value)}>
                                                            {sides.map(s => <option key={s} value={s}>{s}</option>)}
                                                        </select>
                                                        <ChevronDown className="absolute right-3 top-3.5 w-4 h-4 text-slate-400 pointer-events-none" />
                                                    </div>
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Topic</label>
                                                    <textarea rows="3" placeholder="Resolved: The United States Federal Government should..." className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-slate-100 py-2 px-3 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none resize-none text-sm" value={topic} onChange={(e) => setTopic(e.target.value)} />
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Main Tool Panel */}
                                    <div className="lg:col-span-2 space-y-6">
                                        <div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 flex flex-col min-h-[24rem]">
                                            <div className="px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between bg-slate-50/50 dark:bg-slate-900/50 rounded-t-xl">
                                                <div className="flex items-center text-slate-700 dark:text-slate-300 font-semibold">
                                                    {activeTab === 'speech' && <><Mic className="w-4 h-4 mr-2" /> Transcript Input</>}
                                                    {activeTab === 'board' && <><ImageIcon className="w-4 h-4 mr-2" /> Board Upload</>}
                                                    {activeTab === 'listen' && <><Activity className="w-4 h-4 mr-2" /> Live Audio</>}
                                                </div>
                                            </div>

                                            <div className="flex-1 p-6">
                                                {activeTab === 'speech' && (
                                                    <textarea className="w-full h-full min-h-[200px] bg-transparent resize-none outline-none font-mono text-sm leading-relaxed" placeholder="Paste speech text here..." value={transcript} onChange={(e) => setTranscript(e.target.value)} />
                                                )}

                                                {activeTab === 'board' && (
                                                    <div className="space-y-4 flex flex-col h-full">
                                                        {boardImages.length === 0 ? (
                                                            <div className="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg p-8 text-center hover:bg-slate-50 dark:hover:bg-slate-900/50 cursor-pointer transition-colors" onClick={() => fileInputRef.current?.click()}>
                                                                <Upload className="w-10 h-10 text-slate-400 mb-3 mx-auto" />
                                                                <p className="text-sm text-slate-500">Click to upload Board Images</p>
                                                            </div>
                                                        ) : (
                                                            <div className="grid grid-cols-2 sm:grid-cols-3 gap-4">
                                                                {boardImages.map((img, idx) => (
                                                                    <div key={img.id} className="relative border border-slate-200 dark:border-slate-700 rounded-lg p-1 group">
                                                                        <div className="absolute top-0 left-0 px-2 py-1 text-xs font-semibold bg-slate-100 dark:bg-slate-900 rounded-br-lg z-10">Board {idx + 1}</div>
                                                                        <img src={img.url} alt="" className="w-full h-24 object-cover rounded" />
                                                                        <button onClick={() => removeImage(img.id)} className="absolute -top-2 -right-2 bg-red-500 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity"><X className="w-3 h-3" /></button>
                                                                    </div>
                                                                ))}
                                                                <div onClick={() => fileInputRef.current?.click()} className="flex flex-col items-center justify-center h-26 border-2 border-dashed border-slate-300 rounded-lg cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-900/50 transition-colors">
                                                                    <Plus className="w-6 h-6 text-slate-400" />
                                                                </div>
                                                            </div>
                                                        )}
                                                        <input type="file" multiple ref={fileInputRef} className="hidden" accept="image/*" onChange={handleImageUpload} />
                                                        <textarea className="w-full h-32 p-3 rounded-lg border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 resize-none outline-none text-sm focus:ring-2 focus:ring-indigo-500 transition-all" placeholder="Describe board strategy..." value={boardDescription} onChange={(e) => setBoardDescription(e.target.value)} />
                                                        <div className="flex justify-end">
                                                            <button onClick={() => handleAnalyze(true)} className="text-xs flex items-center text-indigo-600 dark:text-indigo-400 hover:underline">
                                                                <Lightbulb className="w-3 h-3 mr-1" /> Need ideas? Generate a board strategy
                                                            </button>
                                                        </div>
                                                    </div>
                                                )}

                                                {activeTab === 'listen' && (
                                                    <div className="h-full flex flex-col items-center justify-center space-y-8 py-4">
                                                        <div className="w-full max-w-md bg-slate-100 dark:bg-slate-900 rounded-xl p-5 border border-slate-200 dark:border-slate-700 shadow-inner">
                                                            <div className="flex space-x-2 mb-6 overflow-x-auto pb-2 scrollbar-hide">
                                                                {(speechTimes[speechType] || speechTimes['default']).map((s, idx) => (
                                                                    <button 
                                                                        key={s.name}
                                                                        onClick={() => {
                                                                            setSelectedSection(s);
                                                                            setRecordingTime(0);
                                                                            setIsRecording(false);
                                                                            setAudioData(null);
                                                                        }}
                                                                        className={`flex-shrink-0 px-3 py-1.5 rounded-lg text-xs font-medium transition-all whitespace-nowrap ${
                                                                            selectedSection?.name === s.name 
                                                                                ? 'bg-indigo-600 text-white shadow-md ring-2 ring-indigo-200 dark:ring-indigo-900' 
                                                                                : 'bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-400 border border-slate-200 dark:border-slate-700 hover:border-indigo-300'
                                                                        }`}
                                                                    >
                                                                        {s.name}
                                                                        <span className="ml-1.5 opacity-70 text-[10px]">{formatTime(s.time)}</span>
                                                                    </button>
                                                                ))}
                                                            </div>

                                                            <div className="flex justify-between items-end mb-3">
                                                                <div className="flex flex-col">
                                                                    <span className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Current Section</span>
                                                                    <span className="text-xl font-bold text-indigo-600 dark:text-indigo-400">{selectedSection?.name}</span>
                                                                </div>
                                                                <div className="text-right">
                                                                    <span className={`text-3xl font-mono font-bold ${recordingTime > (selectedSection?.time || 0) ? 'text-red-500' : 'text-slate-700 dark:text-slate-200'}`}>
                                                                        {formatTime(recordingTime)}
                                                                    </span>
                                                                    <span className="text-xs text-slate-400 block mt-1">Target: {formatTime(selectedSection?.time || 0)}</span>
                                                                </div>
                                                            </div>
                                                            
                                                            <div className="relative h-4 bg-slate-200 dark:bg-slate-800 rounded-full overflow-hidden shadow-inner">
                                                                <div 
                                                                    className={`absolute top-0 left-0 h-full transition-all duration-1000 ease-linear ${
                                                                        recordingTime > (selectedSection?.time || 0) 
                                                                            ? 'bg-red-500' 
                                                                            : recordingTime > ((selectedSection?.time || 0) * 0.8) 
                                                                                ? 'bg-amber-500' 
                                                                                : 'bg-indigo-500'
                                                                    }`}
                                                                    style={{ width: `${Math.min((recordingTime / (selectedSection?.time || 1)) * 100, 100)}%` }}
                                                                ></div>
                                                            </div>
                                                        </div>

                                                        <div className="flex flex-col items-center space-y-6 w-full">
                                                            <div className="h-32 flex items-center justify-center w-full bg-slate-50 dark:bg-slate-900/50 rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden relative">
                                                                {isRecording ? (
                                                                    <AudioVisualizer analyser={analyser} isRecording={isRecording} />
                                                                ) : (
                                                                    <div className="text-center z-10">
                                                                        <p className="text-sm text-slate-500 font-medium">{audioData ? 'Recording saved. Ready for analysis.' : 'Press microphone to start recording'}</p>
                                                                    </div>
                                                                )}
                                                            </div>

                                                            <div className="flex items-center justify-center space-x-8">
                                                                <div className="relative group">
                                                                    {isRecording && <div className="absolute inset-0 bg-red-500 rounded-full animate-ping opacity-20"></div>}
                                                                    {!isRecording ? (
                                                                        <button onClick={startRecording} className="relative z-10 w-16 h-16 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full flex items-center justify-center shadow-lg shadow-indigo-500/30 transform hover:scale-105 transition-all">
                                                                            <Mic className="w-7 h-7" />
                                                                        </button>
                                                                    ) : (
                                                                        <button onClick={stopRecording} className="relative z-10 w-16 h-16 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center shadow-lg shadow-red-500/30 transform hover:scale-105 transition-all">
                                                                            <Square className="w-7 h-7 fill-current" />
                                                                        </button>
                                                                    )}
                                                                </div>
                                                            </div>
                                                            
                                                            <div className="w-full max-w-md">
                                                                <ToneIndicator analyser={analyser} isRecording={isRecording} />
                                                            </div>
                                                        </div>

                                                        {audioData && !isRecording && (
                                                            <div className="flex items-center space-x-4 animate-in fade-in slide-in-from-bottom-4">
                                                                <div className="flex items-center px-4 py-2 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-300 rounded-full border border-green-200 dark:border-green-800 text-sm font-medium">
                                                                    <CheckCircle2 className="w-4 h-4 mr-2" /> Audio Captured
                                                                </div>
                                                                <button onClick={resetAudio} className="text-sm text-slate-500 hover:text-slate-700 underline">Discard & Retry</button>
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                            </div>

                                            <div className="p-4 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50 rounded-b-xl flex justify-end">
                                                <button onClick={() => handleAnalyze(false)} disabled={loading} className={`flex items-center px-6 py-2.5 rounded-lg font-medium text-white shadow-md transition-all ${loading ? 'bg-slate-400 cursor-not-allowed' : 'bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 shadow-indigo-500/25'}`}>
                                                    {loading ? <><Loader2 className="w-4 h-4 mr-2 animate-spin" /> Analyzing...</> : <><Send className="w-4 h-4 mr-2" /> Analyze</>}
                                                </button>
                                            </div>
                                        </div>

                                        {error && (
                                            <div className="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-300 p-4 rounded-lg flex items-center animate-in fade-in">
                                                <AlertCircle className="w-5 h-5 mr-3 flex-shrink-0" /> {error}
                                            </div>
                                        )}

                                        {result && (
                                            <div className="bg-white dark:bg-slate-800 rounded-xl shadow-lg border border-indigo-100 dark:border-slate-700 overflow-hidden animate-in fade-in slide-in-from-bottom-4">
                                                <div className="bg-gradient-to-r from-indigo-600 to-purple-600 px-6 py-4 flex items-center text-white justify-between">
                                                    <div className="flex items-center">
                                                        <CheckCircle2 className="w-6 h-6 mr-3" />
                                                        <h2 className="font-bold text-lg">Analysis Result</h2>
                                                    </div>
                                                    <button onClick={() => setResult(null)} className="text-white/80 hover:text-white"><X className="w-5 h-5" /></button>
                                                </div>
                                                <div className="p-8 bg-slate-50/50 dark:bg-slate-800">
                                                    <MarkdownRenderer content={result} />
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>

                    {/* Login Modal */}
                    {showLogin && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm animate-in fade-in">
                            <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl max-w-md w-full overflow-hidden border border-slate-200 dark:border-slate-700 relative">
                                <button onClick={() => setShowLogin(false)} className="absolute top-4 right-4 p-2 bg-slate-100 dark:bg-slate-700 rounded-full text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 transition-colors z-10" aria-label="Close">
                                    <X className="w-5 h-5" />
                                </button>
                                <div className="p-8">
                                    <div className="flex justify-center mb-6">
                                        <div className="bg-indigo-600 p-3 rounded-xl shadow-lg shadow-indigo-500/30">
                                            <Gavel className="w-8 h-8 text-white" />
                                        </div>
                                    </div>
                                    <h2 className="text-2xl font-bold text-center text-slate-900 dark:text-white mb-2">
                                        {authMode === 'login' ? 'Welcome Back' : 'Create Account'}
                                    </h2>
                                    
                                    <div className="mb-6 text-center">
                                        <p className="text-xs text-amber-600 dark:text-amber-400 bg-amber-50 dark:bg-amber-900/20 p-2 rounded border border-amber-100 dark:border-amber-800/30">
                                            <AlertCircle className="w-3 h-3 inline mr-1 mb-0.5" />
                                            Note: You can skip login, but history won't be saved to the cloud.
                                        </p>
                                    </div>

                                    <form onSubmit={handleAuth} className="space-y-4">
                                        {authMode === 'signup' && (
                                            <div>
                                                <label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Username</label>
                                                <div className="relative">
                                                    <User className="absolute left-3 top-2.5 w-4 h-4 text-slate-400" />
                                                    <input 
                                                        type="text" 
                                                        required
                                                        className="w-full pl-10 pr-4 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 focus:ring-2 focus:ring-indigo-500 outline-none transition-all" 
                                                        placeholder="Username"
                                                        value={authUsername}
                                                        onChange={(e) => setAuthUsername(e.target.value)}
                                                    />
                                                </div>
                                            </div>
                                        )}
                                        <div>
                                            <label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Email</label>
                                            <div className="relative">
                                                <User className="absolute left-3 top-2.5 w-4 h-4 text-slate-400" />
                                                <input 
                                                    type="email" 
                                                    required
                                                    className="w-full pl-10 pr-4 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 focus:ring-2 focus:ring-indigo-500 outline-none transition-all" 
                                                    placeholder="name@example.com"
                                                    value={authEmail}
                                                    onChange={(e) => setAuthEmail(e.target.value)}
                                                />
                                            </div>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Password</label>
                                            <div className="relative">
                                                <Lock className="absolute left-3 top-2.5 w-4 h-4 text-slate-400" />
                                                <input 
                                                    type="password" 
                                                    required
                                                    className="w-full pl-10 pr-4 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 focus:ring-2 focus:ring-indigo-500 outline-none transition-all" 
                                                    placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                                                    value={authPassword}
                                                    onChange={(e) => setAuthPassword(e.target.value)}
                                                />
                                            </div>
                                        </div>

                                        {authError && (
                                            <div className="text-red-500 text-xs text-center bg-red-50 dark:bg-red-900/20 p-2 rounded">
                                                {authError}
                                            </div>
                                        )}

                                        <button type="submit" className="w-full py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium transition-colors shadow-lg shadow-indigo-500/30">
                                            {authMode === 'login' ? 'Sign In' : 'Create Account'}
                                        </button>
                                    </form>

                                    <div className="my-4 flex items-center">
                                        <div className="flex-grow border-t border-slate-200 dark:border-slate-700"></div>
                                        <span className="mx-4 text-xs text-slate-400 uppercase">Or</span>
                                        <div className="flex-grow border-t border-slate-200 dark:border-slate-700"></div>
                                    </div>

                                    <button onClick={handleGoogleLogin} className="w-full py-2.5 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-200 rounded-lg font-medium transition-colors hover:bg-slate-50 dark:hover:bg-slate-600 flex items-center justify-center">
                                        <svg className="w-5 h-5 mr-2" viewBox="0 0 24 24">
                                            <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4" />
                                            <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853" />
                                            <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05" />
                                            <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335" />
                                        </svg>
                                        Sign in with Google
                                    </button>

                                    <div className="mt-6 text-center text-sm text-slate-500">
                                        {authMode === 'login' ? (
                                            <>Don't have an account? <button onClick={() => setAuthMode('signup')} className="text-indigo-600 hover:underline font-medium">Sign up</button></>
                                        ) : (
                                            <>Already have an account? <button onClick={() => setAuthMode('login')} className="text-indigo-600 hover:underline font-medium">Sign in</button></>
                                        )}
                                    </div>
                                    
                                    <div className="mt-6 pt-6 border-t border-slate-100 dark:border-slate-700 text-center">
                                        <p className="text-xs text-slate-400">
                                            {isFirebaseReady ? 'Secure Cloud Authentication' : 'Demo Mode: Data stored locally'}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Username Setup Modal */}
                    {showUsernameSetup && (
                        <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-slate-900/90 backdrop-blur-sm animate-in fade-in">
                            <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl max-w-md w-full overflow-hidden border border-slate-200 dark:border-slate-700 relative">
                                <div className="p-8">
                                    <div className="flex justify-center mb-6">
                                        <div className="bg-indigo-600 p-3 rounded-xl shadow-lg shadow-indigo-500/30">
                                            <User className="w-8 h-8 text-white" />
                                        </div>
                                    </div>
                                    <h2 className="text-2xl font-bold text-center text-slate-900 dark:text-white mb-2">
                                        Choose a Username
                                    </h2>
                                    <p className="text-center text-slate-500 dark:text-slate-400 mb-6 text-sm">
                                        Please set a unique username to continue using Adjudicator AI.
                                    </p>

                                    <form onSubmit={handleUsernameSetup} className="space-y-4">
                                        <div>
                                            <label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Username</label>
                                            <div className="relative">
                                                <User className="absolute left-3 top-2.5 w-4 h-4 text-slate-400" />
                                                <input 
                                                    type="text" 
                                                    required
                                                    className="w-full pl-10 pr-4 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 focus:ring-2 focus:ring-indigo-500 outline-none transition-all" 
                                                    placeholder="Username"
                                                    value={authUsername}
                                                    onChange={(e) => setAuthUsername(e.target.value)}
                                                />
                                            </div>
                                        </div>

                                        {authError && (
                                            <div className="text-red-500 text-xs text-center bg-red-50 dark:bg-red-900/20 p-2 rounded">
                                                {authError}
                                            </div>
                                        )}

                                        <button type="submit" className="w-full py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium transition-colors shadow-lg shadow-indigo-500/30">
                                            Save Username
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* History Modal */}
                    {showHistory && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-in fade-in">
                            <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl max-w-2xl w-full overflow-hidden border border-slate-200 dark:border-slate-700 flex flex-col max-h-[90vh]">
                                <div className="p-6 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                                    <h3 className="text-xl font-bold text-slate-900 dark:text-white flex items-center">
                                        <History className="w-5 h-5 mr-2" /> History
                                    </h3>
                                    <div className="flex items-center space-x-2">
                                        {history.length > 0 && (
                                            <button onClick={clearHistory} className="text-red-500 hover:text-red-700 text-sm flex items-center px-3 py-1 rounded hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">
                                                <Trash2 className="w-4 h-4 mr-1" /> Clear
                                            </button>
                                        )}
                                        <button onClick={() => setShowHistory(false)} className="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                                            <X className="w-6 h-6" />
                                        </button>
                                    </div>
                                </div>
                                <div className="flex-1 overflow-y-auto p-6 space-y-4">
                                    {history.length === 0 ? (
                                        <div className="text-center text-slate-500 py-10">
                                            <History className="w-12 h-12 mx-auto mb-3 opacity-20" />
                                            <p>No history yet. Analyze something to see it here!</p>
                                        </div>
                                    ) : (
                                        history.map(item => (
                                            <div key={item.id} className="bg-slate-50 dark:bg-slate-900/50 rounded-lg p-4 border border-slate-200 dark:border-slate-700 hover:border-indigo-300 dark:hover:border-indigo-700 transition-colors">
                                                <div className="flex justify-between items-start mb-2">
                                                    <div>
                                                        <span className="text-xs font-bold uppercase tracking-wider text-indigo-600 dark:text-indigo-400 bg-indigo-50 dark:bg-indigo-900/30 px-2 py-0.5 rounded">{item.type}</span>
                                                        <h4 className="font-semibold text-slate-800 dark:text-slate-200 mt-1">{item.topic}</h4>
                                                        <span className="text-xs text-slate-400">{item.date}</span>
                                                    </div>
                                                    <div className="flex space-x-1">
                                                        <button onClick={() => { setResult(item.content); setShowHistory(false); }} className="p-1.5 text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 rounded transition-colors" title="View">
                                                            <Layout className="w-4 h-4" />
                                                        </button>
                                                        <button onClick={() => navigator.clipboard.writeText(item.content)} className="p-1.5 text-slate-500 hover:text-green-600 hover:bg-green-50 dark:hover:bg-green-900/30 rounded transition-colors" title="Copy">
                                                            <Copy className="w-4 h-4" />
                                                        </button>
                                                    </div>
                                                </div>
                                                <div className="text-xs text-slate-500 dark:text-slate-400 line-clamp-2">
                                                    {item.content.substring(0, 150)}...
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Help Modal */}
                    {showHelp && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-in fade-in">
                            <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden border border-slate-200 dark:border-slate-700 flex flex-col max-h-[90vh]">
                                <div className="p-6 overflow-y-auto">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="text-xl font-bold text-slate-900 dark:text-white">Welcome to Adjudicator AI</h3>
                                        <button onClick={() => setShowHelp(false)} className="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                                            <X className="w-6 h-6" />
                                        </button>
                                    </div>
                                    <div className="space-y-4 text-slate-600 dark:text-slate-300 text-sm">
                                        <p>Your personal AI debate coach and adjudicator. Here's how to use it:</p>
                                        <ul className="space-y-3">
                                            <li className="flex items-start">
                                                <div className="bg-indigo-100 dark:bg-indigo-900/30 p-2 rounded-lg mr-3 mt-0.5 flex-shrink-0">
                                                    <Mic className="w-4 h-4 text-indigo-600 dark:text-indigo-400" />
                                                </div>
                                                <div>
                                                    <strong className="block text-slate-800 dark:text-slate-200">Judge Text</strong>
                                                    Paste your speech transcript to get a score and detailed feedback.
                                                </div>
                                            </li>
                                            <li className="flex items-start">
                                                <div className="bg-purple-100 dark:bg-purple-900/30 p-2 rounded-lg mr-3 mt-0.5 flex-shrink-0">
                                                    <Layout className="w-4 h-4 text-purple-600 dark:text-purple-400" />
                                                </div>
                                                <div>
                                                    <strong className="block text-slate-800 dark:text-slate-200">Evaluate Board</strong>
                                                    Upload photos of your flow/board for strategy and organization tips.
                                                </div>
                                            </li>
                                            <li className="flex items-start">
                                                <div className="bg-pink-100 dark:bg-pink-900/30 p-2 rounded-lg mr-3 mt-0.5 flex-shrink-0">
                                                    <Activity className="w-4 h-4 text-pink-600 dark:text-pink-400" />
                                                </div>
                                                <div>
                                                    <strong className="block text-slate-800 dark:text-slate-200">Live Coach</strong>
                                                    Record your speech audio for delivery and content analysis.
                                                </div>
                                            </li>
                                        </ul>
                                        <div className="mt-4 p-3 bg-slate-100 dark:bg-slate-900 rounded-lg text-xs text-slate-500">
                                            <strong>Note:</strong> You'll need a Gemini API key to start. Enter it in the Configuration section.
                                        </div>
                                    </div>
                                </div>
                                <div className="p-4 bg-slate-50 dark:bg-slate-900/50 border-t border-slate-200 dark:border-slate-700 flex justify-end flex-shrink-0">
                                    <button onClick={() => setShowHelp(false)} className="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium transition-colors w-full sm:w-auto">
                                        Get Started
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>